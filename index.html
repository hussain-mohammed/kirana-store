<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kirana Store Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            corePlugins: {
                preflight: false,
            }
        }
    </script>
    <style>
        body {
            font-family: "Inter", sans-serif;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        /* Beautiful gradient backgrounds */
        .gradient-bg {
            background: linear-gradient(rgba(132, 206, 248, 0.85), rgba(172, 124, 20, 0.438));
            background-size: cover;
            background-position: center;
            min-height: 100vh;
        }
        .sales-bg {
            background: linear-gradient(rgba(230, 93, 184, 0.925), rgba(233, 30, 165, 0.959));
            min-height: 100vh;
        }
        .purchase-bg {
            background: linear-gradient(rgba(59, 130, 246, 0.85), rgba(147, 51, 234, 0.438));
            min-height: 100vh;
        }          
        .create-bg {
            background: linear-gradient(rgba(16, 185, 129, 0.85), rgba(245, 158, 11, 0.438));
            min-height: 100vh;
        }            
        .delete-bg {
            background: linear-gradient(rgba(239, 68, 68, 0.85), rgba(107, 114, 128, 0.438));
            min-height: 100vh;
        }
        .stock-bg {
            background: linear-gradient(rgba(75, 85, 99, 0.85), rgba(55, 65, 81, 0.438));
            min-height: 100vh;
        }           
        .sales-ledger-bg {
            background: linear-gradient(rgba(240, 243, 76, 0.85), rgba(179, 209, 8, 0.438));
            min-height: 100vh;
        }            
        .purchase-ledger-bg {
            background: linear-gradient(rgba(59, 130, 246, 0.85), rgba(147, 51, 234, 0.438));
            min-height: 100vh;
        }            
        .glass-effect {
            background: rgba(236, 49, 49, 0.842);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(64, 202, 226, 0.918);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        /* Disable hover effects on touch devices */
        @media (hover: hover) {
            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px rgba(221, 4, 4, 0.1);
            }
        }

        /* Mobile specific adjustments */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            .page {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            .glass-effect {
                padding: 0.75rem;
                backdrop-filter: blur(5px);
            }
            .button-container {
                display: grid;
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            #cart-modal {
                margin: 1rem;
                max-height: 80vh;
            }
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            .table-container {
                overflow-x: auto;
                margin: -0.5rem -0.75rem 0 -0.75rem;
                padding: 0 0.75rem;
            }
            header .flex.items-center {
                flex-direction: column;
                gap: 0.5rem;
            }
            header .logo-container {
                max-width: 250px;
            }
            .card-hover {
                padding: 4px 8px !important;
            }
            .filter-section {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            .notification {
                top: 1rem;
                right: 1rem;
                left: 1rem;
                max-width: none;
                width: auto;
            }
        }

        /* Extra small mobile devices */
        @media (max-width: 480px) {
            .page {
                padding-left: 0.25rem;
                padding-right: 0.25rem;
            }
            .glass-effect {
                padding: 0.5rem;
                margin: 0.25rem;
            }
            .summary-cards {
                grid-template-columns: 1fr;
            }
            #cart-modal .bg-white {
                margin: 0.5rem;
            }
            h1 {
                font-size: 1.25rem;
            }
            h2 {
                font-size: 1.125rem;
            }
            .text-lg {
                font-size: 0.9375rem;
            }
            .text-sm {
                font-size: 0.8125rem;
            }
        }
    </style>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõí</text></svg>">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="w-full bg-green-500 shadow-sm p-1 sticky top-0 z-10">
        <div class="max-w-2xl mx-auto flex justify-between items-center">
            <div class="flex items-center">
                <div class="logo-container top-0">
                    <div class="text-center bg-blue-500 glass-effect rounded-2xl p-1 text-white">
                        <h1 class="text-xl font-bold mb-1">Raza Wholesale and Retail</h1>
                        <p class="text-blue-100 mb-0">Kirana Store</p>
                        <p class="text-blue-100 text-sm mb-0">Tolichowki, Hyderabad</p>
                        <p class="text-blue-100 text-sm mb-0">Contact: +91 7075210801</p>
                        <p class="text-blue-100 text-sm mb-0">Order on WhatsApp - We deliver to your doorstep</p>
                    </div>
                </div>
            </div>

            <!-- User Info and Controls -->
            <div id="user-controls" class="flex items-center gap-2 hidden">
                <div id="welcome-message" class="bg-blue-500 glass-effect rounded-xl px-3 py-1 text-white text-sm"></div>
                <button id="logout-btn" class="px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm">
                    Logout
                </button>
                <button id="back-to-home" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm hidden">
                    ‚Üê Home
                </button>
            </div>
        </div>
    </header>

    <!-- ===== LOADING PAGE ===== -->
    <div id="page-loading" class="page active flex items-center justify-center min-h-screen">
        <div class="glass-effect rounded-xl p-8 text-white text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
            <h2 class="text-xl font-semibold">Loading Kirana Store...</h2>
            <p class="text-blue-100">Verifying authentication...</p>
        </div>
    </div>

    <!-- ===== LANDING PAGE ===== -->
    <div id="page-home" class="page gradient-bg">
        <main class="w-full max-w-6xl mx-auto p-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="showContentPage('sales')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üõçÔ∏è Sales</div>
                        <p class="text-blue-100">Sell products to customers and process orders</p>
                    </div>
                </button>
                
                <button onclick="showContentPage('purchase')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üì¶ Purchase</div>
                        <p class="text-green-100">Record product purchases from suppliers</p>
                    </div>
                </button>
                
                <button onclick="showContentPage('create')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">‚ûï Create Product</div>
                        <p class="text-purple-100">Add new products to your store inventory</p>
                    </div>
                </button>

                <button onclick="showContentPage('delete-product')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üóëÔ∏è Delete Product</div>
                        <p class="text-red-100">Remove products from your store inventory</p>
                    </div>
                </button>

                <button onclick="showContentPage('all-products-ledger')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üìã All Products Stock</div>
                        <p class="text-teal-100">View complete stock details with filters</p>
                    </div>
                </button>

                <button onclick="showContentPage('sales-ledger')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üìã Sales Ledger</div>
                        <p class="text-red-100">View and manage all sales records</p>
                    </div>
                </button>

                <button onclick="showContentPage('purchase-ledger')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üìã Purchase Ledger</div>
                        <p class="text-indigo-100">View and manage all purchase records</p>
                    </div>
                </button>

                <button onclick="showContentPage('profit-loss')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üí∞ Profit & Loss</div>
                        <p class="text-emerald-100">View shop profit and loss analysis with date filters</p>
                    </div>
                </button>

                <button onclick="showContentPage('opening-stock')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üìä Opening Stock</div>
                        <p class="text-yellow-100">View opening stock register with all created products</p>
                    </div>
                </button>

                <button onclick="showContentPage('settings')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">‚öôÔ∏è Settings</div>
                        <p class="text-purple-100">Manage users and their permissions</p>
                    </div>
                </button>
            </div>
        </main>
    </div>

    <!-- ===== CONTENT PAGES ===== -->

    <!-- Sales Content Page -->
    <div id="page-sales" class="page sales-bg">
        <main class="max-w-md p-4 space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Products</h2>
            <div id="product-list" class="grid grid-cols-2 gap-4">
                <div class="text-center py-8">
                    <p class="text-gray-500">Loading products...</p>
                </div>
            </div>
        </main>

        <!-- Cart Modal -->
        <div id="cart-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-20">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Your Cart</h3>
                    <button id="close-modal-button" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <div id="cart-items" class="space-y-3">
                    <!-- Cart items will be generated here by JavaScript -->
                </div>
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <div class="flex justify-between font-bold text-lg text-gray-800">
                        <span>Total:</span>
                        <span id="cart-total">‚Çπ0.00</span>
                    </div>
                    <button id="whatsapp-checkout-button" class="w-full mt-4 bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-green-600 transition-colors duration-300">
                        Checkout on WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchase Content Page -->
    <div id="page-purchase" class="page purchase-bg">
        <main class="w-full max-w-md mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Purchase Products</h2>
            
            <!-- Purchase Form -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Record New Purchase</h3>
                <form id="purchase-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Product</label>
                        <select id="purchase-product" class="w-full p-2 border border-gray-300 rounded-lg" required>
                            <option value="">Select Product</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                        <input type="number" id="purchase-quantity" class="w-full p-2 border border-gray-300 rounded-lg" min="1" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Unit Cost (‚Çπ) - Auto-filled</label>
                        <input type="number" id="purchase-unit-cost" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100" step="0.01" min="0.01" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Unit Type</label>
                        <input type="text" id="purchase-unit-type" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                    <button type="submit" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                        Record Purchase
                    </button>
                </form>
            </div>

            <!-- Recent Purchases -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Recent Purchases</h3>
                <div id="purchase-history" class="space-y-3">
                    <!-- Purchase history will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Create Product Content Page -->
    <div id="page-create" class="page create-bg">
        <main class="w-full max-w-md mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Create New Product</h2>
            
            <!-- Product Creation Form -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <form id="create-product-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                        <input type="text" id="product-name" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Purchase Price (‚Çπ)</label>
                        <input type="number" id="product-purchase-price" class="w-full p-2 border border-gray-300 rounded-lg" step="0.01" min="0.01" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Selling Price (‚Çπ)</label>
                        <input type="number" id="product-selling-price" class="w-full p-2 border border-gray-300 rounded-lg" step="0.01" min="0.01" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Unit Type</label>
                        <select id="product-unit-type" class="w-full p-2 border border-gray-300 rounded-lg" required>
                            <option value="">Select Unit Type</option>
                            <option value="kgs">Kilograms (kgs)</option>
                            <option value="ltr">Liters (ltr)</option>
                            <option value="pcs">Pieces (pcs)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Initial Stock</label>
                        <input type="number" id="product-stock" class="w-full p-2 border border-gray-300 rounded-lg" min="0" value="0">
                    </div>
                    <button type="submit" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        Create Product
                    </button>
                </form>
            </div>

            <!-- Existing Products -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Existing Products</h3>
                <div id="existing-products" class="space-y-3">
                    <!-- Existing products will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Delete Product Content Page -->
    <div id="page-delete-product" class="page delete-bg">
        <main class="w-full max-w-4xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Delete Product</h2>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">All Products</h3>
                    <button onclick="loadDeleteProductPage()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                        Refresh Products
                    </button>
                </div>
                
                <!-- Warning Message -->
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">Warning</h3>
                            <div class="mt-2 text-sm text-red-700">
                                <p>Deleting a product will permanently remove it from your inventory. This action cannot be undone and will affect all related sales and purchase records.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="delete-product-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading products...</p>
                </div>

                <!-- Error State -->
                <div id="delete-product-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading products</p>
                </div>

                <!-- Products List for Deletion -->
                <div id="delete-product-content" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product ID</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product Name</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Price (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Current Stock</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Last Updated</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="delete-product-table-body">
                                <!-- Products will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- All Products Stock Ledger Page with Filters -->
    <div id="page-all-products-ledger" class="page stock-bg">
        <main class="w-full max-w-6xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">All Products Stock</h2>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">Complete Stock Overview</h3>
                    <div class="flex gap-2">
                        <button onclick="downloadData('stock')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            üì• Download Stock Data
                        </button>
                        <button onclick="loadAllProductsLedger()" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors">
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                        <input type="date" id="stock-date-from" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                        <input type="date" id="stock-date-to" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Select date to see stock as of that date">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Product</label>
                        <select id="stock-product-filter" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">All Products</option>
                        </select>
                    </div>
                </div>
                <div class="text-sm text-gray-600 mb-4 p-3 bg-blue-50 rounded-lg">
                    <strong>How it works:</strong>
                    <ul class="mt-1 list-disc list-inside">
                        <li>Leave dates empty to see current stock levels in your shop</li>
                        <li>Use "Date To" to see what stock you had as of that date (historical view)</li>
                        <li>All prices shown are purchase prices for inventory valuation</li>
                    </ul>
                </div>
                <div class="flex justify-end mb-4">
                    <button onclick="applyStockFilters()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        Apply Filters
                    </button>
                    <button onclick="clearStockFiltersAndReload()" class="ml-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Clear
                    </button>
                </div>
                
                <!-- Loading State -->
                <div id="all-products-ledger-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading all products stock data...</p>
                </div>

                <!-- Error State -->
                <div id="all-products-ledger-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading products stock data</p>
                </div>

                <!-- All Products Stock Content -->
                <div id="all-products-ledger-content" class="hidden">
                    <!-- Summary Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600" id="total-products">0</div>
                            <div class="text-sm text-gray-600">Total Products</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600" id="total-stock">0</div>
                            <div class="text-sm text-gray-600">Total Stock</div>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-orange-600" id="low-stock-count">0</div>
                            <div class="text-sm text-gray-600">Low Stock Items</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600" id="out-of-stock-count">0</div>
                            <div class="text-sm text-gray-600">Out of Stock</div>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-indigo-600" id="total-stock-value">‚Çπ0.00</div>
                            <div class="text-sm text-gray-600">Total Stock Value</div>
                        </div>
                    </div>

                    <!-- Products Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product Name</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Current Stock</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Price (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Stock Value (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Last Updated</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Status</th>
                                </tr>
                            </thead>
                            <tbody id="all-products-ledger-table-body">
                                <!-- Products will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Sales Ledger Page -->
    <div id="page-sales-ledger" class="page sales-ledger-bg">
        <main class="w-full max-w-6xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Sales Ledger</h2>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">All Sales Records</h3>
                    <div class="flex gap-2">
                        <button onclick="downloadData('sales')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            üì• Download Sales Data
                        </button>
                        <button onclick="loadSalesLedger()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                        <input type="date" id="sales-date-from" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                        <input type="date" id="sales-date-to" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product</label>
                        <select id="sales-product-filter" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">All Products</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end mb-4">
                    <button onclick="applySalesFilters()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        Apply Filters
                    </button>
                    <button onclick="clearSalesFilters()" class="ml-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Clear
                    </button>
                </div>
                
                <!-- Loading State -->
                <div id="sales-ledger-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading sales records...</p>
                </div>

                <!-- Error State -->
                <div id="sales-ledger-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading sales records</p>
                </div>

                <!-- Sales Records Table -->
                <div id="sales-ledger-content" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Date & Time</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">ID</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Units</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Price (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Total Amount (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sales-ledger-table-body">
                                <!-- Sales records will be populated here -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-50 font-bold">
                                    <td colspan="5" class="border border-gray-200 px-4 py-2 text-right">Total:</td>
                                    <td class="border border-gray-200 px-4 py-2 text-green-600" id="sales-total-amount">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Purchase Ledger Page -->
    <div id="page-purchase-ledger" class="page purchase-ledger-bg">
        <main class="w-full max-w-6xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Purchase Ledger</h2>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">All Purchase Records</h3>
                    <div class="flex gap-2">
                        <button onclick="downloadData('purchase')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            üì• Download Purchase Data
                        </button>
                        <button onclick="loadPurchaseLedger()" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors">
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                        <input type="date" id="purchase-date-from" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                        <input type="date" id="purchase-date-to" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product</label>
                        <select id="purchase-product-filter" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">All Products</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end mb-4">
                    <button onclick="applyPurchaseFilters()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        Apply Filters
                    </button>
                    <button onclick="clearPurchaseFilters()" class="ml-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Clear
                    </button>
                </div>
                
                <!-- Loading State -->
                <div id="purchase-ledger-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading purchase records...</p>
                </div>

                <!-- Error State -->
                <div id="purchase-ledger-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading purchase records</p>
                </div>

                <!-- Purchase Records Table -->
                <div id="purchase-ledger-content" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Date & Time</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">ID</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Units</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Unit Cost (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Total Cost (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="purchase-ledger-table-body">
                                <!-- Purchase records will be populated here -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-50 font-bold">
                                    <td colspan="5" class="border border-gray-200 px-4 py-2 text-right">Total:</td>
                                    <td class="border border-gray-200 px-4 py-2 text-green-600" id="purchase-total-cost">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Profit & Loss Page -->
    <div id="page-profit-loss" class="page" style="background: linear-gradient(rgba(16, 185, 129, 0.85), rgba(245, 158, 11, 0.438)); background-size: cover; background-position: center; min-height: 100vh;">
        <main class="w-full max-w-6xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Profit & Loss Analysis</h2>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">Financial Overview</h3>
                    <div class="flex gap-2">
                        <button onclick="downloadData('profit-loss')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            üì• Download P&L Data
                        </button>
                        <button onclick="loadProfitLossData()" class="px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition-colors">
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                        <input type="date" id="pl-date-from" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                        <input type="date" id="pl-date-to" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Product</label>
                        <select id="pl-product-filter" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">All Products</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end mb-4">
                    <button onclick="applyProfitLossFilters()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        Apply Filters
                    </button>
                    <button onclick="clearProfitLossFilters()" class="ml-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Clear
                    </button>
                </div>

                <!-- Loading State -->
                <div id="profit-loss-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading profit & loss data...</p>
                </div>

                <!-- Error State -->
                <div id="profit-loss-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading profit & loss data</p>
                </div>

                <!-- Profit & Loss Content -->
                <div id="profit-loss-content" class="hidden">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600" id="total-sales">‚Çπ0.00</div>
                            <div class="text-sm text-gray-600">Total Sales</div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-red-600" id="total-purchases">‚Çπ0.00</div>
                            <div class="text-sm text-gray-600">Total Purchases</div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600" id="gross-profit">‚Çπ0.00</div>
                            <div class="text-sm text-gray-600">Gross Profit</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600" id="profit-margin">0%</div>
                            <div class="text-sm text-gray-600">Profit Margin</div>
                        </div>
                    </div>

                    <!-- Overall Status -->
                    <div class="mb-6 p-4 rounded-lg" id="overall-status">
                        <!-- Status will be populated by JavaScript -->
                    </div>

                    <!-- Product-wise Breakdown Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Units Sold</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Opening Stock (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Purchase (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Sales (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Closing Stock (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Gross Profit (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Margin (%)</th>
                                </tr>
                            </thead>
                            <tbody id="profit-loss-table-body">
                                <!-- Product-wise data will be populated here -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-50 font-bold">
                                    <td colspan="2" class="border border-gray-200 px-4 py-2 text-right">Total:</td>
                                    <td class="border border-gray-200 px-4 py-2 text-gray-600" id="total-opening-stock-footer">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2 text-blue-600" id="total-purchases-footer">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2 text-green-600" id="total-sales-footer">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2 text-purple-600" id="total-closing-stock-footer">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2 text-blue-600" id="total-profit-footer">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2 text-purple-600" id="total-margin-footer">0%</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Opening Stock Page -->
    <div id="page-opening-stock" class="page" style="background: linear-gradient(rgba(255, 193, 7, 0.85), rgba(255, 152, 0, 0.438)); background-size: cover; background-position: center; min-height: 100vh;">
        <main class="w-full max-w-6xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Opening Stock Register</h2>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">All Created Products</h3>
                    <button onclick="loadOpeningStockData()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors">
                        Refresh
                    </button>
                </div>

                <!-- Loading State -->
                <div id="opening-stock-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading opening stock register...</p>
                </div>

                <!-- Error State -->
                <div id="opening-stock-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading opening stock data</p>
                </div>

                <!-- Opening Stock Content -->
                <div id="opening-stock-content" class="hidden">
                    <!-- Summary Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600" id="total-opening-products">0</div>
                            <div class="text-sm text-gray-600">Total Products</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600" id="total-opening-stock">0</div>
                            <div class="text-sm text-gray-600">Total Stock</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600" id="total-opening-value">‚Çπ0.00</div>
                            <div class="text-sm text-gray-600">Total Stock Value</div>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-orange-600" id="avg-stock-age">0 days</div>
                            <div class="text-sm text-gray-600">Avg Stock Age</div>
                        </div>
                    </div>

                    <!-- Products Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product ID</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product Name</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Unit Type</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Initial Stock</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Purchase Price (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Selling Price (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Stock Value (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Created Date</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Status</th>
                                </tr>
                            </thead>
                            <tbody id="opening-stock-table-body">
                                <!-- Products will be populated here -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-50 font-bold">
                                    <td colspan="3" class="border border-gray-200 px-4 py-2 text-right">Total:</td>
                                    <td class="border border-gray-200 px-4 py-2 text-green-600" id="total-initial-stock-footer">0</td>
                                    <td class="border border-gray-200 px-4 py-2" colspan="2"></td>
                                    <td class="border border-gray-200 px-4 py-2 text-blue-600" id="total-stock-value-footer">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2" colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Settings Page -->
    <div id="page-settings" class="page" style="background: linear-gradient(rgba(147, 51, 234, 0.85), rgba(59, 130, 246, 0.438)); background-size: cover; background-position: center; min-height: 100vh;">
        <main class="w-full max-w-6xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Settings</h2>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">User Management</h3>
                <p class="text-gray-600 mb-4">User management features will be implemented here.</p>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <p class="text-yellow-800">User management functionality is under development.</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Store Information</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Store Name</label>
                        <input type="text" class="w-full p-2 border border-gray-300 rounded-lg" value="Raza Wholesale and Retail" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                        <input type="text" class="w-full p-2 border border-gray-300 rounded-lg" value="Tolichowki, Hyderabad" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contact Number</label>
                        <input type="text" class="w-full p-2 border border-gray-300 rounded-lg" value="+91 7075210801" readonly>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ===== BACKEND CONFIGURATION =====
        const backendURL = `https://kirana-store-backend-production.up.railway.app`;
        const WHATSAPP_NUMBER = "917075210801";

        // Global variables
        let products = [];
        let cart = {};
        let allSalesData = [];
        let allPurchasesData = [];
        let pages = {};
        let backButton = null;
        let currentUser = null;

        // ===== UTILITY FUNCTIONS =====
        function formatDateTime(dateString) {
            if (!dateString) {
                return { date: 'N/A', time: 'N/A', full: 'N/A' };
            }

            try {
                const dateObj = new Date(dateString);

                if (isNaN(dateObj.getTime())) {
                    console.warn('Invalid date:', dateString);
                    return { date: 'Invalid Date', time: 'Invalid Date', full: 'Invalid Date' };
                }

                const day = dateObj.getDate().toString().padStart(2, '0');
                const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                const year = dateObj.getFullYear().toString().slice(-2);

                const hours = dateObj.getHours().toString().padStart(2, '0');
                const minutes = dateObj.getMinutes().toString().padStart(2, '0');

                return {
                    date: `${day}/${month}/${year}`,
                    time: `${hours}:${minutes}`,
                    full: `${day}/${month}/${year} ${hours}:${minutes}`
                };
            } catch (error) {
                console.error('Error formatting date:', error, dateString);
                return { date: 'Error', time: 'Error', full: 'Error' };
            }
        }

        function getUnitDisplay(unitType, quantity) {
            if (!unitType) {
                return `${quantity} pcs`;
            }

            const normalizedUnitType = unitType.toLowerCase().trim();

            switch(normalizedUnitType) {
                case 'kgs':
                case 'kg':
                case 'kilograms':
                    return `${quantity} kgs`;
                case 'ltr':
                case 'liter':
                case 'liters':
                case 'litre':
                case 'litres':
                    return `${quantity} ltr`;
                case 'pcs':
                case 'piece':
                case 'pieces':
                case 'pc':
                    return `${quantity} pcs`;
                default:
                    return `${quantity} ${unitType}`;
            }
        }

        function showNotification(message) {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) existingNotification.remove();

            const notification = document.createElement('div');
            notification.className = 'notification fixed top-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg z-50';
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ===== NAVIGATION FUNCTIONS =====
        function showContentPage(pageName) {
            Object.values(pages).forEach(page => page.classList.remove('active'));
            pages[pageName].classList.add('active');
            backButton.classList.remove('hidden');
            loadPageData(pageName);
        }

        function backToHome() {
            Object.values(pages).forEach(page => page.classList.remove('active'));
            pages.home.classList.add('active');
            backButton.classList.add('hidden');
        }

        function loadPageData(pageName) {
            switch(pageName) {
                case 'sales':
                    fetchProducts();
                    break;
                case 'purchase':
                    loadPurchasePage();
                    break;
                case 'create':
                    loadCreatePage();
                    break;
                case 'delete-product':
                    loadDeleteProductPage();
                    break;
                case 'all-products-ledger':
                    loadAllProductsLedger();
                    break;
                case 'sales-ledger':
                    loadSalesLedger();
                    break;
                case 'purchase-ledger':
                    loadPurchaseLedger();
                    break;
                case 'profit-loss':
                    loadProfitLossData();
                    break;
                case 'opening-stock':
                    loadOpeningStockData();
                    break;
            }
        }

        // ===== SALES PAGE FUNCTIONS =====
        async function fetchProducts() {
            console.log(`üîç Fetching from: ${backendURL}/products`);

            try {
                const response = await fetch(`${backendURL}/products`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    }
                });

                console.log(`üìä Status: ${response.status}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                products = await response.json();
                console.log("‚úÖ Products fetched:", products.length, "items");

                if (!Array.isArray(products) || products.length === 0) {
                    throw new Error("No products received");
                }

                renderProducts();
                showCartButton();

            } catch (error) {
                console.error("üí• Fetch error:", error);
                loadMockProducts();
            }
        }

        function loadMockProducts() {
            console.log('üîÑ Loading mock products');
            products = [
                {id: 1, name: "Apple", price: 100.00, stock: 5, unit_type: "kgs"},
                {id: 2, name: "Banana", price: 50.00, stock: 0, unit_type: "kgs"},
                {id: 3, name: "Orange", price: 80.00, stock: 3, unit_type: "kgs"},
                {id: 4, name: "Milk", price: 65.00, stock: 10, unit_type: "ltr"},
                {id: 5, name: "Bread", price: 40.00, stock: 0, unit_type: "pcs"},
                {id: 6, name: "Eggs", price: 90.00, stock: 12, unit_type: "pcs"},
            ];
            renderProducts();
            showCartButton();
        }

        function generateProductImage(productName) {
            if (!productName) return 'https://picsum.photos/400/400?random=product';

            const cleanName = productName.toLowerCase()
                .trim()
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, '+')
                .substring(0, 50);

            return `https://loremflickr.com/400/400/${cleanName}`;
        }

        function renderProducts() {
            const productListEl = document.getElementById('product-list');
            if (!products || products.length === 0) {
                productListEl.innerHTML = '<p class="text-center text-gray-500">No products available</p>';
                return;
            }

            productListEl.innerHTML = products.map(product => {
                const isOutOfStock = product.stock <= 0;
                const buttonClass = isOutOfStock
                    ? "w-full bg-gray-400 text-white text-xs font-bold py-2 px-3 rounded-lg cursor-not-allowed"
                    : "w-full bg-blue-500 text-white text-xs font-bold py-2 px-3 rounded-lg hover:bg-blue-600 transition-colors duration-300";
                const buttonText = isOutOfStock ? "Out of Stock" : "Add to Cart";
                const unitDisplay = getUnitDisplay(product.unit_type || 'pcs', product.stock || 0);

                const imageUrl = generateProductImage(product.name);

                return `
                    <div class="bg-white p-4 rounded-xl shadow-lg transition-transform transform hover:scale-105 ${isOutOfStock ? 'opacity-70' : ''}">
                        <img src="${imageUrl}" alt="${product.name}"
                             class="w-full h-28 object-cover rounded-md mb-2"
                             onerror="this.src='https://picsum.photos/400/400?random=grocery'">
                        <h4 class="text-sm font-semibold text-gray-700">${product.name}</h4>
                        <p class="text-lg font-bold text-gray-800 my-1">‚Çπ${product.price.toFixed(2)}</p>
                        <div class="flex justify-between items-center text-xs text-gray-500 mb-2">
                            <span>Stock: ${unitDisplay}</span>
                            ${isOutOfStock ? '<span class="text-red-500 font-bold">Out of Stock</span>' : ''}
                        </div>
                        <button class="add-to-cart-btn mt-2 ${buttonClass}"
                                data-id="${product.id}"
                                ${isOutOfStock ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function showCartButton() {
            const existingButton = document.querySelector('.view-cart-button');
            if (existingButton) existingButton.remove();
            
            const cartButton = document.createElement('button');
            cartButton.className = 'view-cart-button fixed bottom-4 right-4 bg-blue-500 text-white p-4 rounded-full shadow-lg hover:bg-blue-600 transition-colors z-10';
            cartButton.innerHTML = 'üõí View Cart';
            cartButton.onclick = () => {
                document.getElementById('cart-modal').classList.remove('hidden');
                document.getElementById('cart-modal').classList.add('flex');
            };
            
            document.getElementById('page-sales').appendChild(cartButton);
        }

        function updateCartUI() {
            const cartItemsEl = document.getElementById('cart-items');
            const cartTotalEl = document.getElementById('cart-total');
            const whatsappCheckoutButtonEl = document.getElementById('whatsapp-checkout-button');
            
            cartItemsEl.innerHTML = '';
            let total = 0;
            let totalCount = 0;

            for (const productId in cart) {
                if (cart[productId] > 0) {
                    const product = products.find(p => p.id === parseInt(productId));
                    if (product) {
                        const quantity = cart[productId];
                        const itemTotal = quantity * product.price;
                        total += itemTotal;
                        totalCount += quantity;

                        const cartItem = document.createElement('div');
                        cartItem.className = "flex justify-between items-center p-3 bg-gray-50 rounded-lg";
                        cartItem.innerHTML = `
                            <div class="flex-1">
                                <div class="font-medium text-gray-800">${product.name}</div>
                                <div class="text-sm text-gray-600">‚Çπ${product.price.toFixed(2)} each</div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="decrease-quantity w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors" 
                                        data-id="${product.id}">
                                    -
                                </button>
                                <span class="quantity-display w-8 text-center font-medium">${quantity}</span>
                                <button class="increase-quantity w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center hover:bg-green-600 transition-colors" 
                                        data-id="${product.id}">
                                    +
                                </button>
                            </div>
                            <div class="text-right ml-4">
                                <div class="font-medium text-gray-800">‚Çπ${itemTotal.toFixed(2)}</div>
                                <button class="remove-item text-xs text-red-500 hover:text-red-700 mt-1" data-id="${product.id}">
                                    Remove
                                </button>
                            </div>
                        `;
                        cartItemsEl.appendChild(cartItem);
                    }
                }
            }

            cartTotalEl.textContent = `‚Çπ${total.toFixed(2)}`;
            whatsappCheckoutButtonEl.disabled = totalCount === 0;
            whatsappCheckoutButtonEl.className = totalCount === 0 
                ? "w-full mt-4 bg-gray-400 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed"
                : "w-full mt-4 bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-green-600 transition-colors duration-300";
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === parseInt(productId));
            
            if (!product) {
                showNotification("Product not found!");
                return;
            }
            
            if (product.stock <= 0) {
                showNotification(`Sorry, ${product.name} is out of stock!`);
                return;
            }
            
            const currentCartQuantity = cart[productId] || 0;
            if (currentCartQuantity + 1 > product.stock) {
                showNotification(`Sorry, only ${product.stock} units of ${product.name} are available!`);
                return;
            }
            
            cart[productId] = currentCartQuantity + 1;
            updateCartUI();
            showNotification(`Added ${product.name} to cart!`);
        }

        function increaseQuantity(productId) {
            const product = products.find(p => p.id === parseInt(productId));
            
            if (!product) {
                showNotification("Product not found!");
                return;
            }
            
            const currentCartQuantity = cart[productId] || 0;
            if (currentCartQuantity + 1 > product.stock) {
                showNotification(`Sorry, only ${product.stock} units of ${product.name} are available!`);
                return;
            }
            
            cart[productId] = currentCartQuantity + 1;
            updateCartUI();
        }

        function decreaseQuantity(productId) {
            if (cart[productId] > 1) {
                cart[productId] -= 1;
                updateCartUI();
            }
        }

        function removeFromCart(productId) {
            delete cart[productId];
            updateCartUI();
            showNotification("Item removed from cart!");
        }

        async function recordSale(saleItems) {
            console.log('üì¶ Recording sale items:', saleItems);
            
            try {
                for (const item of saleItems) {
                    const response = await fetch(`${backendURL}/sales/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'ngrok-skip-browser-warning': 'true'
                        },
                        body: JSON.stringify({
                            product_id: item.product_id,
                            quantity: item.quantity
                        })
                    });

                    console.log(`üìä Response for product ${item.product_id}: ${response.status}`);
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.log(`‚ùå Failed for product ${item.product_id}:`, errorData);
                        throw new Error(`Failed to record sale for ${item.product_name}`);
                    }
                    
                    const result = await response.json();
                    console.log(`‚úÖ Sale recorded for ${item.product_name}:`, result);
                }
                
                return { message: "All sales recorded successfully" };
                
            } catch (error) {
                console.error('Error recording sale:', error);
                throw error;
            }
        }

        function generateWhatsAppOrder() {
            const phoneNumber = WHATSAPP_NUMBER; 
            let message = "Hi, I would like to place an order:%0a%0a";
            let total = 0;
            const saleItems = [];

            for (const productId in cart) {
                if (cart[productId] > 0) {
                    const product = products.find(p => p.id === parseInt(productId));
                    if (product) {
                        const quantity = cart[productId];
                        const itemTotal = quantity * product.price;
                        total += itemTotal;
                        message += `‚Ä¢ ${quantity}x ${product.name} - ‚Çπ${itemTotal.toFixed(2)}%0a`;
                        
                        saleItems.push({
                            product_id: product.id,
                            product_name: product.name,
                            quantity: quantity,
                            price: product.price,
                            total: itemTotal
                        });
                    }
                }
            }

            message += `%0a*Total: ‚Çπ${total.toFixed(2)}*%0a%0aPlease confirm my order. Thank you!`;

            if (saleItems.length > 0) {
                recordSale(saleItems).then(result => {
                    console.log('‚úÖ Sales recorded in database:', result);
                    showNotification('Order recorded successfully!');
                }).catch(error => {
                    console.warn('‚ö†Ô∏è Sale recording failed, but continuing to WhatsApp:', error);
                    showNotification('Order sent to WhatsApp (database recording failed)');
                });
            }

            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${message}`;
            window.open(whatsappUrl, '_blank');
            
            cart = {};
            updateCartUI();
            document.getElementById('cart-modal').classList.add('hidden');
            document.getElementById('cart-modal').classList.remove('flex');
        }

        // ===== PURCHASE PAGE FUNCTIONS =====
        async function loadPurchasePage() {
            await loadProductDropdown('purchase-product');
            await loadPurchaseHistory();
        }

        async function loadProductDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) {
                console.error(`Dropdown with ID '${dropdownId}' not found`);
                return;
            }

            try {
                const response = await fetch(`${backendURL}/products`, {
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });

                if (response.ok) {
                    const products = await response.json();
                    dropdown.innerHTML = '<option value="">Select Product</option>';
                    products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.name} (${product.unit_type}) - Stock: ${product.stock || 0}`;
                        option.dataset.purchasePrice = product.purchase_price;
                        option.dataset.sellingPrice = product.selling_price;
                        option.dataset.unitType = product.unit_type;
                        dropdown.appendChild(option);
                    });
                    console.log(`‚úÖ Loaded ${products.length} products into dropdown`);
                } else {
                    throw new Error('Failed to fetch products');
                }
            } catch (error) {
                console.error('Error loading products for dropdown:', error);
                dropdown.innerHTML = '<option value="">Error loading products</option>';
            }
        }

        async function loadPurchaseHistory() {
            const historyEl = document.getElementById('purchase-history');
            historyEl.innerHTML = '<p class="text-gray-500 text-center">Loading purchase history...</p>';

            try {
                const response = await fetch(`${backendURL}/ledger/purchases`, {
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch products');

                const products = await response.json();

                if (products.length === 0) {
                    historyEl.innerHTML = '<p class="text-gray-500 text-center">No purchase history found</p>';
                    return;
                }

                historyEl.innerHTML = products.map(purchase => {
                    const formatted = formatDateTime(purchase.date);
                    return `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg mb-2">
                            <div class="flex-1">
                                <div class="font-medium">${purchase.product_name}</div>
                                <div class="text-sm text-gray-500">${formatted.date}</div>
                                <div class="text-xs text-gray-400">${formatted.time}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-medium">${purchase.quantity} units</div>
                                <div class="text-sm text-green-600">‚Çπ${purchase.total_cost.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading purchase history:', error);
                historyEl.innerHTML = '<p class="text-red-500 text-center">Error loading purchase history</p>';
            }
        }

        // ===== CREATE PRODUCT PAGE FUNCTIONS =====
        async function loadCreatePage() {
            await loadExistingProducts();
        }

        async function loadExistingProducts() {
            const productsEl = document.getElementById('existing-products');
            productsEl.innerHTML = '<p class="text-gray-500 text-center">Loading products...</p>';

            try {
                const response = await fetch(`${backendURL}/products`, {
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });

                if (!response.ok) throw new Error('Failed to fetch products');

                const products = await response.json();

                if (products.length === 0) {
                    productsEl.innerHTML = '<p class="text-gray-500 text-center">No products found. Create your first product!</p>';
                    return;
                }

                productsEl.innerHTML = products.map(product => {
                    const unitDisplay = getUnitDisplay(product.unit_type || 'pcs', product.stock || 0);
                    return `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <div>
                                <div class="font-medium">${product.name}</div>
                                <div class="text-sm text-gray-500">Stock: ${unitDisplay}</div>
                                <div class="text-xs text-gray-400">Type: ${product.unit_type || 'pcs'}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-medium">Buy: ‚Çπ${product.purchase_price?.toFixed(2) || '0.00'}</div>
                                <div class="text-sm text-green-600">Sell: ‚Çπ${product.selling_price?.toFixed(2) || '0.00'}</div>
                                <div class="text-xs text-gray-500">ID: ${product.id}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading products:', error);
                productsEl.innerHTML = '<p class="text-red-500 text-center">Error loading products</p>';
            }
        }

        async function createProduct(productData) {
            console.log('‚ûï Creating product:', productData);

            try {
                const response = await fetch(`${backendURL}/products/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify(productData)
                });

                console.log(`üìä Response: ${response.status}`);

                if (!response.ok) {
                    let errorMessage = 'Failed to create product';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorData.message || errorMessage;
                    } catch (parseError) {
                        errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log('‚úÖ Product created successfully:', result);
                return result;

            } catch (error) {
                console.error('Error creating product:', error);
                throw error;
            }
        }

        // ===== DELETE PRODUCT PAGE FUNCTIONS =====
        async function loadDeleteProductPage() {
            const loadingEl = document.getElementById('delete-product-loading');
            const errorEl = document.getElementById('delete-product-error');
            const contentEl = document.getElementById('delete-product-content');
            
            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            contentEl.classList.add('hidden');
            
            try {
                const response = await fetch(`${backendURL}/products`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch products');
                
                const products = await response.json();
                
                if (!Array.isArray(products) || products.length === 0) {
                    throw new Error('No products found');
                }
                
                displayProductsForDeletion(products);
                
                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading products for deletion:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.innerHTML = `<p class="text-red-500">Error loading products: ${error.message}</p>`;
            }
        }

        function displayProductsForDeletion(products) {
            const tableBodyEl = document.getElementById('delete-product-table-body');

            if (products.length === 0) {
                tableBodyEl.innerHTML = `
                    <tr>
                        <td colspan="6" class="border border-gray-200 px-4 py-4 text-center text-gray-500">
                            No products found
                        </td>
                    </tr>
                `;
                return;
            }

            products.sort((a, b) => a.id - b.id);

            tableBodyEl.innerHTML = products.map(product => {
                const lastUpdated = product.last_updated || product.created_at || product.updated_at;
                const formattedDate = formatDateTime(lastUpdated);
                const unitDisplay = getUnitDisplay(product.unit_type || 'pcs', product.stock || 0);

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-2 font-medium">${product.id}</td>
                        <td class="border border-gray-200 px-4 py-2 font-medium">${product.name}</td>
                        <td class="border border-gray-200 px-4 py-2">‚Çπ${product.selling_price?.toFixed(2) || product.price?.toFixed(2) || '0.00'}</td>
                        <td class="border border-gray-200 px-4 py-2 ${product.stock <= 10 ? 'text-red-600 font-bold' : ''}">${unitDisplay}</td>
                        <td class="border border-gray-200 px-4 py-2 text-sm text-gray-600">${formattedDate.date}<br><span class="text-xs">${formattedDate.time}</span></td>
                        <td class="border border-gray-200 px-4 py-2">
                            <button class="delete-product-btn text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors"
                                    data-id="${product.id}" data-name="${product.name}">
                                Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function deleteProduct(productId, productName) {
            if (!confirm(`Are you sure you want to delete "${productName}"? This action cannot be undone and will remove all associated sales and purchase records.`)) {
                return;
            }
            
            try {
                const deleteURL = `${backendURL}/products/${productId}`;
                
                console.log(`üóëÔ∏è Attempting to delete product from: ${deleteURL}`);
                
                const response = await fetch(deleteURL, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                
                console.log(`üìä Delete response status: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(result.message || `Product "${productName}" deleted successfully!`);
                    
                    await loadDeleteProductPage();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `Server returned ${response.status}`);
                }
                
            } catch (error) {
                console.error('Error deleting product:', error);
                alert(`‚ùå Error deleting product: ${error.message}`);
            }
        }

        // ===== ALL PRODUCTS STOCK LEDGER FUNCTIONS =====
        async function loadAllProductsLedger() {
            const loadingEl = document.getElementById('all-products-ledger-loading');
            const errorEl = document.getElementById('all-products-ledger-error');
            const contentEl = document.getElementById('all-products-ledger-content');

            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            contentEl.classList.add('hidden');

            try {
                const dateFrom = document.getElementById('stock-date-from').value;
                const dateTo = document.getElementById('stock-date-to').value;
                const productId = document.getElementById('stock-product-filter').value;

                let stockData = [];

                const params = new URLSearchParams();

                if (dateFrom && dateFrom.trim() !== '') {
                    params.append('date_from', dateFrom);
                }
                if (dateTo && dateTo.trim() !== '') {
                    params.append('date_to', dateTo);
                }
                if (productId && productId.trim() !== '') {
                    params.append('product_id', productId);
                }

                const url = `${backendURL}/products/stock-snapshot${params.toString() ? '?' + params.toString() : ''}`;
                console.log(`üìä Fetching from: ${url}`);

                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    }
                });

                if (!response.ok) {
                    let errorMessage = `Failed to fetch stock data: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.detail) {
                            errorMessage = errorData.detail;
                        }
                    } catch (e) {
                        errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

                stockData = await response.json();

                if (dateTo && dateTo.trim() !== '') {
                    console.log(`‚úÖ Received historical stock data as of ${dateTo}`);
                } else {
                    console.log('‚úÖ Received current stock data');
                }

                console.log(`üìä Retrieved ${stockData.length} stock records`);

                if (!Array.isArray(stockData) || stockData.length === 0) {
                    displayFilteredStockData([]);
                    loadingEl.classList.add('hidden');
                    contentEl.classList.remove('hidden');
                    return;
                }

                await loadProductDropdownForFilter('stock-product-filter');

                displayFilteredStockData(stockData);

                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');

            } catch (error) {
                console.error('Error loading all products ledger:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.innerHTML = `
                    <div class="text-center">
                        <p class="text-red-500 font-semibold">Error loading products stock data</p>
                        <p class="text-gray-600 mt-2">${error.message}</p>
                        <button onclick="clearStockFiltersAndReload()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            Clear Filters & Retry
                        </button>
                    </div>
                `;
            }
        }

        function displayFilteredStockData(stockData) {
            const tableBodyEl = document.getElementById('all-products-ledger-table-body');
            const totalProductsEl = document.getElementById('total-products');
            const totalStockEl = document.getElementById('total-stock');
            const lowStockCountEl = document.getElementById('low-stock-count');
            const outOfStockCountEl = document.getElementById('out-of-stock-count');
            const totalStockValueEl = document.getElementById('total-stock-value');

            if (!stockData || stockData.length === 0) {
                tableBodyEl.innerHTML = `
                    <tr>
                        <td colspan="6" class="border border-gray-200 px-4 py-4 text-center text-gray-500">
                            No stock data found for the selected filters
                        </td>
                    </tr>
                `;
                totalProductsEl.textContent = '0';
                totalStockEl.textContent = '0';
                lowStockCountEl.textContent = '0';
                outOfStockCountEl.textContent = '0';
                totalStockValueEl.textContent = '‚Çπ0.00';
                return;
            }

            let totalProducts = 0;
            let totalStock = 0;
            let lowStockCount = 0;
            let outOfStockCount = 0;
            let totalStockValue = 0;

            tableBodyEl.innerHTML = stockData.map(product => {
                totalProducts++;
                totalStock += product.stock || 0;

                const stockValue = (product.price || 0) * (product.stock || 0);
                totalStockValue += stockValue;

                const lastUpdated = product.last_updated || product.created_at || product.updated_at;
                const formattedDate = formatDateTime(lastUpdated);

                const unitType = product.unit_type || 'pcs';
                const stockDisplay = getUnitDisplay(unitType, product.stock || 0);

                let status = '';
                let statusClass = '';

                if (product.stock === 0) {
                    outOfStockCount++;
                    status = 'Out of Stock';
                    statusClass = 'bg-red-100 text-red-800';
                } else if (product.stock <= 10) {
                    lowStockCount++;
                    status = 'Low Stock';
                    statusClass = 'bg-yellow-100 text-yellow-800';
                } else {
                    status = 'In Stock';
                    statusClass = 'bg-green-100 text-green-800';
                }

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-2 font-medium">${product.product_name || product.name}</td>
                        <td class="border border-gray-200 px-4 py-2 ${product.stock <= 10 ? 'text-red-600 font-bold' : ''}">${stockDisplay}</td>
                        <td class="border border-gray-200 px-4 py-2">‚Çπ${(product.price || 0).toFixed(2)}</td>
                        <td class="border border-gray-200 px-4 py-2 font-medium">‚Çπ${stockValue.toFixed(2)}</td>
                        <td class="border border-gray-200 px-4 py-2 text-sm text-gray-600">${formattedDate.date}<br><span class="text-xs">${formattedDate.time}</span></td>
                        <td class="border border-gray-200 px-4 py-2">
                            <span class="text-xs px-2 py-1 rounded-full ${statusClass}">${status}</span>
                        </td>
                    </tr>
                `;
            }).join('');

            totalProductsEl.textContent = totalProducts;
            totalStockEl.textContent = totalStock;
            lowStockCountEl.textContent = lowStockCount;
            outOfStockCountEl.textContent = outOfStockCount;
            totalStockValueEl.textContent = `‚Çπ${totalStockValue.toFixed(2)}`;
        }

        function clearStockFiltersAndReload() {
            document.getElementById('stock-date-from').value = '';
            document.getElementById('stock-date-to').value = '';
            document.getElementById('stock-product-filter').value = '';
            loadAllProductsLedger();
        }

        function applyStockFilters() {
            loadAllProductsLedger();
        }

        function clearStockFilters() {
            clearStockFiltersAndReload();
        }

        // ===== SALES LEDGER FUNCTIONS =====
        async function loadSalesLedger() {
            const loadingEl = document.getElementById('sales-ledger-loading');
            const errorEl = document.getElementById('sales-ledger-error');
            const contentEl = document.getElementById('sales-ledger-content');

            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            contentEl.classList.add('hidden');

            try {
                console.log('üìä Fetching sales ledger from:', `${backendURL}/ledger/sales`);

                const response = await fetch(`${backendURL}/ledger/sales`, {
                    headers: {
                        'ngrok-skip-browser-warning': 'true',
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üìä Sales response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('üö´ Sales API error:', response.status, errorText);
                    throw new Error(`Server returned ${response.status}: ${errorText}`);
                }

                allSalesData = await response.json();
                console.log('‚úÖ Sales data received:', allSalesData);

                await loadProductDropdownForFilter('sales-product-filter');

                displayFilteredSalesData(allSalesData);

                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');

            } catch (error) {
                console.error('‚ùå Error loading sales ledger:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.innerHTML = `<div class="text-center">
                    <p class="text-red-500 font-semibold">Error Loading Sales Data</p>
                    <p class="text-gray-600 mt-2">${error.message}</p>
                    <button onclick="loadSalesLedger()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Retry
                    </button>
                </div>`;
            }
        }

        function displayFilteredSalesData(salesData) {
            const tableBodyEl = document.getElementById('sales-ledger-table-body');
            const totalAmountEl = document.getElementById('sales-total-amount');
            
            if (salesData.length === 0) {
                tableBodyEl.innerHTML = `
                    <tr>
                        <td colspan="7" class="border border-gray-200 px-4 py-4 text-center text-gray-500">
                            No sales records found
                        </td>
                    </tr>
                `;
                totalAmountEl.textContent = '‚Çπ0.00';
                return;
            }
            
            let totalAmount = 0;
            
            tableBodyEl.innerHTML = salesData.map(sale => {
                const formatted = formatDateTime(sale.date);
                const saleId = sale.sale_id || sale.id;
                const price = sale.unit_price || (sale.total_amount / sale.quantity) || 0;
                totalAmount += sale.total_amount;
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-2">
                            <div class="text-sm font-medium">${formatted.date}</div>
                            <div class="text-xs text-gray-500">${formatted.time}</div>
                        </td>
                        <td class="border border-gray-200 px-4 py-2 text-sm">${saleId}</td>
                        <td class="border border-gray-200 px-4 py-2 font-medium">${sale.product_name}</td>
                        <td class="border border-gray-200 px-4 py-2">${sale.quantity}</td>
                        <td class="border border-gray-200 px-4 py-2">‚Çπ${price.toFixed(2)}</td>
                        <td class="border border-gray-200 px-4 py-2 font-medium">‚Çπ${sale.total_amount.toFixed(2)}</td>
                        <td class="border border-gray-200 px-4 py-2">
                            <button class="delete-sale text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors" 
                                    data-id="${saleId}">
                                Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            totalAmountEl.textContent = `‚Çπ${totalAmount.toFixed(2)}`;
        }

        function applySalesFilters() {
            const dateFrom = document.getElementById('sales-date-from').value;
            const dateTo = document.getElementById('sales-date-to').value;
            const productId = document.getElementById('sales-product-filter').value;
            
            let filteredData = allSalesData;
            
            if (dateFrom) {
                filteredData = filteredData.filter(sale => {
                    const saleDate = new Date(sale.date).toISOString().split('T')[0];
                    return saleDate >= dateFrom;
                });
            }
            
            if (dateTo) {
                filteredData = filteredData.filter(sale => {
                    const saleDate = new Date(sale.date).toISOString().split('T')[0];
                    return saleDate <= dateTo;
                });
            }
            
            if (productId) {
                filteredData = filteredData.filter(sale => sale.product_id == productId);
            }
            
            displayFilteredSalesData(filteredData);
        }

        function clearSalesFilters() {
            document.getElementById('sales-date-from').value = '';
            document.getElementById('sales-date-to').value = '';
            document.getElementById('sales-product-filter').value = '';
            displayFilteredSalesData(allSalesData);
        }

        // ===== PURCHASE LEDGER FUNCTIONS =====
        async function loadPurchaseLedger() {
            const loadingEl = document.getElementById('purchase-ledger-loading');
            const errorEl = document.getElementById('purchase-ledger-error');
            const contentEl = document.getElementById('purchase-ledger-content');

            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            contentEl.classList.add('hidden');

            try {
                console.log('üìä Fetching purchase ledger from:', `${backendURL}/ledger/purchases`);

                const response = await fetch(`${backendURL}/ledger/purchases`, {
                    headers: {
                        'ngrok-skip-browser-warning': 'true',
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üìä Purchase response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('üö´ Purchase API error:', response.status, errorText);
                    throw new Error(`Server returned ${response.status}: ${errorText}`);
                }

                allPurchasesData = await response.json();
                console.log('‚úÖ Purchase data received:', allPurchasesData);

                await loadProductDropdownForFilter('purchase-product-filter');

                displayFilteredPurchaseData(allPurchasesData);

                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');

            } catch (error) {
                console.error('‚ùå Error loading purchase ledger:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.innerHTML = `<div class="text-center">
                    <p class="text-red-500 font-semibold">Error Loading Purchase Data</p>
                    <p class="text-gray-600 mt-2">${error.message}</p>
                    <button onclick="loadPurchaseLedger()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Retry
                    </button>
                </div>`;
            }
        }

        function displayFilteredPurchaseData(purchasesData) {
            const tableBodyEl = document.getElementById('purchase-ledger-table-body');
            const totalCostEl = document.getElementById('purchase-total-cost');
            
            if (purchasesData.length === 0) {
                tableBodyEl.innerHTML = `
                    <tr>
                        <td colspan="7" class="border border-gray-200 px-4 py-4 text-center text-gray-500">
                            No purchase records found
                        </td>
                    </tr>
                `;
                totalCostEl.textContent = '‚Çπ0.00';
                return;
            }
            
            let totalCost = 0;
            
            tableBodyEl.innerHTML = purchasesData.map(purchase => {
                const formatted = formatDateTime(purchase.date);
                const purchaseId = purchase.purchase_id || purchase.id;
                const unitCost = purchase.unit_cost || (purchase.total_cost / purchase.quantity) || 0;
                totalCost += purchase.total_cost;
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-2">
                            <div class="text-sm font-medium">${formatted.date}</div>
                            <div class="text-xs text-gray-500">${formatted.time}</div>
                        </td>
                        <td class="border border-gray-200 px-4 py-2 text-sm">${purchaseId}</td>
                        <td class="border border-gray-200 px-4 py-2 font-medium">${purchase.product_name}</td>
                        <td class="border border-gray-200 px-4 py-2">${purchase.quantity}</td>
                        <td class="border border-gray-200 px-4 py-2">‚Çπ${unitCost.toFixed(2)}</td>
                        <td class="border border-gray-200 px-4 py-2 font-medium">‚Çπ${purchase.total_cost.toFixed(2)}</td>
                        <td class="border border-gray-200 px-4 py-2">
                            <button class="delete-purchase text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors" 
                                    data-id="${purchaseId}">
                                Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            totalCostEl.textContent = `‚Çπ${totalCost.toFixed(2)}`;
        }

        function applyPurchaseFilters() {
            const dateFrom = document.getElementById('purchase-date-from').value;
            const dateTo = document.getElementById('purchase-date-to').value;
            const productId = document.getElementById('purchase-product-filter').value;
            
            let filteredData = allPurchasesData;
            
            if (dateFrom) {
                filteredData = filteredData.filter(purchase => {
                    const purchaseDate = new Date(purchase.date).toISOString().split('T')[0];
                    return purchaseDate >= dateFrom;
                });
            }
            
            if (dateTo) {
                filteredData = filteredData.filter(purchase => {
                    const purchaseDate = new Date(purchase.date).toISOString().split('T')[0];
                    return purchaseDate <= dateTo;
                });
            }
            
            if (productId) {
                filteredData = filteredData.filter(purchase => purchase.product_id == productId);
            }
            
            displayFilteredPurchaseData(filteredData);
        }

        function clearPurchaseFilters() {
            document.getElementById('purchase-date-from').value = '';
            document.getElementById('purchase-date-to').value = '';
            document.getElementById('purchase-product-filter').value = '';
            displayFilteredPurchaseData(allPurchasesData);
        }

        // ===== PROFIT & LOSS FUNCTIONS =====
        async function loadProfitLossData() {
            const loadingEl = document.getElementById('profit-loss-loading');
            const errorEl = document.getElementById('profit-loss-error');
            const contentEl = document.getElementById('profit-loss-content');

            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            contentEl.classList.add('hidden');

            try {
                const [salesResponse, purchasesResponse, productsResponse] = await Promise.all([
                    fetch(`${backendURL}/ledger/sales`, {
                        headers: { 'ngrok-skip-browser-warning': 'true' }
                    }),
                    fetch(`${backendURL}/ledger/purchases`, {
                        headers: { 'ngrok-skip-browser-warning': 'true' }
                    }),
                    fetch(`${backendURL}/products`, {
                        headers: { 'ngrok-skip-browser-warning': 'true' }
                    })
                ]);

                if (!salesResponse.ok) throw new Error('Failed to fetch sales data');
                if (!purchasesResponse.ok) throw new Error('Failed to fetch purchase data');
                if (!productsResponse.ok) throw new Error('Failed to fetch products data');

                const salesData = await salesResponse.json();
                const purchasesData = await purchasesResponse.json();
                const productsData = await productsResponse.json();

                allSalesData = salesData || [];
                allPurchasesData = purchasesData || [];

                await loadProductDropdownForFilter('pl-product-filter');

                calculateAndDisplayProfitLoss(allSalesData, allPurchasesData, productsData);

                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');

            } catch (error) {
                console.error('Error loading profit & loss data:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.innerHTML = `<p class="text-red-500">Error loading profit & loss data: ${error.message}</p>`;
            }
        }

        async function calculateAndDisplayProfitLoss(salesData, purchasesData, productsData, dateFrom = null, dateTo = null) {
            const tableBodyEl = document.getElementById('profit-loss-table-body');
            const totalSalesEl = document.getElementById('total-sales');
            const totalPurchasesEl = document.getElementById('total-purchases');
            const grossProfitEl = document.getElementById('gross-profit');
            const profitMarginEl = document.getElementById('profit-margin');
            const overallStatusEl = document.getElementById('overall-status');

            try {
                // This is a simplified version - you would need to implement the actual profit/loss calculation
                // based on your business logic and available API endpoints
                
                let totalSales = 0;
                let totalPurchases = 0;
                
                salesData.forEach(sale => totalSales += sale.total_amount || 0);
                purchasesData.forEach(purchase => totalPurchases += purchase.total_cost || 0);
                
                const grossProfit = totalSales - totalPurchases;
                const profitMargin = totalSales > 0 ? (grossProfit / totalSales) * 100 : 0;

                // Update summary cards
                totalSalesEl.textContent = `‚Çπ${totalSales.toFixed(2)}`;
                totalPurchasesEl.textContent = `‚Çπ${totalPurchases.toFixed(2)}`;
                grossProfitEl.textContent = `‚Çπ${grossProfit.toFixed(2)}`;
                profitMarginEl.textContent = `${profitMargin.toFixed(2)}%`;

                // Update overall status
                const statusClass = grossProfit >= 0 ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
                const statusTextClass = grossProfit >= 0 ? 'text-green-800' : 'text-red-800';
                const statusIcon = grossProfit >= 0 ? 'üìà' : 'üìâ';

                overallStatusEl.className = `mb-6 p-4 rounded-lg border ${statusClass}`;
                overallStatusEl.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">${statusIcon}</span>
                        <div>
                            <h4 class="font-semibold ${statusTextClass}">
                                ${grossProfit >= 0 ? 'Profit' : 'Loss'} of ‚Çπ${Math.abs(grossProfit).toFixed(2)}
                            </h4>
                            <p class="text-sm text-gray-600">
                                Total Sales: ‚Çπ${totalSales.toFixed(2)} | Total Purchases: ‚Çπ${totalPurchases.toFixed(2)}
                            </p>
                        </div>
                    </div>
                `;

                // Simple product-wise breakdown (you would need to implement the actual calculation)
                tableBodyEl.innerHTML = productsData.map(product => {
                    const productSales = salesData.filter(s => s.product_id === product.id)
                        .reduce((sum, sale) => sum + (sale.total_amount || 0), 0);
                    const productPurchases = purchasesData.filter(p => p.product_id === product.id)
                        .reduce((sum, purchase) => sum + (purchase.total_cost || 0), 0);
                    const productProfit = productSales - productPurchases;
                    const productMargin = productSales > 0 ? (productProfit / productSales) * 100 : 0;

                    const profitClass = productProfit >= 0 ? 'text-green-600' : 'text-red-600';
                    const marginClass = productMargin >= 0 ? 'text-green-600' : 'text-red-600';

                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-4 py-2 font-medium">${product.name}</td>
                            <td class="border border-gray-200 px-4 py-2">-</td>
                            <td class="border border-gray-200 px-4 py-2 text-gray-600">-</td>
                            <td class="border border-gray-200 px-4 py-2 text-blue-600">‚Çπ${productPurchases.toFixed(2)}</td>
                            <td class="border border-gray-200 px-4 py-2 text-green-600">‚Çπ${productSales.toFixed(2)}</td>
                            <td class="border border-gray-200 px-4 py-2 text-purple-600">-</td>
                            <td class="border border-gray-200 px-4 py-2 font-medium ${profitClass}">‚Çπ${productProfit.toFixed(2)}</td>
                            <td class="border border-gray-200 px-4 py-2 font-medium ${marginClass}">${productMargin.toFixed(2)}%</td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="8" class="border border-gray-200 px-4 py-4 text-center text-gray-500">No transaction data found for the selected period</td></tr>';

            } catch (error) {
                console.error('Error calculating profit/loss:', error);
                tableBodyEl.innerHTML = `
                    <tr>
                        <td colspan="8" class="border border-gray-200 px-4 py-4 text-center text-red-500">
                            Error calculating profit & loss: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        function applyProfitLossFilters() {
            const dateFrom = document.getElementById('pl-date-from').value;
            const dateTo = document.getElementById('pl-date-to').value;
            const productId = document.getElementById('pl-product-filter').value;

            let filteredSales = allSalesData;
            let filteredPurchases = allPurchasesData;

            if (dateFrom) {
                filteredSales = filteredSales.filter(sale => {
                    const saleDate = new Date(sale.date).toISOString().split('T')[0];
                    return saleDate >= dateFrom;
                });
                filteredPurchases = filteredPurchases.filter(purchase => {
                    const purchaseDate = new Date(purchase.date).toISOString().split('T')[0];
                    return purchaseDate >= dateFrom;
                });
            }

            if (dateTo) {
                filteredSales = filteredSales.filter(sale => {
                    const saleDate = new Date(sale.date).toISOString().split('T')[0];
                    return saleDate <= dateTo;
                });
                filteredPurchases = filteredPurchases.filter(purchase => {
                    const purchaseDate = new Date(purchase.date).toISOString().split('T')[0];
                    return purchaseDate <= dateTo;
                });
            }

            if (productId) {
                filteredSales = filteredSales.filter(sale => sale.product_id == productId);
                filteredPurchases = filteredPurchases.filter(purchase => purchase.product_id == productId);
            }

            fetch(`${backendURL}/products`, {
                headers: { 'ngrok-skip-browser-warning': 'true' }
            })
            .then(response => response.json())
            .then(productsData => {
                if (productId) {
                    productsData = productsData.filter(product => product.id == productId);
                }
                calculateAndDisplayProfitLoss(filteredSales, filteredPurchases, productsData);
            })
            .catch(error => {
                console.error('Error fetching products for filtered calculation:', error);
            });
        }

        function clearProfitLossFilters() {
            document.getElementById('pl-date-from').value = '';
            document.getElementById('pl-date-to').value = '';
            document.getElementById('pl-product-filter').value = '';

            fetch(`${backendURL}/products`, {
                headers: { 'ngrok-skip-browser-warning': 'true' }
            })
            .then(response => response.json())
            .then(productsData => {
                calculateAndDisplayProfitLoss(allSalesData, allPurchasesData, productsData);
            })
            .catch(error => {
                console.error('Error fetching products for clear filters:', error);
            });
        }

        // ===== OPENING STOCK PAGE FUNCTIONS =====
        async function loadOpeningStockData() {
            const loadingEl = document.getElementById('opening-stock-loading');
            const errorEl = document.getElementById('opening-stock-error');
            const contentEl = document.getElementById('opening-stock-content');

            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            contentEl.classList.add('hidden');

            try {
                const response = await fetch(`${backendURL}/products`, {
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });

                if (!response.ok) throw new Error('Failed to fetch products');

                const products = await response.json();
                console.log('üì¶ Products received:', products);

                if (!Array.isArray(products) || products.length === 0) {
                    throw new Error('No products found');
                }

                displayOpeningStockData(products);

                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');

            } catch (error) {
                console.error('Error loading opening stock data:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.innerHTML = `<p class="text-red-500">Error loading opening stock data: ${error.message}</p>`;
            }
        }

        function displayOpeningStockData(products) {
            const tableBodyEl = document.getElementById('opening-stock-table-body');
            const totalProductsEl = document.getElementById('total-opening-products');
            const totalStockEl = document.getElementById('total-opening-stock');
            const totalValueEl = document.getElementById('total-opening-value');
            const avgAgeEl = document.getElementById('avg-stock-age');

            if (products.length === 0) {
                tableBodyEl.innerHTML = `
                    <tr>
                        <td colspan="9" class="border border-gray-200 px-4 py-4 text-center text-gray-500">
                            No products found
                        </td>
                    </tr>
                `;
                totalProductsEl.textContent = '0';
                totalStockEl.textContent = '0';
                totalValueEl.textContent = '‚Çπ0.00';
                avgAgeEl.textContent = '0 days';
                return;
            }

            let totalProducts = 0;
            let totalStock = 0;
            let totalStockValue = 0;
            let totalAgeDays = 0;

            products.sort((a, b) => {
                const dateA = new Date(a.created_at || Date.now());
                const dateB = new Date(b.created_at || Date.now());
                return dateB - dateA;
            });

            tableBodyEl.innerHTML = products.map(product => {
                totalProducts++;
                const stock = product.stock || 0;
                totalStock += stock;

                const purchasePrice = product.purchase_price || 0;
                const stockValue = stock * purchasePrice;
                totalStockValue += stockValue;

                const createdDate = new Date(product.created_at || Date.now());
                const now = new Date();
                const ageDays = Math.floor((now - createdDate) / (1000 * 60 * 60 * 24));
                totalAgeDays += ageDays;

                const formattedDate = formatDateTime(product.created_at);
                const unitDisplay = getUnitDisplay(product.unit_type || 'pcs', stock);

                let status = 'Active';
                let statusClass = 'bg-green-100 text-green-800';

                if (stock === 0) {
                    status = 'Out of Stock';
                    statusClass = 'bg-red-100 text-red-800';
                } else if (stock <= 10) {
                    status = 'Low Stock';
                    statusClass = 'bg-yellow-100 text-yellow-800';
                }

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-2 font-medium">${product.id}</td>
                        <td class="border border-gray-200 px-4 py-2 font-medium">${product.name}</td>
                        <td class="border border-gray-200 px-4 py-2">${product.unit_type || 'pcs'}</td>
                        <td class="border border-gray-200 px-4 py-2 ${stock <= 10 ? 'text-red-600 font-bold' : ''}">${unitDisplay}</td>
                        <td class="border border-gray-200 px-4 py-2">‚Çπ${purchasePrice.toFixed(2)}</td>
                        <td class="border border-gray-200 px-4 py-2">‚Çπ${(product.selling_price || 0).toFixed(2)}</td>
                        <td class="border border-gray-200 px-4 py-2 font-medium">‚Çπ${stockValue.toFixed(2)}</td>
                        <td class="border border-gray-200 px-4 py-2 text-sm text-gray-600">${formattedDate.date}<br><span class="text-xs">${ageDays} days ago</span></td>
                        <td class="border border-gray-200 px-4 py-2">
                            <span class="text-xs px-2 py-1 rounded-full ${statusClass}">${status}</span>
                        </td>
                    </tr>
                `;
            }).join('');

            const avgAge = totalProducts > 0 ? Math.round(totalAgeDays / totalProducts) : 0;

            totalProductsEl.textContent = totalProducts;
            totalStockEl.textContent = totalStock;
            totalValueEl.textContent = `‚Çπ${totalStockValue.toFixed(2)}`;
            avgAgeEl.textContent = `${avgAge} days`;

            document.getElementById('total-initial-stock-footer').textContent = totalStock;
            document.getElementById('total-stock-value-footer').textContent = `‚Çπ${totalStockValue.toFixed(2)}`;
        }

        // ===== HELPER FUNCTIONS =====
        async function loadProductDropdownForFilter(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) {
                console.error(`Dropdown with ID '${dropdownId}' not found`);
                return;
            }
            
            try {
                const response = await fetch(`${backendURL}/products`, {
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                
                if (response.ok) {
                    const products = await response.json();
                    dropdown.innerHTML = '<option value="">All Products</option>';
                    products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = product.name;
                        dropdown.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading products for filter:', error);
                dropdown.innerHTML = '<option value="">Error loading products</option>';
            }
        }

        function downloadData(dataType) {
            try {
                let endpoint;
                if (dataType === 'profit-loss') {
                    endpoint = 'profit-loss';
                } else if (dataType === 'stock') {
                    endpoint = 'stock-ledger';
                } else {
                    endpoint = `${dataType}-ledger`;
                }

                const baseUrl = `${backendURL}/download/${endpoint}`;
                let params = new URLSearchParams();

                if (dataType === 'sales') {
                    const dateFrom = document.getElementById('sales-date-from')?.value;
                    const dateTo = document.getElementById('sales-date-to')?.value;
                    const productId = document.getElementById('sales-product-filter')?.value;

                    if (dateFrom) params.append('start_date', dateFrom);
                    if (dateTo) params.append('end_date', dateTo);
                    if (productId) params.append('product_id', productId);
                } else if (dataType === 'purchase') {
                    const dateFrom = document.getElementById('purchase-date-from')?.value;
                    const dateTo = document.getElementById('purchase-date-to')?.value;
                    const productId = document.getElementById('purchase-product-filter')?.value;

                    if (dateFrom) params.append('start_date', dateFrom);
                    if (dateTo) params.append('end_date', dateTo);
                    if (productId) params.append('product_id', productId);
                } else if (dataType === 'stock') {
                    const dateFrom = document.getElementById('stock-date-from')?.value;
                    const dateTo = document.getElementById('stock-date-to')?.value;
                    const productId = document.getElementById('stock-product-filter')?.value;

                    if (dateFrom && dateFrom.trim() !== '') params.append('date_from', dateFrom);
                    if (dateTo && dateTo.trim() !== '') params.append('date_to', dateTo);
                    if (productId && productId.trim() !== '') params.append('product_id', productId);
                } else if (dataType === 'profit-loss') {
                    const dateFrom = document.getElementById('pl-date-from')?.value;
                    const dateTo = document.getElementById('pl-date-to')?.value;
                    const productId = document.getElementById('pl-product-filter')?.value;

                    if (dateFrom) params.append('start_date', dateFrom);
                    if (dateTo) params.append('end_date', dateTo);
                    if (productId) params.append('product_id', productId);
                }

                const url = params.toString() ? `${baseUrl}?${params.toString()}` : baseUrl;

                console.log(`üì• Downloading ${dataType} data from: ${url}`);

                const link = document.createElement('a');
                link.href = url;
                link.download = `${dataType}_data.csv`;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showNotification(`‚úÖ ${dataType.charAt(0).toUpperCase() + dataType.slice(1)} data download started!`);

            } catch (error) {
                console.error(`Error downloading ${dataType} data:`, error);
                showNotification(`‚ùå Error downloading ${dataType} data: ${error.message}`);
            }
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize pages
            pages = {
                home: document.getElementById('page-home'),
                sales: document.getElementById('page-sales'),
                purchase: document.getElementById('page-purchase'),
                create: document.getElementById('page-create'),
                'delete-product': document.getElementById('page-delete-product'),
                'all-products-ledger': document.getElementById('page-all-products-ledger'),
                'sales-ledger': document.getElementById('page-sales-ledger'),
                'purchase-ledger': document.getElementById('page-purchase-ledger'),
                'profit-loss': document.getElementById('page-profit-loss'),
                'opening-stock': document.getElementById('page-opening-stock'),
                settings: document.getElementById('page-settings'),
                loading: document.getElementById('page-loading'),
            };

            backButton = document.getElementById('back-to-home');

            // Set up event listeners
            setupEventListeners();

            // Show home page after a brief loading period
            setTimeout(() => {
                document.getElementById('page-loading').classList.remove('active');
                document.getElementById('page-home').classList.add('active');
            }, 1000);
        });

        function setupEventListeners() {
            // Cart modal close button
            const closeModalButton = document.getElementById('close-modal-button');
            if (closeModalButton) {
                closeModalButton.addEventListener('click', function() {
                    document.getElementById('cart-modal').classList.add('hidden');
                });
            }

            // Back to home button
            if (backButton) {
                backButton.addEventListener('click', backToHome);
            }

            // WhatsApp checkout button
            const whatsappCheckoutButton = document.getElementById('whatsapp-checkout-button');
            if (whatsappCheckoutButton) {
                whatsappCheckoutButton.addEventListener('click', generateWhatsAppOrder);
            }

            // Purchase form submission
            const purchaseForm = document.getElementById('purchase-form');
            if (purchaseForm) {
                purchaseForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    // Purchase form submission logic would go here
                    showNotification('Purchase functionality would be implemented here');
                });
            }

            // Create product form submission
            const createProductForm = document.getElementById('create-product-form');
            if (createProductForm) {
                createProductForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    // Create product form submission logic would go here
                    showNotification('Product creation functionality would be implemented here');
                });
            }

            // Event delegation for dynamic elements
            document.addEventListener('click', function(e) {
                // Add to cart buttons
                if (e.target && e.target.classList.contains('add-to-cart-btn')) {
                    const productId = e.target.getAttribute('data-id');
                    addToCart(productId);
                }

                // Increase quantity buttons
                if (e.target && e.target.classList.contains('increase-quantity')) {
                    const productId = e.target.getAttribute('data-id');
                    increaseQuantity(productId);
                }

                // Decrease quantity buttons
                if (e.target && e.target.classList.contains('decrease-quantity')) {
                    const productId = e.target.getAttribute('data-id');
                    decreaseQuantity(productId);
                }

                // Remove item buttons
                if (e.target && e.target.classList.contains('remove-item')) {
                    const productId = e.target.getAttribute('data-id');
                    removeFromCart(productId);
                }

                // Delete product buttons
                if (e.target && e.target.classList.contains('delete-product-btn')) {
                    const productId = e.target.getAttribute('data-id');
                    const productName = e.target.getAttribute('data-name');
                    deleteProduct(productId, productName);
                }

                // Delete sale buttons
                if (e.target && e.target.classList.contains('delete-sale')) {
                    const saleId = e.target.getAttribute('data-id');
                    showNotification(`Sale deletion would be implemented for ID: ${saleId}`);
                }

                // Delete purchase buttons
                if (e.target && e.target.classList.contains('delete-purchase')) {
                    const purchaseId = e.target.getAttribute('data-id');
                    showNotification(`Purchase deletion would be implemented for ID: ${purchaseId}`);
                }
            });

            // Purchase product dropdown change
            const purchaseProductDropdown = document.getElementById('purchase-product');
            if (purchaseProductDropdown) {
                purchaseProductDropdown.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption && selectedOption.value) {
                        document.getElementById('purchase-unit-cost').value = selectedOption.dataset.purchasePrice || '';
                        document.getElementById('purchase-unit-type').value = selectedOption.dataset.unitType || '';
                    } else {
                        document.getElementById('purchase-unit-cost').value = '';
                        document.getElementById('purchase-unit-type').value = '';
                    }
                });
            }
        }
    </script>
</body>
</html>