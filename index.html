<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kirana Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            corePlugins: {
                preflight: false,
            }
        }
    </script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            overflow-x: hidden;
        }
        .page {
            display: none;
            visibility: hidden;
            opacity: 0;
            position: absolute;
            width: 100%;
            min-height: 100vh;
            top: 0;
            left: 0;
            z-index: 1;
            pointer-events: none;
        }
        .page.active {
            display: block;
            visibility: visible;
            opacity: 1;
            position: static;
            z-index: 10;
            pointer-events: auto;
        }
        /* Beautiful gradient backgrounds */
        .gradient-bg {
            background: linear-gradient(rgba(132, 206, 248, 0.85), rgba(172, 124, 20, 0.438));
            background-size: cover;
            background-position: center;
            min-height: 100vh;
        }
        .sales-bg {
            background: linear-gradient(rgba(230, 93, 184, 0.925), rgba(233, 30, 165, 0.959));
            min-height: 100vh;
        }
        .purchase-bg {
            background: linear-gradient(rgba(59, 130, 246, 0.85), rgba(147, 51, 234, 0.438));
            min-height: 100vh;
        }          
        .create-bg {
            background: linear-gradient(rgba(16, 185, 129, 0.85), rgba(245, 158, 11, 0.438));
            min-height: 100vh;
        }            
        .delete-bg {
            background: linear-gradient(rgba(239, 68, 68, 0.85), rgba(107, 114, 128, 0.438));
            min-height: 100vh;
        }
        .stock-bg {
            background: linear-gradient(rgba(75, 85, 99, 0.85), rgba(55, 65, 81, 0.438));
            min-height: 100vh;
        }           
        .sales-ledger-bg {
            background: linear-gradient(rgba(240, 243, 76, 0.85), rgba(179, 209, 8, 0.438));
            min-height: 100vh;
        }            
        .purchase-ledger-bg {
            background: linear-gradient(rgba(59, 130, 246, 0.85), rgba(147, 51, 234, 0.438));
            min-height: 100vh;
        }            
        .glass-effect {
            background: rgba(236, 49, 49, 0.842);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(64, 202, 226, 0.918);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        /* Disable hover effects on touch devices */
        @media (hover: hover) {
            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px rgba(221, 4, 4, 0.1);
            }
        }

        /* Mobile specific adjustments */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            .page {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            .glass-effect {
                padding: 0.75rem;
                backdrop-filter: blur(5px);
            }
            .button-container {
                display: grid;
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            #cart-modal {
                margin: 1rem;
                max-height: 80vh;
            }
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            .table-container {
                overflow-x: auto;
                margin: -0.5rem -0.75rem 0 -0.75rem;
                padding: 0 0.75rem;
            }
            header .flex.items-center {
                flex-direction: column;
                gap: 0.5rem;
            }
            header .logo-container {
                max-width: 250px;
            }
            .card-hover {
                padding: 4px 8px !important;
            }
            .filter-section {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            .notification {
                top: 1rem;
                right: 1rem;
                left: 1rem;
                max-width: none;
                width: auto;
            }
        }

        /* Extra small mobile devices */
        @media (max-width: 480px) {
            .page {
                padding-left: 0.25rem;
                padding-right: 0.25rem;
            }
            .glass-effect {
                padding: 0.5rem;
                margin: 0.25rem;
            }
            .summary-cards {
                grid-template-columns: 1fr;
            }
            #cart-modal .bg-white {
                margin: 0.5rem;
            }
            h1 {
                font-size: 1.25rem;
            }
            h2 {
                font-size: 1.125rem;
            }
            .text-lg {
                font-size: 0.9375rem;
            }
            .text-sm {
                font-size: 0.8125rem;
            }
        }
    </style>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõí</text></svg>">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="w-full bg-green-500 shadow-sm p-1 sticky top-0 z-10">
        <div class="max-w-2xl mx-auto flex justify-between items-center">
            <div class="flex items-center">
                <div class="logo-container top-0">
                    <div class="text-center bg-blue-500 glass-effect rounded-2xl p-1 text-white">
                        <h1 id="header-store-name" class="text-xl font-bold mb-1">Raza Wholesale and Retail</h1>
                        <p id="header-store-subtitle" class="text-blue-100 mb-0">Kirana Store</p>
                        <p id="header-store-location" class="text-blue-100 text-sm mb-0">Tolichowki, Hyderabad</p>
                        <p id="header-store-contact-display" class="text-blue-100 text-sm mb-0">Contact: +91 7075210801</p>
                        <p id="header-delivery-note" class="text-blue-100 text-sm mb-0">Order on WhatsApp - We deliver to your doorstep</p>
                    </div>
                </div>
            </div>

            <!-- User Info and Controls -->
            <div id="user-controls" class="flex items-center gap-2 hidden">
                <div id="welcome-message" class="bg-blue-500 glass-effect rounded-xl px-3 py-1 text-white text-sm"></div>
                <button id="logout-btn" class="px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm">
                    Logout
                </button>
                <button id="back-to-home" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm hidden">
                    ‚Üê Home
                </button>
            </div>
        </div>
    </header>

    <!-- ===== LOGIN PAGE ===== -->
    <div id="page-login" class="page active" style="background: linear-gradient(rgba(59, 130, 246, 0.85), rgba(147, 51, 234, 0.438)); background-size: cover; background-position: center; min-height: 100vh;">
        <main class="w-full max-w-md mx-auto p-4 flex items-center justify-center min-h-screen">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">üõí Kirana Store</h1>
                    <p class="text-gray-600">Raza Wholesale and Retail</p>
                    <p class="text-sm text-gray-500">Please sign in to continue</p>
                </div>

                <!-- Login Form -->
                <form id="login-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="login-username" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter your username" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="login-password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" id="login-submit-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        Sign In
                    </button>
                </form>

                <!-- Registration Link -->
                <div class="mt-6 text-center">
                    <button id="show-register-btn" class="text-blue-500 hover:text-blue-600 text-sm">
                        Don't have an account? Register here
                    </button>
                </div>

                <!-- Registration Form (Hidden by default) -->
                <div id="register-form" class="mt-8 hidden">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Create Account</h2>
                    <form id="registration-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                            <input type="text" id="register-username" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Choose a username" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="register-email" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="your@email.com" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="register-password" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Choose a password" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                            <input type="password" id="register-confirm-password" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Confirm your password" required>
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" id="register-submit-btn" class="flex-1 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                                Register
                            </button>
                            <button type="button" id="back-to-login-btn" class="flex-1 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                                Back
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Login Status Messages -->
                <div id="login-status" class="mt-4 hidden">
                    <div id="login-status-message" class="text-center p-3 rounded-lg"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- ===== LANDING PAGE ===== -->
    <div id="page-homes" class="page gradient-bg">
        <main class="w-full max-w-6xl mx-auto p-8">
            <div id="main-page-buttons" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Buttons will be dynamically generated based on permissions -->
            </div>

            <!-- Fallback message if no permissions -->
            <div id="no-permissions-message" class="hidden text-center py-12">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-8 max-w-md mx-auto">
                    <div class="text-6xl mb-4">üîí</div>
                    <h3 class="text-xl font-semibold text-yellow-800 mb-2">Access Limited</h3>
                    <p class="text-yellow-700">Your account doesn't have permissions to access any features. Please contact an administrator.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- ===== CONTENT PAGES ===== -->

    <!-- Sales Content Page -->
    <div id="page-sales" class="page sales-bg">
        <main class="max-w-md p-4 space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Products</h2>
            <div id="product-list" class="grid grid-cols-2 gap-4">
                <div class="text-center py-8">
                    <p class="text-gray-500">Loading products...</p>
                </div>
            </div>
        </main>

        <!-- Cart Modal -->
        <div id="cart-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-20">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Your Cart</h3>
                    <button id="close-modal-button" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <div id="cart-items" class="space-y-3">
                    <!-- Cart items will be generated here by JavaScript -->
                </div>
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <div class="flex justify-between font-bold text-lg text-gray-800">
                        <span>Total:</span>
                        <span id="cart-total">‚Çπ0.00</span>
                    </div>
                    <button id="whatsapp-checkout-button" class="w-full mt-4 bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-green-600 transition-colors duration-300">
                        Checkout on WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchase Content Page -->
    <div id="page-purchase" class="page purchase-bg">
        <main class="w-full max-w-md mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Purchase Products</h2>
            
            <!-- Purchase Form -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Record New Purchase</h3>
                <form id="purchase-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Product</label>
                        <select id="purchase-product" class="w-full p-2 border border-gray-300 rounded-lg" required>
                            <option value="">Select Product</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                        <input type="number" id="purchase-quantity" class="w-full p-2 border border-gray-300 rounded-lg" min="1" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Unit Cost (‚Çπ) - Auto-filled</label>
                        <input type="number" id="purchase-unit-cost" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100" step="0.01" min="0.01" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Unit Type</label>
                        <input type="text" id="purchase-unit-type" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                    <button type="submit" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                        Record Purchase
                    </button>
                </form>
            </div>

            <!-- Recent Purchases -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Recent Purchases</h3>
                <div id="purchase-history" class="space-y-3">
                    <!-- Purchase history will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Create Product Content Page -->
    <div id="page-create" class="page create-bg">
        <main class="w-full max-w-md mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Create New Product</h2>
            
            <!-- Product Creation Form -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <form id="create-product-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                        <input type="text" id="product-name" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Purchase Price (‚Çπ)</label>
                        <input type="number" id="product-purchase-price" class="w-full p-2 border border-gray-300 rounded-lg" step="0.01" min="0.01" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Selling Price (‚Çπ)</label>
                        <input type="number" id="product-selling-price" class="w-full p-2 border border-gray-300 rounded-lg" step="0.01" min="0.01" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Unit Type</label>
                        <select id="product-unit-type" class="w-full p-2 border border-gray-300 rounded-lg" required>
                            <option value="">Select Unit Type</option>
                            <option value="kgs">Kilograms (kgs)</option>
                            <option value="ltr">Liters (ltr)</option>
                            <option value="pcs">Pieces (pcs)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Initial Stock</label>
                        <input type="number" id="product-stock" class="w-full p-2 border border-gray-300 rounded-lg" min="0" value="0">
                    </div>
                    <button type="submit" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        Create Product
                    </button>
                </form>
            </div>

            <!-- Existing Products -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Existing Products</h3>
                <div id="existing-products" class="space-y-3">
                    <!-- Existing products will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Delete Product Content Page -->
    <div id="page-delete-product" class="page delete-bg">
        <main class="w-full max-w-4xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Delete Product</h2>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">All Products</h3>
                    <button onclick="loadDeleteProductPage()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                        Refresh Products
                    </button>
                </div>
                
                <!-- Warning Message -->
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">Warning</h3>
                            <div class="mt-2 text-sm text-red-700">
                                <p>Deleting a product will permanently remove it from your inventory. This action cannot be undone and will affect all related sales and purchase records.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="delete-product-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading products...</p>
                </div>

                <!-- Error State -->
                <div id="delete-product-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading products</p>
                </div>

                <!-- Products List for Deletion -->
                <div id="delete-product-content" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product ID</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product Name</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Price (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Current Stock</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Last Updated</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="delete-product-table-body">
                                <!-- Products will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- UPDATED: All Products Stock Ledger Page with Filters -->
    <div id="page-all-products-ledger" class="page stock-bg">
        <main class="w-full max-w-6xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">All Products Stock</h2>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">Complete Stock Overview</h3>
                    <div class="flex gap-2">
                        <button onclick="downloadData('stock')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            üì• Download Stock Data
                        </button>
                        <button onclick="loadAllProductsLedger()" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors">
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                        <input type="date" id="stock-date-from" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Leave empty to show current stock">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                        <input type="date" id="stock-date-to" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Select date to see stock as of that date">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Product</label>
                        <select id="stock-product-filter" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">All Products</option>
                        </select>
                    </div>
                </div>
                <div class="text-sm text-gray-600 mb-4 p-3 bg-blue-50 rounded-lg">
                    <strong>How it works:</strong>
                    <ul class="mt-1 list-disc list-inside">
                        <li>Leave dates empty to see current stock levels in your shop</li>
                        <li>Use "Date To" to see what stock you had as of that date (historical view)</li>
                        <li>All prices shown are purchase prices for inventory valuation</li>
                    </ul>
                </div>
                <div class="flex justify-end mb-4">
                    <button onclick="applyStockFilters()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        Apply Filters
                    </button>
                    <button onclick="clearStockFiltersAndReload()" class="ml-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Clear
                    </button>
                </div>

                <!-- Loading State -->
                <div id="all-products-ledger-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading all products stock data...</p>
                </div>

                <!-- Error State -->
                <div id="all-products-ledger-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading products stock data</p>
                </div>

                <!-- All Products Stock Content -->
                <div id="all-products-ledger-content" class="hidden">
                    <!-- Summary Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600" id="total-products">0</div>
                            <div class="text-sm text-gray-600">Total Products</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600" id="total-stock">0</div>
                            <div class="text-sm text-gray-600">Total Stock</div>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-orange-600" id="low-stock-count">0</div>
                            <div class="text-sm text-gray-600">Low Stock Items</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600" id="out-of-stock-count">0</div>
                            <div class="text-sm text-gray-600">Out of Stock</div>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-indigo-600" id="total-stock-value">‚Çπ0.00</div>
                            <div class="text-sm text-gray-600">Total Stock Value</div>
                        </div>
                    </div>

                    <!-- Products Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product Name</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Current Stock</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Price (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Stock Value (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Last Updated</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Status</th>
                                </tr>
                            </thead>
                            <tbody id="all-products-ledger-table-body">
                                <!-- Products will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Sales Ledger Page -->
    <div id="page-sales-ledger" class="page sales-ledger-bg">
        <main class="w-full max-w-6xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Sales Ledger</h2>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">All Sales Records</h3>
                    <div class="flex gap-2">
                        <button onclick="downloadData('sales')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            üì• Download Sales Data
                        </button>
                        <button onclick="loadSalesLedger()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                        <input type="date" id="sales-date-from" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                        <input type="date" id="sales-date-to" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product</label>
                        <select id="sales-product-filter" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">All Products</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end mb-4">
                    <button onclick="applySalesFilters()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        Apply Filters
                    </button>
                    <button onclick="clearSalesFilters()" class="ml-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Clear
                    </button>
                </div>
                
                <!-- Loading State -->
                <div id="sales-ledger-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading sales records...</p>
                </div>

                <!-- Error State -->
                <div id="sales-ledger-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading sales records</p>
                </div>

                <!-- Sales Records Table -->
                <div id="sales-ledger-content" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Date & Time</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">ID</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Units</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Price (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Total Amount (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sales-ledger-table-body">
                                <!-- Sales records will be populated here -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-50 font-bold">
                                    <td colspan="5" class="border border-gray-200 px-4 py-2 text-right">Total:</td>
                                    <td class="border border-gray-200 px-4 py-2 text-green-600" id="sales-total-amount">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Purchase Ledger Page -->
    <div id="page-purchase-ledger" class="page purchase-ledger-bg">
        <main class="w-full max-w-6xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Purchase Ledger</h2>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">All Purchase Records</h3>
                    <div class="flex gap-2">
                        <button onclick="downloadData('purchase')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            üì• Download Purchase Data
                        </button>
                        <button onclick="loadPurchaseLedger()" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors">
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                        <input type="date" id="purchase-date-from" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                        <input type="date" id="purchase-date-to" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product</label>
                        <select id="purchase-product-filter" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">All Products</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end mb-4">
                    <button onclick="applyPurchaseFilters()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        Apply Filters
                    </button>
                    <button onclick="clearPurchaseFilters()" class="ml-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Clear
                    </button>
                </div>
                
                <!-- Loading State -->
                <div id="purchase-ledger-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading purchase records...</p>
                </div>

                <!-- Error State -->
                <div id="purchase-ledger-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading purchase records</p>
                </div>

                <!-- Purchase Records Table -->
                <div id="purchase-ledger-content" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Date & Time</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">ID</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Units</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Unit Cost (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Total Cost (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="purchase-ledger-table-body">
                                <!-- Purchase records will be populated here -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-50 font-bold">
                                    <td colspan="5" class="border border-gray-200 px-4 py-2 text-right">Total:</td>
                                    <td class="border border-gray-200 px-4 py-2 text-green-600" id="purchase-total-cost">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Profit & Loss Page -->
    <div id="page-profit-loss" class="page" style="background: linear-gradient(rgba(16, 185, 129, 0.85), rgba(245, 158, 11, 0.438)); background-size: cover; background-position: center; min-height: 100vh;">
        <main class="w-full max-w-6xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Profit & Loss Analysis</h2>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">Financial Overview</h3>
                    <div class="flex gap-2">
                        <button onclick="downloadData('profit-loss')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            üì• Download P&L Data
                        </button>
                        <button onclick="loadProfitLossData()" class="px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition-colors">
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                        <input type="date" id="pl-date-from" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                        <input type="date" id="pl-date-to" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Product</label>
                        <select id="pl-product-filter" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">All Products</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end mb-4">
                    <button onclick="applyProfitLossFilters()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        Apply Filters
                    </button>
                    <button onclick="clearProfitLossFilters()" class="ml-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Clear
                    </button>
                </div>

                <!-- Loading State -->
                <div id="profit-loss-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading profit & loss data...</p>
                </div>

                <!-- Error State -->
                <div id="profit-loss-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading profit & loss data</p>
                </div>

                <!-- Profit & Loss Content -->
                <div id="profit-loss-content" class="hidden">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600" id="total-sales">‚Çπ0.00</div>
                            <div class="text-sm text-gray-600">Total Sales</div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-red-600" id="total-purchases">‚Çπ0.00</div>
                            <div class="text-sm text-gray-600">Total Purchases</div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600" id="gross-profit">‚Çπ0.00</div>
                            <div class="text-sm text-gray-600">Gross Profit</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600" id="profit-margin">0%</div>
                            <div class="text-sm text-gray-600">Profit Margin</div>
                        </div>
                    </div>

                    <!-- Overall Status -->
                    <div class="mb-6 p-4 rounded-lg" id="overall-status">
                        <!-- Status will be populated by JavaScript -->
                    </div>

                    <!-- Product-wise Breakdown Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Units Sold</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Opening Stock (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Purchase (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Sales (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Closing Stock (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Gross Profit (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Margin (%)</th>
                                </tr>
                            </thead>
                            <tbody id="profit-loss-table-body">
                                <!-- Product-wise data will be populated here -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-50 font-bold">
                                    <td colspan="2" class="border border-gray-200 px-4 py-2 text-right">Total:</td>
                                    <td class="border border-gray-200 px-4 py-2 text-gray-600" id="total-opening-stock-footer">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2 text-blue-600" id="total-purchases-footer">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2 text-green-600" id="total-sales-footer">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2 text-purple-600" id="total-closing-stock-footer">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2 text-blue-600" id="total-profit-footer">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2 text-purple-600" id="total-margin-footer">0%</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Opening Stock Page -->
    <div id="page-opening-stock" class="page" style="background: linear-gradient(rgba(255, 193, 7, 0.85), rgba(255, 152, 0, 0.438)); background-size: cover; background-position: center; min-height: 100vh;">
        <main class="w-full max-w-6xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Opening Stock Register</h2>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">All Created Products</h3>
                    <button onclick="loadOpeningStockData()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors">
                        Refresh
                    </button>
                </div>

                <!-- Loading State -->
                <div id="opening-stock-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading opening stock register...</p>
                </div>

                <!-- Error State -->
                <div id="opening-stock-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading opening stock data</p>
                </div>

                <!-- Opening Stock Content -->
                <div id="opening-stock-content" class="hidden">
                    <!-- Summary Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600" id="total-opening-products">0</div>
                            <div class="text-sm text-gray-600">Total Products</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600" id="total-opening-stock">0</div>
                            <div class="text-sm text-gray-600">Total Stock</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600" id="total-opening-value">‚Çπ0.00</div>
                            <div class="text-sm text-gray-600">Total Stock Value</div>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-orange-600" id="avg-stock-age">0 days</div>
                            <div class="text-sm text-gray-600">Avg Stock Age</div>
                        </div>
                    </div>

                    <!-- Products Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product ID</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product Name</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Unit Type</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Initial Stock</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Purchase Price (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Selling Price (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Stock Value (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Created Date</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Status</th>
                                </tr>
                            </thead>
                            <tbody id="opening-stock-table-body">
                                <!-- Products will be populated here -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-50 font-bold">
                                    <td colspan="3" class="border border-gray-200 px-4 py-2 text-right">Total:</td>
                                    <td class="border border-gray-200 px-4 py-2 text-green-600" id="total-initial-stock-footer">0</td>
                                    <td class="border border-gray-200 px-4 py-2" colspan="2"></td>
                                    <td class="border border-gray-200 px-4 py-2 text-blue-600" id="total-stock-value-footer">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2" colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Settings Page -->
    <div id="page-settings" class="page" style="background: linear-gradient(rgba(147, 51, 234, 0.85), rgba(59, 130, 246, 0.438)); background-size: cover; background-position: center; min-height: 100vh;">
        <main class="w-full max-w-6xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Settings</h2>

            <!-- Store Information -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Store Information</h3>
                    <button id="save-store-details-btn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                        üíæ Save Changes
                    </button>
                </div>
                <div id="store-details-form" class="space-y-4 hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Store Name</label>
                        <input type="text" id="store-name" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., Raza Wholesale and Retail">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Store Subtitle</label>
                        <input type="text" id="store-subtitle" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., Kirana Store">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                        <input type="text" id="store-location" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., Tolichowki, Hyderabad">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contact Number</label>
                        <input type="text" id="store-contact" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., +91 7075210801">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Note</label>
                        <input type="text" id="store-delivery-note" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., Order on WhatsApp - We deliver to your doorstep">
                    </div>
                    <div class="flex gap-2">
                        <button id="confirm-save-store-btn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
                            Confirm Save
                        </button>
                        <button id="cancel-save-store-btn" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>

                <!-- Display Mode -->
                <div id="store-details-display" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Store Name</label>
                        <p class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100" id="display-store-name">Raza Wholesale and Retail</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Store Subtitle</label>
                        <p class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100" id="display-store-subtitle">Kirana Store</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                        <p class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100" id="display-store-location">Tolichowki, Hyderabad</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contact Number</label>
                        <p class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100" id="display-store-contact">+91 7075210801</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Note</label>
                        <p class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100" id="display-delivery-note">Order on WhatsApp - We deliver to your doorstep</p>
                    </div>
                </div>
            </div>

            <!-- User Management - Only for Admin (raza123) -->
            <div id="admin-section" class="hidden">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-lg font-semibold mb-4">üëë Admin User Management</h3>

                    <!-- User Management Buttons -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <button id="create-user-btn" class="p-4 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center">
                            ‚ûï Create New User
                        </button>
                        <button id="edit-users-btn" class="p-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center">
                            ‚úèÔ∏è Edit Users
                        </button>
                        <button id="delete-users-btn" class="p-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center">
                            üóëÔ∏è Delete Users
                        </button>
                    </div>

                    <!-- User Creation Form (Hidden by default) -->
                    <div id="create-user-form" class="hidden">
                        <h4 class="text-md font-semibold mb-3">Create New User</h4>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <input type="text" id="new-user-username" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Enter username">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input type="password" id="new-user-password" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Enter password">
                            </div>
                            <div class="flex gap-2">
                                <button id="confirm-create-user-btn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
                                    Create User
                                </button>
                                <button id="cancel-create-user-btn" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Users Section -->
                    <div id="edit-users-section" class="hidden">
                        <h4 class="text-md font-semibold mb-3">Edit User Permissions</h4>

                        <!-- Loading State -->
                        <div id="edit-users-loading" class="text-center py-4">
                            <p class="text-gray-500">Loading users...</p>
                        </div>

                        <!-- Error State -->
                        <div id="edit-users-error" class="text-center py-4 hidden">
                            <p class="text-red-500">Error loading users</p>
                        </div>

                        <!-- Users List -->
                        <div id="edit-users-content" class="hidden">
                            <div class="space-y-4" id="edit-users-list">
                                <!-- Users will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Delete Users Section -->
                    <div id="delete-users-section" class="hidden">
                        <h4 class="text-md font-semibold mb-3">Delete Users</h4>

                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-red-800">Warning</h3>
                                    <div class="mt-2 text-sm text-red-700">
                                        <p>Deleting a user will permanently remove their account and all associated data. This action cannot be undone.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Loading State -->
                        <div id="delete-users-loading" class="text-center py-4">
                            <p class="text-gray-500">Loading users...</p>
                        </div>

                        <!-- Error State -->
                        <div id="delete-users-error" class="text-center py-4 hidden">
                            <p class="text-red-500">Error loading users</p>
                        </div>

                        <!-- Users List -->
                        <div id="delete-users-content" class="hidden">
                            <div class="space-y-3" id="delete-users-list">
                                <!-- Users will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Non-Admin Message -->
            <div id="non-admin-section" class="bg-white p-6 rounded-lg shadow-lg hidden">
                <h3 class="text-lg font-semibold mb-4">Settings</h3>
                <p class="text-gray-600 mb-4">You have limited access to settings based on your user permissions.</p>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-blue-800">Only administrators can manage users and modify store information.</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ===== BACKEND CONFIGURATION =====
        const backendURL = `https://kirana-store-backend-production.up.railway.app`;
        const WHATSAPP_NUMBER = "917075210801";

        // Global variables
        let products = [];
        let cart = {};
        let allSalesData = [];
        let allPurchasesData = [];
        let pages = {};
        let backButton = null;
        let currentUser = null;

        // ===== UTILITY FUNCTIONS =====
        function getAuthHeaders() {
            const token = localStorage.getItem('authToken');
            return {
                'Content-Type': 'application/json',
                'ngrok-skip-browser-warning': 'true',
                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            };
        }

        function showRegistrationForm() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
            document.getElementById('show-register-btn').classList.add('hidden');
        }

        function hideRegistrationForm() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('show-register-btn').classList.remove('hidden');
        }

        async function handleLogin(e) {
            e.preventDefault();

            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;

            // Basic validation
            if (!username || !password) {
                showNotification('‚ùå Please enter both username and password');
                return;
            }

            const submitBtn = document.getElementById('login-submit-btn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Signing In...';
            submitBtn.disabled = true;

            try {
                console.log('üîê Attempting to login user:', username);

                const response = await fetch(`${backendURL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                console.log(`üìä Login response status: ${response.status}`);

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Login successful:', result);

                    // Store token and user info
                    localStorage.setItem('authToken', result.access_token);
                    localStorage.setItem('currentUser', JSON.stringify(result.user));
                    currentUser = result.user;

                    showNotification(`‚úÖ Welcome back, ${result.user.username}!`);

                    // Clear login form
                    document.getElementById('login-username').value = '';
                    document.getElementById('login-password').value = '';

                    // Hide login page and show main app
                    document.getElementById('page-login').classList.remove('active');
                    document.getElementById('page-homes').classList.add('active');

                    // Show user controls in header
                    showUserControls(result.user);

                    // Load home page buttons based on user permissions
                    loadHomePageButtons();

                } else {
                    let errorMessage = 'Login failed';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorData.message || errorMessage;
                    } catch (parseError) {
                        errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    }

                    console.error('‚ùå Login failed:', errorMessage);
                    showNotification(`‚ùå ${errorMessage}`);
                }

            } catch (error) {
                console.error('‚ùå Network error during login:', error);
                showNotification('‚ùå Network error. Please check your connection and try again.');
            } finally {
                // Reset button
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        function showUserControls(user) {
            const userControls = document.getElementById('user-controls');
            const welcomeMessage = document.getElementById('welcome-message');

            if (userControls && welcomeMessage) {
                welcomeMessage.textContent = `Welcome, ${user.username}!`;
                userControls.classList.remove('hidden');
            }
        }

        function logout() {
            // Clear stored data
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            currentUser = null;

            // Hide user controls
            document.getElementById('user-controls').classList.add('hidden');

            // Show login page
            document.getElementById('page-homes').classList.remove('active');
            document.getElementById('page-login').classList.add('active');

            showNotification('üëã Logged out successfully!');
        }

        async function handleRegistration(e) {
            e.preventDefault();

            const username = document.getElementById('register-username').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;

            // Basic validation
            if (!username || !email || !password || !confirmPassword) {
                showNotification('‚ùå Please fill in all fields');
                return;
            }

            if (password !== confirmPassword) {
                showNotification('‚ùå Passwords do not match');
                return;
            }

            if (password.length < 6) {
                showNotification('‚ùå Password must be at least 6 characters long');
                return;
            }

            try {
                console.log('üìù Attempting to register user:', username);

                const response = await fetch(`${backendURL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                console.log(`üìä Registration response status: ${response.status}`);

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ User registered successfully:', result);

                    showNotification('‚úÖ Registration successful! Please login with your credentials.');

                    // Clear form
                    document.getElementById('register-username').value = '';
                    document.getElementById('register-email').value = '';
                    document.getElementById('register-password').value = '';
                    document.getElementById('register-confirm-password').value = '';

                    // Switch back to login form
                    hideRegistrationForm();

                } else {
                    let errorMessage = 'Registration failed';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorData.message || errorMessage;
                    } catch (parseError) {
                        errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    }

                    console.error('‚ùå Registration failed:', errorMessage);
                    showNotification(`‚ùå ${errorMessage}`);
                }

            } catch (error) {
                console.error('‚ùå Network error during registration:', error);
                showNotification('‚ùå Network error. Please check your connection and try again.');
            }
        }

        function formatDateTime(dateString) {
            if (!dateString) {
                return { date: 'N/A', time: 'N/A', full: 'N/A' };
            }

            try {
                const dateObj = new Date(dateString);

                if (isNaN(dateObj.getTime())) {
                    console.warn('Invalid date:', dateString);
                    return { date: 'Invalid Date', time: 'Invalid Date', full: 'Invalid Date' };
                }

                const day = dateObj.getDate().toString().padStart(2, '0');
                const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                const year = dateObj.getFullYear().toString().slice(-2);

                const hours = dateObj.getHours().toString().padStart(2, '0');
                const minutes = dateObj.getMinutes().toString().padStart(2, '0');

                return {
                    date: `${day}/${month}/${year}`,
                    time: `${hours}:${minutes}`,
                    full: `${day}/${month}/${year} ${hours}:${minutes}`
                };
            } catch (error) {
                console.error('Error formatting date:', error, dateString);
                return { date: 'Error', time: 'Error', full: 'Error' };
            }
        }

        function getUnitDisplay(unitType, quantity) {
            if (!unitType) {
                return `${quantity} pcs`;
            }

            const normalizedUnitType = unitType.toLowerCase().trim();

            switch(normalizedUnitType) {
                case 'kgs':
                case 'kg':
                case 'kilograms':
                    return `${quantity} kgs`;
                case 'ltr':
                case 'liter':
                case 'liters':
                case 'litre':
                case 'litres':
                    return `${quantity} ltr`;
                case 'pcs':
                case 'piece':
                case 'pieces':
                case 'pc':
                    return `${quantity} pcs`;
                default:
                    return `${quantity} ${unitType}`;
            }
        }

        function showNotification(message) {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) existingNotification.remove();

            const notification = document.createElement('div');
            notification.className = 'notification fixed top-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg z-50';
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ===== NAVIGATION FUNCTIONS =====
        function showContentPage(pageName) {
            // Remove active class from all pages (with null check)
            Object.values(pages).forEach(page => {
                if (page) page.classList.remove('active');
            });

            // Add active class to target page (with null check)
            if (pages[pageName]) {
                pages[pageName].classList.add('active');
            } else {
                console.error(`Page '${pageName}' not found in pages object`);
                return;
            }

            // Show back button (with null check)
            if (backButton) {
                backButton.classList.remove('hidden');
            }

            loadPageData(pageName);
        }

function backToHome() {
    console.log('üîÑ backToHome called');
    console.log('üìÑ Available pages:', Object.keys(pages));

    // Remove active class from all pages (with null check)
    Object.values(pages).forEach(page => {
        if (page && page.classList) {
            page.classList.remove('active');
            console.log('üö´ Removed active from page:', page.id);
        }
    });

    // Add active class to homes page (with null check)
    if (pages.homes && pages.homes.classList) {
        pages.homes.classList.add('active');
        console.log('‚úÖ Added active to homes page:', pages.homes.id);
        backButton.classList.add('hidden');

        // Load home page buttons based on user permissions
        loadHomePageButtons();
    } else {
        console.error('‚ùå Homes page not found in pages object');
    }
}

        function loadPageData(pageName) {
            switch(pageName) {
                case 'sales':
                    fetchProducts();
                    break;
                case 'purchase':
                    loadPurchasePage();
                    break;
                case 'create':
                    loadCreatePage();
                    break;
                case 'delete-product':
                    loadDeleteProductPage();
                    break;
                case 'all-products-ledger':
                    loadAllProductsLedger();
                    break;
                case 'sales-ledger':
                    loadSalesLedger();
                    break;
                case 'purchase-ledger':
                    loadPurchaseLedger();
                    break;
                case 'profit-loss':
                    loadProfitLossData();
                    break;
                case 'opening-stock':
                    loadOpeningStockData();
                    break;
            }
        }

        // ===== SALES PAGE FUNCTIONS =====
        async function fetchProducts() {
            console.log(`üîç Fetching from: ${backendURL}/products`);

            try {
                const response = await fetch(`${backendURL}/products`, {
                    headers: getAuthHeaders()
                });

                console.log(`üìä Status: ${response.status}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                products = await response.json();
                console.log("‚úÖ Products fetched:", products.length, "items");

                if (!Array.isArray(products) || products.length === 0) {
                    throw new Error("No products received");
                }

                renderProducts();
                showCartButton();

            } catch (error) {
                console.error("üí• Fetch error:", error);
                loadMockProducts();
            }
        }

        function loadMockProducts() {
            console.log('üîÑ Loading mock products');
            products = [
                {id: 1, name: "Apple", price: 100.00, stock: 5, unit_type: "kgs"},
                {id: 2, name: "Banana", price: 50.00, stock: 0, unit_type: "kgs"},
                {id: 3, name: "Orange", price: 80.00, stock: 3, unit_type: "kgs"},
                {id: 4, name: "Milk", price: 65.00, stock: 10, unit_type: "ltr"},
                {id: 5, name: "Bread", price: 40.00, stock: 0, unit_type: "pcs"},
                {id: 6, name: "Eggs", price: 90.00, stock: 12, unit_type: "pcs"},
            ];
            renderProducts();
            showCartButton();
        }

        function generateProductImage(productName) {
            if (!productName) return 'https://picsum.photos/400/400?random=product';

            const cleanName = productName.toLowerCase()
                .trim()
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, '+')
                .substring(0, 50);

            return `https://loremflickr.com/400/400/${cleanName}`;
        }

        function renderProducts() {
            const productListEl = document.getElementById('product-list');
            if (!products || products.length === 0) {
                productListEl.innerHTML = '<p class="text-center text-gray-500">No products available</p>';
                return;
            }

            productListEl.innerHTML = products.map(product => {
                const isOutOfStock = product.stock <= 0;
                const buttonClass = isOutOfStock
                    ? "w-full bg-gray-400 text-white text-xs font-bold py-2 px-3 rounded-lg cursor-not-allowed"
                    : "w-full bg-blue-500 text-white text-xs font-bold py-2 px-3 rounded-lg hover:bg-blue-600 transition-colors duration-300";
                const buttonText = isOutOfStock ? "Out of Stock" : "Add to Cart";
                const unitDisplay = getUnitDisplay(product.unit_type || 'pcs', product.stock || 0);

                const imageUrl = generateProductImage(product.name);

                return `
                    <div class="bg-white p-4 rounded-xl shadow-lg transition-transform transform hover:scale-105 ${isOutOfStock ? 'opacity-70' : ''}">
                        <img src="${imageUrl}" alt="${product.name}"
                             class="w-full h-28 object-cover rounded-md mb-2"
                             onerror="this.src='https://picsum.photos/400/400?random=grocery'">
                        <h4 class="text-sm font-semibold text-gray-700">${product.name}</h4>
                        <p class="text-lg font-bold text-gray-800 my-1">‚Çπ${product.price.toFixed(2)}</p>
                        <div class="flex justify-between items-center text-xs text-gray-500 mb-2">
                            <span>Stock: ${unitDisplay}</span>
                            ${isOutOfStock ? '<span class="text-red-500 font-bold">Out of Stock</span>' : ''}
                        </div>
                        <button class="add-to-cart-btn mt-2 ${buttonClass}"
                                data-id="${product.id}"
                                ${isOutOfStock ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function showCartButton() {
            const existingButton = document.querySelector('.view-cart-button');
            if (existingButton) existingButton.remove();
            
            const cartButton = document.createElement('button');
            cartButton.className = 'view-cart-button fixed bottom-4 right-4 bg-blue-500 text-white p-4 rounded-full shadow-lg hover:bg-blue-600 transition-colors z-10';
            cartButton.innerHTML = 'üõí View Cart';
            cartButton.onclick = () => {
                document.getElementById('cart-modal').classList.remove('hidden');
                document.getElementById('cart-modal').classList.add('flex');
            };
            
            document.getElementById('page-sales').appendChild(cartButton);
        }

        function updateCartUI() {
            const cartItemsEl = document.getElementById('cart-items');
            const cartTotalEl = document.getElementById('cart-total');
            const whatsappCheckoutButtonEl = document.getElementById('whatsapp-checkout-button');
            
            cartItemsEl.innerHTML = '';
            let total = 0;
            let totalCount = 0;

            for (const productId in cart) {
                if (cart[productId] > 0) {
                    const product = products.find(p => p.id === parseInt(productId));
                    if (product) {
                        const quantity = cart[productId];
                        const itemTotal = quantity * product.price;
                        total += itemTotal;
                        totalCount += quantity;

                        const cartItem = document.createElement('div');
                        cartItem.className = "flex justify-between items-center p-3 bg-gray-50 rounded-lg";
                        cartItem.innerHTML = `
                            <div class="flex-1">
                                <div class="font-medium text-gray-800">${product.name}</div>
                                <div class="text-sm text-gray-600">‚Çπ${product.price.toFixed(2)} each</div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="decrease-quantity w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors" 
                                        data-id="${product.id}">
                                    -
                                </button>
                                <span class="quantity-display w-8 text-center font-medium">${quantity}</span>
                                <button class="increase-quantity w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center hover:bg-green-600 transition-colors" 
                                        data-id="${product.id}">
                                    +
                                </button>
                            </div>
                            <div class="text-right ml-4">
                                <div class="font-medium text-gray-800">‚Çπ${itemTotal.toFixed(2)}</div>
                                <button class="remove-item text-xs text-red-500 hover:text-red-700 mt-1" data-id="${product.id}">
                                    Remove
                                </button>
                            </div>
                        `;
                        cartItemsEl.appendChild(cartItem);
                    }
                }
            }

            cartTotalEl.textContent = `‚Çπ${total.toFixed(2)}`;
            whatsappCheckoutButtonEl.disabled = totalCount === 0;
            whatsappCheckoutButtonEl.className = totalCount === 0 
                ? "w-full mt-4 bg-gray-400 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed"
                : "w-full mt-4 bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-green-600 transition-colors duration-300";
        }

        function addToCart(productId) {
            // Input validation
            if (!productId || isNaN(parseInt(productId))) {
                showNotification("Invalid product selection!");
                return;
            }

            if (!products || products.length === 0) {
                showNotification("No products available!");
                return;
            }

            const product = products.find(p => p.id === parseInt(productId));

            if (!product) {
                showNotification("Product not found!");
                return;
            }

            if (!product.name || product.name.trim() === '') {
                showNotification("Invalid product data!");
                return;
            }

            if (product.stock === undefined || product.stock === null || product.stock <= 0) {
                showNotification(`Sorry, ${product.name} is out of stock!`);
                return;
            }

            const currentCartQuantity = cart[productId] || 0;
            if (currentCartQuantity + 1 > product.stock) {
                showNotification(`Sorry, only ${product.stock} units of ${product.name} are available!`);
                return;
            }

            cart[productId] = currentCartQuantity + 1;
            updateCartUI();
            showNotification(`Added ${product.name} to cart!`);
        }

        function increaseQuantity(productId) {
            // Input validation
            if (!productId || isNaN(parseInt(productId))) {
                showNotification("Invalid product selection!");
                return;
            }

            if (!cart[productId] || cart[productId] <= 0) {
                showNotification("Item not in cart!");
                return;
            }

            if (!products || products.length === 0) {
                showNotification("No products available!");
                return;
            }

            const product = products.find(p => p.id === parseInt(productId));

            if (!product) {
                showNotification("Product not found!");
                return;
            }

            if (!product.name || product.name.trim() === '') {
                showNotification("Invalid product data!");
                return;
            }

            if (product.stock === undefined || product.stock === null) {
                showNotification("Invalid stock information!");
                return;
            }

            const currentCartQuantity = cart[productId] || 0;
            if (currentCartQuantity + 1 > product.stock) {
                showNotification(`Sorry, only ${product.stock} units of ${product.name} are available!`);
                return;
            }

            cart[productId] = currentCartQuantity + 1;
            updateCartUI();
        }

        function decreaseQuantity(productId) {
            // Input validation
            if (!productId || isNaN(parseInt(productId))) {
                showNotification("Invalid product selection!");
                return;
            }

            if (!cart[productId] || cart[productId] <= 0) {
                showNotification("Item not in cart!");
                return;
            }

            if (cart[productId] <= 1) {
                showNotification("Cannot decrease quantity below 1. Use remove button instead!");
                return;
            }

            cart[productId] -= 1;
            updateCartUI();
        }

        function removeFromCart(productId) {
            // Input validation
            if (!productId || isNaN(parseInt(productId))) {
                showNotification("Invalid product selection!");
                return;
            }

            if (!cart[productId] || cart[productId] <= 0) {
                showNotification("Item not in cart!");
                return;
            }

            delete cart[productId];
            updateCartUI();
            showNotification("Item removed from cart!");
        }

        async function recordSale(saleItems) {
            console.log('üì¶ Recording sale items:', saleItems);
            
            try {
                for (const item of saleItems) {
                const response = await fetch(`${backendURL}/sales/`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        product_id: item.product_id,
                        quantity: item.quantity
                    })
                });

                    console.log(`üìä Response for product ${item.product_id}: ${response.status}`);
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.log(`‚ùå Failed for product ${item.product_id}:`, errorData);
                        throw new Error(`Failed to record sale for ${item.product_name}`);
                    }
                    
                    const result = await response.json();
                    console.log(`‚úÖ Sale recorded for ${item.product_name}:`, result);
                }
                
                return { message: "All sales recorded successfully" };
                
            } catch (error) {
                console.error('Error recording sale:', error);
                throw error;
            }
        }

        function generateWhatsAppOrder() {
            // Input validation
            if (!cart || Object.keys(cart).length === 0) {
                showNotification("Cart is empty!");
                return;
            }

            if (!products || products.length === 0) {
                showNotification("No products available!");
                return;
            }

            const phoneNumber = WHATSAPP_NUMBER;
            if (!phoneNumber || phoneNumber.trim() === '') {
                showNotification("WhatsApp number not configured!");
                return;
            }

            let message = "Hi, I would like to place an order:%0a%0a";
            let total = 0;
            const saleItems = [];
            let hasValidItems = false;

            for (const productId in cart) {
                if (cart[productId] > 0) {
                    const product = products.find(p => p.id === parseInt(productId));
                    if (product) {
                        if (!product.name || product.name.trim() === '') {
                            showNotification("Invalid product data found in cart!");
                            return;
                        }

                        const quantity = cart[productId];
                        if (isNaN(quantity) || quantity <= 0) {
                            showNotification("Invalid quantity in cart!");
                            return;
                        }

                        const price = product.price;
                        if (isNaN(price) || price <= 0) {
                            showNotification("Invalid price for product in cart!");
                            return;
                        }

                        const itemTotal = quantity * price;
                        total += itemTotal;
                        message += `‚Ä¢ ${quantity}x ${product.name} - ‚Çπ${itemTotal.toFixed(2)}%0a`;

                        saleItems.push({
                            product_id: product.id,
                            product_name: product.name,
                            quantity: quantity,
                            price: price,
                            total: itemTotal
                        });

                        hasValidItems = true;
                    }
                }
            }

            if (!hasValidItems) {
                showNotification("No valid items in cart!");
                return;
            }

            if (total <= 0) {
                showNotification("Invalid order total!");
                return;
            }

            message += `%0a*Total: ‚Çπ${total.toFixed(2)}*%0a%0aPlease confirm my order. Thank you!`;

            if (saleItems.length > 0) {
                recordSale(saleItems).then(result => {
                    console.log('‚úÖ Sales recorded in database:', result);
                    showNotification('Order recorded successfully!');
                }).catch(error => {
                    console.warn('‚ö†Ô∏è Sale recording failed, but continuing to WhatsApp:', error);
                    showNotification('Order sent to WhatsApp (database recording failed)');
                });
            }

            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');

            cart = {};
            updateCartUI();
            document.getElementById('cart-modal').classList.add('hidden');
            document.getElementById('cart-modal').classList.remove('flex');
        }

        // ===== PURCHASE PAGE FUNCTIONS =====
        async function loadPurchasePage() {
            await loadProductDropdown('purchase-product');
            await loadPurchaseHistory();
        }

        async function loadProductDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) {
                console.error(`Dropdown with ID '${dropdownId}' not found`);
                return;
            }

            try {
                const response = await fetch(`${backendURL}/products`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const products = await response.json();
                    dropdown.innerHTML = '<option value="">Select Product</option>';
                    products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.name} (${product.unit_type}) - Stock: ${product.stock || 0}`;
                        option.dataset.purchasePrice = product.purchase_price;
                        option.dataset.sellingPrice = product.selling_price;
                        option.dataset.unitType = product.unit_type;
                        dropdown.appendChild(option);
                    });
                    console.log(`‚úÖ Loaded ${products.length} products into dropdown`);
                } else {
                    throw new Error('Failed to fetch products');
                }
            } catch (error) {
                console.error('Error loading products for dropdown:', error);
                dropdown.innerHTML = '<option value="">Error loading products</option>';
            }
        }

        async function loadPurchaseHistory() {
            const historyEl = document.getElementById('purchase-history');
            historyEl.innerHTML = '<p class="text-gray-500 text-center">Loading purchase history...</p>';

            try {
                const response = await fetch(`${backendURL}/ledger/purchases`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) throw new Error('Failed to fetch products');

                const products = await response.json();

                if (products.length === 0) {
                    historyEl.innerHTML = '<p class="text-gray-500 text-center">No purchase history found</p>';
                    return;
                }

                historyEl.innerHTML = products.map(purchase => {
                    const formatted = formatDateTime(purchase.date);
                    return `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg mb-2">
                            <div class="flex-1">
                                <div class="font-medium">${purchase.product_name}</div>
                                <div class="text-sm text-gray-500">${formatted.date}</div>
                                <div class="text-xs text-gray-400">${formatted.time}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-medium">${purchase.quantity} units</div>
                                <div class="text-sm text-green-600">‚Çπ${purchase.total_cost.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading purchase history:', error);
                historyEl.innerHTML = '<p class="text-red-500 text-center">Error loading purchase history</p>';
            }
        }

        // ===== CREATE PRODUCT PAGE FUNCTIONS =====
        async function loadCreatePage() {
            await loadExistingProducts();
        }

        async function loadExistingProducts() {
            const productsEl = document.getElementById('existing-products');
            productsEl.innerHTML = '<p class="text-gray-500 text-center">Loading products...</p>';

            try {
                const response = await fetch(`${backendURL}/products`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Failed to fetch products');

                const products = await response.json();

                if (products.length === 0) {
                    productsEl.innerHTML = '<p class="text-gray-500 text-center">No products found. Create your first product!</p>';
                    return;
                }

                productsEl.innerHTML = products.map(product => {
                    const unitDisplay = getUnitDisplay(product.unit_type || 'pcs', product.stock || 0);
                    return `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <div>
                                <div class="font-medium">${product.name}</div>
                                <div class="text-sm text-gray-500">Stock: ${unitDisplay}</div>
                                <div class="text-xs text-gray-400">Type: ${product.unit_type || 'pcs'}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-medium">Buy: ‚Çπ${product.purchase_price?.toFixed(2) || '0.00'}</div>
                                <div class="text-sm text-green-600">Sell: ‚Çπ${product.selling_price?.toFixed(2) || '0.00'}</div>
                                <div class="text-xs text-gray-500">ID: ${product.id}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading products:', error);
                productsEl.innerHTML = '<p class="text-red-500 text-center">Error loading products</p>';
            }
        }

        async function createProduct(productData) {
            console.log('‚ûï Creating product:', productData);

            try {
                const response = await fetch(`${backendURL}/products/`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(productData)
                });

                console.log(`üìä Response: ${response.status}`);

                if (!response.ok) {
                    let errorMessage = 'Failed to create product';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorData.message || errorMessage;
                    } catch (parseError) {
                        errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log('‚úÖ Product created successfully:', result);
                return result;

            } catch (error) {
                console.error('Error creating product:', error);
                throw error;
            }
        }

        // ===== DELETE PRODUCT PAGE FUNCTIONS =====
        async function loadDeleteProductPage() {
            const loadingEl = document.getElementById('delete-product-loading');
            const errorEl = document.getElementById('delete-product-error');
            const contentEl = document.getElementById('delete-product-content');
            
            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            contentEl.classList.add('hidden');
            
            try {
                const response = await fetch(`${backendURL}/products`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch products');
                
                const products = await response.json();
                
                if (!Array.isArray(products) || products.length === 0) {
                    throw new Error('No products found');
                }
                
                displayProductsForDeletion(products);
                
                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading products for deletion:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.innerHTML = `<p class="text-red-500">Error loading products: ${error.message}</p>`;
            }
        }

        function displayProductsForDeletion(products) {
            const tableBodyEl = document.getElementById('delete-product-table-body');

            if (products.length === 0) {
                tableBodyEl.innerHTML = `
                    <tr>
                        <td colspan="6" class="border border-gray-200 px-4 py-4 text-center text-gray-500">
                            No products found
                        </td>
                    </tr>
                `;
                return;
            }

            products.sort((a, b) => a.id - b.id);

            tableBodyEl.innerHTML = products.map(product => {
                const lastUpdated = product.last_updated || product.created_at || product.updated_at;
                const formattedDate = formatDateTime(lastUpdated);
                const unitDisplay = getUnitDisplay(product.unit_type || 'pcs', product.stock || 0);

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-2 font-medium">${product.id}</td>
                        <td class="border border-gray-200 px-4 py-2 font-medium">${product.name}</td>
                        <td class="border border-gray-200 px-4 py-2">‚Çπ${product.selling_price?.toFixed(2) || product.price?.toFixed(2) || '0.00'}</td>
                        <td class="border border-gray-200 px-4 py-2 ${product.stock <= 10 ? 'text-red-600 font-bold' : ''}">${unitDisplay}</td>
                        <td class="border border-gray-200 px-4 py-2 text-sm text-gray-600">${formattedDate.date}<br><span class="text-xs">${formattedDate.time}</span></td>
                        <td class="border border-gray-200 px-4 py-2">
                            <button class="delete-product-btn text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors"
                                    data-id="${product.id}" data-name="${product.name}">
                                Delete
                            </button>
                        </td>
                        </tr>
                    `;
                }).join('');
        }

        async function deleteProduct(productId, productName) {
            // Input validation
            if (!productId || isNaN(parseInt(productId))) {
                showNotification("Invalid product ID!");
                return;
            }

            if (!productName || productName.trim() === '') {
                showNotification("Invalid product name!");
                return;
            }

            productId = parseInt(productId);
            productName = productName.trim();

            if (!confirm(`Are you sure you want to delete "${productName}"? This action cannot be undone and will remove all associated sales and purchase records.`)) {
                return;
            }

            try {
                const deleteURL = `${backendURL}/products/${productId}`;

                console.log(`üóëÔ∏è Attempting to delete product from: ${deleteURL}`);

                const response = await fetch(deleteURL, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                console.log(`üìä Delete response status: ${response.status}`);

                if (response.ok) {
                    const result = await response.json();
                    showNotification(result.message || `Product "${productName}" deleted successfully!`);

                    await loadDeleteProductPage();
                } else {
                    let errorMessage = `Failed to delete product: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.detail) {
                            errorMessage = errorData.detail;
                        }
                    } catch (e) {
                        errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

            } catch (error) {
                console.error('Error deleting product:', error);
                showNotification(`‚ùå Error deleting product: ${error.message}`);
            }
        }

        async function handleCreateProduct(e) {
            e.preventDefault();

            // Get form values
            const name = document.getElementById('product-name').value.trim();
            const purchasePrice = parseFloat(document.getElementById('product-purchase-price').value);
            const sellingPrice = parseFloat(document.getElementById('product-selling-price').value);
            const unitType = document.getElementById('product-unit-type').value;
            const stock = parseInt(document.getElementById('product-stock').value) || 0;

            // Validation
            if (!name) {
                showNotification('‚ùå Product name is required');
                return;
            }

            if (isNaN(purchasePrice) || purchasePrice < 0.01) {
                showNotification('‚ùå Please enter a valid purchase price (minimum ‚Çπ0.01)');
                return;
            }

            if (isNaN(sellingPrice) || sellingPrice < 0.01) {
                showNotification('‚ùå Please enter a valid selling price (minimum ‚Çπ0.01)');
                return;
            }

            if (!unitType) {
                showNotification('‚ùå Please select a unit type');
                return;
            }

            if (stock < 0) {
                showNotification('‚ùå Initial stock cannot be negative');
                return;
            }

            // Disable submit button to prevent double submission
            const submitBtn = document.getElementById('create-product-form').querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Creating...';
            submitBtn.disabled = true;

            try {
                console.log('‚ûï Creating product:', { name, purchasePrice, sellingPrice, unitType, stock });

                const productData = {
                    name: name,
                    purchase_price: purchasePrice,
                    selling_price: sellingPrice,
                    unit_type: unitType,
                    stock: stock
                };

                const result = await createProduct(productData);

                showNotification(`‚úÖ Product "${name}" created successfully!`);

                // Clear form
                document.getElementById('product-name').value = '';
                document.getElementById('product-purchase-price').value = '';
                document.getElementById('product-selling-price').value = '';
                document.getElementById('product-unit-type').value = '';
                document.getElementById('product-stock').value = '0';

                // Refresh existing products list
                await loadExistingProducts();

            } catch (error) {
                console.error('‚ùå Error creating product:', error);
                showNotification(`‚ùå Failed to create product: ${error.message}`);
            } finally {
                // Reset button
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        async function handlePurchase(e) {
            e.preventDefault();

            const productId = document.getElementById('purchase-product').value;
            const quantity = parseInt(document.getElementById('purchase-quantity').value);
            const unitCost = parseFloat(document.getElementById('purchase-unit-cost').value);

            if (!productId) {
                showNotification('‚ùå Please select a product');
                return;
            }

            if (isNaN(quantity) || quantity <= 0) {
                showNotification('‚ùå Please enter a valid quantity (minimum 1)');
                return;
            }

            if (isNaN(unitCost) || unitCost < 0.01) {
                showNotification('‚ùå Please ensure unit cost is set correctly');
                return;
            }

            const submitBtn = document.getElementById('purchase-form').querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Recording...';
            submitBtn.disabled = true;

            try {
                console.log('üì¶ Recording purchase:', { productId, quantity, unitCost });

                const response = await fetch(`${backendURL}/purchases/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({
                        product_id: parseInt(productId),
                        quantity: quantity
                    })
                });

                console.log(`üìä Purchase response: ${response.status}`);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || errorData.message || 'Failed to record purchase');
                }

                const result = await response.json();
                console.log('‚úÖ Purchase recorded:', result);

                showNotification(`‚úÖ Purchase recorded successfully for ${quantity} units!`);

                // Clear form
                document.getElementById('purchase-product').value = '';
                document.getElementById('purchase-quantity').value = '';
                document.getElementById('purchase-unit-cost').value = '';
                document.getElementById('purchase-unit-type').value = '';

                // Refresh purchase history
                await loadPurchaseHistory();

            } catch (error) {
                console.error('‚ùå Error recording purchase:', error);
                showNotification(`‚ùå Failed to record purchase: ${error.message}`);
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        async function deleteSale(saleId) {
            // Input validation
            if (!saleId || isNaN(parseInt(saleId))) {
                showNotification("Invalid sale ID!");
                return;
            }

            saleId = parseInt(saleId);

            if (!confirm("Are you sure you want to delete this sale record? This will restore the product stock by the sold quantity. This action cannot be undone.")) {
                return;
            }

            try {
                const deleteURL = `${backendURL}/sales/${saleId}`;

                console.log(`üõí Attempting to delete sale from: ${deleteURL}`);

                const response = await fetch(deleteURL, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                console.log(`üìä Delete response status: ${response.status}`);

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Sale deleted successfully:', result);
                    showNotification(result.message || `Sale record deleted successfully!`);

                    // Refresh the sales ledger
                    loadSalesLedger();
                } else {
                    let errorMessage = `Failed to delete sale: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.detail) {
                            errorMessage = errorData.detail;
                        }
                    } catch (e) {
                        errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

            } catch (error) {
                console.error('Error deleting sale:', error);
                showNotification(`‚ùå Error deleting sale: ${error.message}`);
            }
        }

        async function deletePurchase(purchaseId) {
            // Input validation
            if (!purchaseId || isNaN(parseInt(purchaseId))) {
                showNotification("Invalid purchase ID!");
                return;
            }

            purchaseId = parseInt(purchaseId);

            if (!confirm("Are you sure you want to delete this purchase record? This will reduce the product stock by the purchased quantity. This action cannot be undone.")) {
                return;
            }

            try {
                const deleteURL = `${backendURL}/purchases/${purchaseId}`;

                console.log(`üõí Attempting to delete purchase from: ${deleteURL}`);

                const response = await fetch(deleteURL, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                console.log(`üìä Delete response status: ${response.status}`);

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Purchase deleted successfully:', result);
                    showNotification(result.message || `Purchase record deleted successfully!`);

                    // Refresh the purchase ledger
                    loadPurchaseLedger();
                } else {
                    let errorMessage = `Failed to delete purchase: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.detail) {
                            errorMessage = errorData.detail;
                        }
                    } catch (e) {
                        errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

            } catch (error) {
                console.error('Error deleting purchase:', error);
                showNotification(`‚ùå Error deleting purchase: ${error.message}`);
            }
        }

        // ===== ALL PRODUCTS STOCK LEDGER FUNCTIONS =====
        async function loadAllProductsLedger() {
            const loadingEl = document.getElementById('all-products-ledger-loading');
            const errorEl = document.getElementById('all-products-ledger-error');
            const contentEl = document.getElementById('all-products-ledger-content');

            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            contentEl.classList.add('hidden');

            try {
                const dateFrom = document.getElementById('stock-date-from').value;
                const dateTo = document.getElementById('stock-date-to').value;
                const productId = document.getElementById('stock-product-filter').value;

                let stockData = [];

                const params = new URLSearchParams();

                if (dateFrom && dateFrom.trim() !== '') {
                    params.append('date_from', dateFrom);
                }
                if (dateTo && dateTo.trim() !== '') {
                    params.append('date_to', dateTo);
                }
                if (productId && productId.trim() !== '') {
                    params.append('product_id', productId);
                }

                const url = `${backendURL}/products/stock-snapshot${params.toString() ? '?' + params.toString() : ''}`;
                console.log(`üìä Fetching from: ${url}`);

                const response = await fetch(url, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    let errorMessage = `Failed to fetch stock data: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.detail) {
                            errorMessage = errorData.detail;
                        }
                    } catch (e) {
                        errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

                stockData = await response.json();

                if (dateTo && dateTo.trim() !== '') {
                    console.log(`‚úÖ Received historical stock data as of ${dateTo}`);
                } else {
                    console.log('‚úÖ Received current stock data');
                }

                console.log(`üìä Retrieved ${stockData.length} stock records`);

                if (!Array.isArray(stockData) || stockData.length === 0) {
                    displayFilteredStockData([]);
                    loadingEl.classList.add('hidden');
                    contentEl.classList.remove('hidden');
                    return;
                }

                await loadProductDropdownForFilter('stock-product-filter');

                displayFilteredStockData(stockData);

                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');

            } catch (error) {
                console.error('Error loading all products ledger:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.innerHTML = `
                    <div class="text-center">
                        <p class="text-red-500 font-semibold">Error loading products stock data</p>
                        <p class="text-gray-600 mt-2">${error.message}</p>
                        <button onclick="clearStockFiltersAndReload()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            Clear Filters & Retry
                        </button>
                    </div>
                `;
            }
        }

        function displayFilteredStockData(stockData) {
            const tableBodyEl = document.getElementById('all-products-ledger-table-body');
            const totalProductsEl = document.getElementById('total-products');
            const totalStockEl = document.getElementById('total-stock');
            const lowStockCountEl = document.getElementById('low-stock-count');
            const outOfStockCountEl = document.getElementById('out-of-stock-count');
            const totalStockValueEl = document.getElementById('total-stock-value');

            if (!stockData || stockData.length === 0) {
                tableBodyEl.innerHTML = `
                    <tr>
                        <td colspan="6" class="border border-gray-200 px-4 py-4 text-center text-gray-500">
                            No stock data found for the selected filters
                        </td>
                    </tr>
                `;
                totalProductsEl.textContent = '0';
                totalStockEl.textContent = '0';
                lowStockCountEl.textContent = '0';
                outOfStockCountEl.textContent = '0';
                totalStockValueEl.textContent = '‚Çπ0.00';
                return;
            }

            let totalProducts = 0;
            let totalStock = 0;
            let lowStockCount = 0;
            let outOfStockCount = 0;
            let totalStockValue = 0;

            tableBodyEl.innerHTML = stockData.map(product => {
                totalProducts++;
                totalStock += product.stock || 0;

                const stockValue = (product.price || 0) * (product.stock || 0);
                totalStockValue += stockValue;

                const lastUpdated = product.last_updated || product.created_at || product.updated_at;
                const formattedDate = formatDateTime(lastUpdated);

                const unitType = product.unit_type || 'pcs';
                const stockDisplay = getUnitDisplay(unitType, product.stock || 0);

                let status = 'In Stock';
                let statusClass = 'bg-green-100 text-green-800';

                if (product.stock === 0) {
                    outOfStockCount++;
                    status = 'Out of Stock';
                    statusClass = 'bg-red-100 text-red-800';
                } else if (product.stock <= 10) {
                    lowStockCount++;
                    status = 'Low Stock';
                    statusClass = 'bg-yellow-100 text-yellow-800';
                }

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-2 font-medium">${product.product_name || product.name}</td>
                        <td class="border border-gray-200 px-4 py-2 ${product.stock <= 10 ? 'text-red-600 font-bold' : ''}">${stockDisplay}</td>
                        <td class="border border-gray-200 px-4 py-2">‚Çπ${(product.price || 0).toFixed(2)}</td>
                        <td class="border border-gray-200 px-4 py-2 font-medium">‚Çπ${stockValue.toFixed(2)}</td>
                        <td class="border border-gray-200 px-4 py-2 text-sm text-gray-600">${formattedDate.date}<br><span class="text-xs">${formattedDate.time}</span></td>
                        <td class="border border-gray-200 px-4 py-2">
                            <span class="text-xs px-2 py-1 rounded-full ${statusClass}">${status}</span>
                        </td>
                    </tr>
                `;
            }).join('');

            totalProductsEl.textContent = totalProducts;
            totalStockEl.textContent = totalStock;
            lowStockCountEl.textContent = lowStockCount;
            outOfStockCountEl.textContent = outOfStockCount;
            totalStockValueEl.textContent = `‚Çπ${totalStockValue.toFixed(2)}`;
        }

        function clearStockFiltersAndReload() {
            document.getElementById('stock-date-from').value = '';
            document.getElementById('stock-date-to').value = '';
            document.getElementById('stock-product-filter').value = '';
            loadAllProductsLedger();
        }

        function applyStockFilters() {
            loadAllProductsLedger();
        }

        function clearStockFilters() {
            clearStockFiltersAndReload();
        }

        // ===== SALES LEDGER FUNCTIONS =====
        async function loadSalesLedger() {
            const loadingEl = document.getElementById('sales-ledger-loading');
            const errorEl = document.getElementById('sales-ledger-error');
            const contentEl = document.getElementById('sales-ledger-content');

            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            contentEl.classList.add('hidden');

            try {
                console.log('üìä Fetching sales ledger from:', `${backendURL}/ledger/sales`);

        const response = await fetch(`${backendURL}/ledger/sales`, {
            headers: getAuthHeaders()
        });

                console.log('üìä Sales response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('üö´ Sales API error:', response.status, errorText);
                    throw new Error(`Server returned ${response.status}: ${errorText}`);
                }

                allSalesData = await response.json();
                console.log('‚úÖ Sales data received:', allSalesData);

                await loadProductDropdownForFilter('sales-product-filter');

                displayFilteredSalesData(allSalesData);

                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');

                // Force display styles as fallback with high specificity
                loadingEl.style.display = 'none !important';
                errorEl.style.display = 'none !important';
                contentEl.style.display = 'block !important';
                contentEl.style.visibility = 'visible !important';
                contentEl.style.opacity = '1 !important';

                console.log('‚úÖ Sales ledger UI states set - content forced visible');

                // Force table visibility
                const table = contentEl.querySelector('table');
                if (table) {
                    table.style.display = 'table !important';
                    table.style.visibility = 'visible !important';
                }

            } catch (error) {
                console.error('‚ùå Error loading sales ledger:', error);
                loadingEl.classList.add('hidden');
                contentEl.classList.add('hidden');
                contentEl.style.display = 'none';
                errorEl.classList.remove('hidden');
                errorEl.style.display = 'block';
                errorEl.innerHTML = `<div class="text-center">
                    <p class="text-red-500 font-semibold">Error Loading Sales Data</p>
                    <p class="text-gray-600 mt-2">${error.message}</p>
                    <button onclick="loadSalesLedger()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Retry
                    </button>
                </div>`;
            }
        }

        function displayFilteredSalesData(salesData) {
            console.log('üìç displayFilteredSalesData called with', salesData.length, 'records');

            const tableBodyEl = document.getElementById('sales-ledger-table-body');
            const totalAmountEl = document.getElementById('sales-total-amount');

            console.log('üóÇÔ∏è Table body element:', tableBodyEl);
            console.log('üí∞ Total amount element:', totalAmountEl);

            if (!salesData || salesData.length === 0) {
                console.log('‚ö†Ô∏è No sales data to display');
                if (tableBodyEl) {
                    tableBodyEl.innerHTML = `
                        <tr>
                            <td colspan="7" class="border border-gray-200 px-4 py-4 text-center text-gray-500">
                                No sales records found
                            </td>
                        </tr>
                    `;
                }
                if (totalAmountEl) {
                    totalAmountEl.textContent = '‚Çπ0.00';
                }
                return;
            }

            let totalAmount = 0;
            let htmlContent = '';

            console.log('üìù Processing', salesData.length, 'sales records...');

            try {
                salesData.forEach(sale => {
                    console.log('üîÑ Processing sale:', sale);
                    const formatted = formatDateTime(sale.date);
                    const saleId = sale.sale_id || sale.id;
                    const price = sale.unit_price || (sale.total_amount / sale.quantity) || 0;
                    totalAmount += sale.total_amount;

                    const rowHtml = `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-4 py-2">
                                <div class="text-sm font-medium">${formatted.date}</div>
                                <div class="text-xs text-gray-500">${formatted.time}</div>
                            </td>
                            <td class="border border-gray-200 px-4 py-2 text-sm">${saleId}</td>
                            <td class="border border-gray-200 px-4 py-2 font-medium">${sale.product_name}</td>
                            <td class="border border-gray-200 px-4 py-2">${sale.quantity}</td>
                            <td class="border border-gray-200 px-4 py-2">‚Çπ${price.toFixed(2)}</td>
                            <td class="border border-gray-200 px-4 py-2 font-medium">‚Çπ${sale.total_amount.toFixed(2)}</td>
                            <td class="border border-gray-200 px-4 py-2">
                                <button class="delete-sale text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors"
                                        data-id="${saleId}">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    `;
                    htmlContent += rowHtml;
                });

                console.log('‚úÖ Generated HTML content for table');

                if (tableBodyEl) {
                    tableBodyEl.innerHTML = htmlContent;
                    console.log('üìù Set table body innerHTML');
                } else {
                    console.error('‚ùå sales-ledger-table-body element not found');
                }

                if (totalAmountEl) {
                    totalAmountEl.textContent = `‚Çπ${totalAmount.toFixed(2)}`;
                    console.log('üí∞ Set total amount:', totalAmountEl.textContent);
                } else {
                    console.error('‚ùå sales-total-amount element not found');
                }

                console.log('‚úÖ displayFilteredSalesData completed successfully');

            } catch (error) {
                console.error('‚ùå Error in displayFilteredSalesData:', error);
                console.error('Stack trace:', error.stack);
            }
        }

        function applySalesFilters() {
            const dateFrom = document.getElementById('sales-date-from').value;
            const dateTo = document.getElementById('sales-date-to').value;
            const productId = document.getElementById('sales-product-filter').value;
            
            let filteredData = allSalesData;
            
            if (dateFrom) {
                filteredData = filteredData.filter(sale => {
                    const saleDate = new Date(sale.date).toISOString().split('T')[0];
                    return saleDate >= dateFrom;
                });
            }
            
            if (dateTo) {
                filteredData = filteredData.filter(sale => {
                    const saleDate = new Date(sale.date).toISOString().split('T')[0];
                    return saleDate <= dateTo;
                });
            }
            
            if (productId) {
                filteredData = filteredData.filter(sale => sale.product_id == productId);
            }
            
            displayFilteredSalesData(filteredData);
        }

        function clearSalesFilters() {
            document.getElementById('sales-date-from').value = '';
            document.getElementById('sales-date-to').value = '';
            document.getElementById('sales-product-filter').value = '';
            displayFilteredSalesData(allSalesData);
        }

        // ===== PURCHASE LEDGER FUNCTIONS =====
        async function loadPurchaseLedger() {
            const loadingEl = document.getElementById('purchase-ledger-loading');
            const errorEl = document.getElementById('purchase-ledger-error');
            const contentEl = document.getElementById('purchase-ledger-content');

            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            contentEl.classList.add('hidden');

            try {
                console.log('üìä Fetching purchase ledger from:', `${backendURL}/ledger/purchases`);

                const response = await fetch(`${backendURL}/ledger/purchases`, {
                    headers: getAuthHeaders()
                });

                console.log('üìä Purchase response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('üö´ Purchase API error:', response.status, errorText);
                    throw new Error(`Server returned ${response.status}: ${errorText}`);
                }

                allPurchasesData = await response.json();
                console.log('‚úÖ Purchase data received:', allPurchasesData);

                await loadProductDropdownForFilter('purchase-product-filter');

                displayFilteredPurchaseData(allPurchasesData);

                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');

            } catch (error) {
                console.error('‚ùå Error loading purchase ledger:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.innerHTML = `<div class="text-center">
                    <p class="text-red-500 font-semibold">Error Loading Purchase Data</p>
                    <p class="text-gray-600 mt-2">${error.message}</p>
                    <button onclick="loadPurchaseLedger()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Retry
                    </button>
                </div>`;
            }
        }

        function displayFilteredPurchaseData(purchasesData) {
            const tableBodyEl = document.getElementById('purchase-ledger-table-body');
            const totalCostEl = document.getElementById('purchase-total-cost');
            
            if (purchasesData.length === 0) {
                tableBodyEl.innerHTML = `
                    <tr>
                        <td colspan="7" class="border border-gray-200 px-4 py-4 text-center text-gray-500">
                            No purchase records found
                        </td>
                    </tr>
                `;
                totalCostEl.textContent = '‚Çπ0.00';
                return;
            }
            
            let totalCost = 0;
            
            tableBodyEl.innerHTML = purchasesData.map(purchase => {
                const formatted = formatDateTime(purchase.date);
                const purchaseId = purchase.purchase_id || purchase.id;
                const unitCost = purchase.unit_cost || (purchase.total_cost / purchase.quantity) || 0;
                totalCost += purchase.total_cost;
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-2">
                            <div class="text-sm font-medium">${formatted.date}</div>
                            <div class="text-xs text-gray-500">${formatted.time}</div>
                        </td>
                        <td class="border border-gray-200 px-4 py-2 text-sm">${purchaseId}</td>
                        <td class="border border-gray-200 px-4 py-2 font-medium">${purchase.product_name}</td>
                        <td class="border border-gray-200 px-4 py-2">${purchase.quantity}</td>
                        <td class="border border-gray-200 px-4 py-2">‚Çπ${unitCost.toFixed(2)}</td>
                        <td class="border border-gray-200 px-4 py-2 font-medium">‚Çπ${purchase.total_cost.toFixed(2)}</td>
                        <td class="border border-gray-200 px-4 py-2">
                            <button class="delete-purchase text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors" 
                                    data-id="${purchaseId}">
                                Delete
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            totalCostEl.textContent = `‚Çπ${totalCost.toFixed(2)}`;
        }

        function applyPurchaseFilters() {
            const dateFrom = document.getElementById('purchase-date-from').value;
            const dateTo = document.getElementById('purchase-date-to').value;
            const productId = document.getElementById('purchase-product-filter').value;
            
            let filteredData = allPurchasesData;
            
            if (dateFrom) {
                filteredData = filteredData.filter(purchase => {
                    const purchaseDate = new Date(purchase.date).toISOString().split('T')[0];
                    return purchaseDate >= dateFrom;
                });
            }
            
            if (dateTo) {
                filteredData = filteredData.filter(purchase => {
                    const purchaseDate = new Date(purchase.date).toISOString().split('T')[0];
                    return purchaseDate <= dateTo;
                });
            }
            
            if (productId) {
                filteredData = filteredData.filter(purchase => purchase.product_id == productId);
            }
            
            displayFilteredPurchaseData(filteredData);
        }

        function clearPurchaseFilters() {
            document.getElementById('purchase-date-from').value = '';
            document.getElementById('purchase-date-to').value = '';
            document.getElementById('purchase-product-filter').value = '';
            displayFilteredPurchaseData(allPurchasesData);
        }

        // ===== PROFIT & LOSS FUNCTIONS =====
        async function loadProfitLossData() {
            const loadingEl = document.getElementById('profit-loss-loading');
            const errorEl = document.getElementById('profit-loss-error');
            const contentEl = document.getElementById('profit-loss-content');

            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            contentEl.classList.add('hidden');

            try {
                const [salesResponse, purchasesResponse, productsResponse] = await Promise.all([
                    fetch(`${backendURL}/ledger/sales`, {
                        headers: getAuthHeaders()
                    }),
                    fetch(`${backendURL}/ledger/purchases`, {
                        headers: getAuthHeaders()
                    }),
                    fetch(`${backendURL}/products`, {
                        headers: getAuthHeaders()
                    })
                ]);

                if (!salesResponse.ok) throw new Error('Failed to fetch sales data');
                if (!purchasesResponse.ok) throw new Error('Failed to fetch purchase data');
                if (!productsResponse.ok) throw new Error('Failed to fetch products data');

                const salesData = await salesResponse.json();
                const purchasesData = await purchasesResponse.json();
                const productsData = await productsResponse.json();

                allSalesData = salesData || [];
                allPurchasesData = purchasesData || [];

                await loadProductDropdownForFilter('pl-product-filter');

                calculateAndDisplayProfitLoss(allSalesData, allPurchasesData, productsData);

                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');

            } catch (error) {
                console.error('Error loading profit & loss data:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.innerHTML = `<p class="text-red-500">Error loading profit & loss data: ${error.message}</p>`;
            }
        }

        async function calculateAndDisplayProfitLoss(salesData, purchasesData, productsData, dateFrom = null, dateTo = null) {
            const tableBodyEl = document.getElementById('profit-loss-table-body');
            const totalSalesEl = document.getElementById('total-sales');
            const totalPurchasesEl = document.getElementById('total-purchases');
            const grossProfitEl = document.getElementById('gross-profit');
            const profitMarginEl = document.getElementById('profit-margin');
            const overallStatusEl = document.getElementById('overall-status');

            // Declare and initialize variables before try block
            let totalGrossProfitSum = 0;
            let totalProfitMarginOverall = 0;

            try {
                // Fetch totals from different ledger sources
                const [openingStockResponse, purchasesResponse, salesResponse, closingStockResponse] = await Promise.all([
                    // Opening Stock - from opening stock register
                    fetch(`${backendURL}/opening-stock-register`, { headers: getAuthHeaders() }),
                    // Purchases - from ledger endpoint (with date filtering if needed)
                    fetch(`${backendURL}/ledger/purchases`, { headers: getAuthHeaders() }),
                    // Sales - from ledger endpoint (with date filtering if needed)
                    fetch(`${backendURL}/ledger/sales`, { headers: getAuthHeaders() }),
                    // Closing Stock - from current stock snapshot
                    fetch(`${backendURL}/products/stock-snapshot`, { headers: getAuthHeaders() })
                ]);

                if (!openingStockResponse.ok || !purchasesResponse.ok || !salesResponse.ok || !closingStockResponse.ok) {
                    throw new Error('Failed to fetch data from ledger endpoints');
                }

                const openingStockData = await openingStockResponse.json();
                const purchasesData = await purchasesResponse.json();
                const salesData = await salesResponse.json();
                const closingStockData = await closingStockResponse.json();

                console.log('üìä Opening Stock Data:', openingStockData);

                // Calculate totals from each source
                let openingStockTotal = 0;
                for (const item of openingStockData) {
                    const stockValue = item.stock_value || (item.stock * (item.purchase_price || 0)) || 0;
                    console.log(`Opening Stock Item: ${item.name}, stock: ${item.stock}, price: ${item.purchase_price}, stock_value: ${item.stock_value}, calculated: ${stockValue}`);
                    openingStockTotal += stockValue;
                }

                console.log('üèÅ Opening Stock Total calculated:', openingStockTotal);

                const purchasesTotal = purchasesData.reduce((sum, item) => sum + (item.total_cost || 0), 0);
                const salesTotal = salesData.reduce((sum, item) => sum + (item.total_amount || 0), 0);
                const closingStockTotal = closingStockData.reduce((sum, item) => sum + ((item.price || 0) * (item.stock || 0)), 0);

                console.log('üí∞ Calculated Totals:', {
                    openingStockTotal,
                    purchasesTotal,
                    salesTotal,
                    closingStockTotal
                });

                const grossProfit = salesTotal - purchasesTotal;
                const profitMargin = salesTotal > 0 ? (grossProfit / salesTotal) * 100 : 0;

                // Update summary cards
                totalSalesEl.textContent = `‚Çπ${salesTotal.toFixed(2)}`;
                totalPurchasesEl.textContent = `‚Çπ${purchasesTotal.toFixed(2)}`;
                grossProfitEl.textContent = `‚Çπ${grossProfit.toFixed(2)}`;
                profitMarginEl.textContent = `${profitMargin.toFixed(2)}%`;

                // Update overall status
                const statusClass = grossProfit >= 0 ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
                const statusTextClass = grossProfit >= 0 ? 'text-green-800' : 'text-red-800';
                const statusIcon = grossProfit >= 0 ? 'üìà' : 'üìâ';

                overallStatusEl.className = `mb-6 p-4 rounded-lg border ${statusClass}`;
                overallStatusEl.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">${statusIcon}</span>
                        <div>
                            <h4 class="font-semibold ${statusTextClass}">
                                ${grossProfit >= 0 ? 'Profit' : 'Loss'} of ‚Çπ${Math.abs(grossProfit).toFixed(2)}
                            </h4>
                            <p class="text-sm text-gray-600">
                                Opening Stock: ‚Çπ${openingStockTotal.toFixed(2)} | Closing Stock: ‚Çπ${closingStockTotal.toFixed(2)}
                            </p>
                        </div>
                    </div>
                `;

                // Individual product view - aggregate data by product
                let productRowsHtml = '';

                // Group sales by product
                const salesByProduct = salesData.reduce((acc, sale) => {
                    const key = `${sale.product_name}`;
                    if (!acc[key]) {
                        acc[key] = { quantity: 0, totalAmount: 0 };
                    }
                    acc[key].quantity += sale.quantity || 0;
                    acc[key].totalAmount += sale.total_amount || 0;
                    return acc;
                }, {});

                // Group purchases by product
                const purchasesByProduct = purchasesData.reduce((acc, purchase) => {
                    const key = `${purchase.product_name}`;
                    if (!acc[key]) {
                        acc[key] = { quantity: 0, totalCost: 0 };
                    }
                    acc[key].quantity += purchase.quantity || 0;
                    acc[key].totalCost += purchase.total_cost || 0;
                    return acc;
                }, {});

                // Group opening stock by product
                const openingStockByProduct = openingStockData.reduce((acc, item) => {
                    const key = `${item.name}`;
                    if (!acc[key]) {
                        acc[key] = 0;
                    }
                    acc[key] += item.stock_value || (item.stock * (item.purchase_price || 0)) || 0;
                    return acc;
                }, {});

                // Group closing stock by product
                const closingStockByProduct = closingStockData.reduce((acc, item) => {
                    const key = `${item.product_name || item.name}`;
                    if (!acc[key]) {
                        acc[key] = 0;
                    }
                    acc[key] += (item.price || 0) * (item.stock || 0);
                    return acc;
                }, {});

                // Get all unique product names
                const allProductNames = new Set([
                    ...Object.keys(salesByProduct),
                    ...Object.keys(purchasesByProduct),
                    ...Object.keys(openingStockByProduct),
                    ...Object.keys(closingStockByProduct)
                ]);

                // Generate rows for each product
                for (const productName of allProductNames) {
                    const productSales = salesByProduct[productName] || { quantity: 0, totalAmount: 0 };
                    const productPurchases = purchasesByProduct[productName] || { quantity: 0, totalCost: 0 };
                    const productOpeningStock = openingStockByProduct[productName] || 0;
                    const productClosingStock = closingStockByProduct[productName] || 0;

                    const productUnitsSold = productSales.quantity;
                    // Calculate gross profit: Sales - Cost of Goods Sold
                    // Where COGS = Opening Stock + Purchases - Closing Stock
                    const productCOGS = productOpeningStock + productPurchases.totalCost - productClosingStock;
                    const productGrossProfit = productSales.totalAmount - productCOGS;
                    const productProfitMargin = productSales.totalAmount > 0 ? (productGrossProfit / productSales.totalAmount) * 100 : 0;

                    // Accumulate total gross profit
                    totalGrossProfitSum += productGrossProfit;

                    productRowsHtml += `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-4 py-2 font-medium">${productName}</td>
                            <td class="border border-gray-200 px-4 py-2 text-center text-gray-600">${productUnitsSold}</td>
                            <td class="border border-gray-200 px-4 py-2 text-gray-600">‚Çπ${productOpeningStock.toFixed(2)}</td>
                            <td class="border border-gray-200 px-4 py-2 text-blue-600">‚Çπ${productPurchases.totalCost.toFixed(2)}</td>
                            <td class="border border-gray-200 px-4 py-2 text-green-600">‚Çπ${productSales.totalAmount.toFixed(2)}</td>
                            <td class="border border-gray-200 px-4 py-2 text-purple-600">‚Çπ${productClosingStock.toFixed(2)}</td>
                            <td class="border border-gray-200 px-4 py-2 font-medium ${productGrossProfit >= 0 ? 'text-green-600' : 'text-red-600'}">‚Çπ${productGrossProfit.toFixed(2)}</td>
                            <td class="border border-gray-200 px-4 py-2 font-medium ${productProfitMargin >= 0 ? 'text-green-600' : 'text-red-600'}">${productProfitMargin.toFixed(2)}%</td>
                        </tr>
                    `;
                }

                // Calculate overall profit margin based on total sales and total gross profit sum
                const totalProfitMarginOverall = salesTotal > 0 ? (totalGrossProfitSum / salesTotal) * 100 : 0;

                tableBodyEl.innerHTML = productRowsHtml;

                // Update footer totals
                document.getElementById('total-opening-stock-footer').textContent = `‚Çπ${openingStockTotal.toFixed(2)}`;
                document.getElementById('total-purchases-footer').textContent = `‚Çπ${purchasesTotal.toFixed(2)}`;
                document.getElementById('total-sales-footer').textContent = `‚Çπ${salesTotal.toFixed(2)}`;
                document.getElementById('total-closing-stock-footer').textContent = `‚Çπ${closingStockTotal.toFixed(2)}`;
                document.getElementById('total-profit-footer').textContent = `‚Çπ${totalGrossProfitSum.toFixed(2)}`;
                document.getElementById('total-margin-footer').textContent = `${totalProfitMarginOverall.toFixed(2)}%`;

            } catch (error) {
                console.error('Error calculating profit/loss:', error);
                tableBodyEl.innerHTML = `
                    <tr>
                        <td colspan="8" class="border border-gray-200 px-4 py-4 text-center text-red-500">
                            Error calculating profit & loss: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        function applyProfitLossFilters() {
            const dateFrom = document.getElementById('pl-date-from').value;
            const dateTo = document.getElementById('pl-date-to').value;
            const productId = document.getElementById('pl-product-filter').value;

            let filteredSales = allSalesData;
            let filteredPurchases = allPurchasesData;

            if (dateFrom) {
                filteredSales = filteredSales.filter(sale => {
                    const saleDate = new Date(sale.date).toISOString().split('T')[0];
                    return saleDate >= dateFrom;
                });
                filteredPurchases = filteredPurchases.filter(purchase => {
                    const purchaseDate = new Date(purchase.date).toISOString().split('T')[0];
                    return purchaseDate >= dateFrom;
                });
            }

            if (dateTo) {
                filteredSales = filteredSales.filter(sale => {
                    const saleDate = new Date(sale.date).toISOString().split('T')[0];
                    return saleDate <= dateTo;
                });
                filteredPurchases = filteredPurchases.filter(purchase => {
                    const purchaseDate = new Date(purchase.date).toISOString().split('T')[0];
                    return purchaseDate <= dateTo;
                });
            }

            if (productId) {
                filteredSales = filteredSales.filter(sale => sale.product_id == productId);
                filteredPurchases = filteredPurchases.filter(purchase => purchase.product_id == productId);
            }

            fetch(`${backendURL}/products`, {
                headers: getAuthHeaders()
            })
            .then(response => response.json())
            .then(productsData => {
                if (productId) {
                    productsData = productsData.filter(product => product.id == productId);
                }
                calculateAndDisplayProfitLoss(filteredSales, filteredPurchases, productsData);
            })
            .catch(error => {
                console.error('Error fetching products for filtered calculation:', error);
            });
        }

        function clearProfitLossFilters() {
            document.getElementById('pl-date-from').value = '';
            document.getElementById('pl-date-to').value = '';
            document.getElementById('pl-product-filter').value = '';

            fetch(`${backendURL}/products`, {
                headers: getAuthHeaders()
            })
            .then(response => response.json())
            .then(productsData => {
                calculateAndDisplayProfitLoss(allSalesData, allPurchasesData, productsData);
            })
            .catch(error => {
                console.error('Error fetching products for clear filters:', error);
            });
        }

        // ===== OPENING STOCK PAGE FUNCTIONS =====
        async function loadOpeningStockData() {
            const loadingEl = document.getElementById('opening-stock-loading');
            const errorEl = document.getElementById('opening-stock-error');
            const contentEl = document.getElementById('opening-stock-content');

            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            contentEl.classList.add('hidden');

            try {
                // Use the dedicated opening stock register endpoint
                const response = await fetch(`${backendURL}/opening-stock-register`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Failed to fetch opening stock register');

                const products = await response.json();
                console.log('üì¶ Opening stock register received:', products);

                if (!Array.isArray(products) || products.length === 0) {
                    throw new Error('No products found in opening stock register');
                }

                displayOpeningStockData(products);

                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');

            } catch (error) {
                console.error('Error loading opening stock data:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.innerHTML = `<p class="text-red-500">Error loading opening stock register: ${error.message}</p>`;
            }
        }

        function displayOpeningStockData(products) {
            const tableBodyEl = document.getElementById('opening-stock-table-body');
            const totalProductsEl = document.getElementById('total-opening-products');
            const totalStockEl = document.getElementById('total-opening-stock');
            const totalValueEl = document.getElementById('total-opening-value');
            const avgAgeEl = document.getElementById('avg-stock-age');

            if (products.length === 0) {
                tableBodyEl.innerHTML = `
                    <tr>
                        <td colspan="9" class="border border-gray-200 px-4 py-4 text-center text-gray-500">
                            No products found
                        </td>
                    </tr>
                `;
                totalProductsEl.textContent = '0';
                totalStockEl.textContent = '0';
                totalValueEl.textContent = '‚Çπ0.00';
                avgAgeEl.textContent = '0 days';
                return;
            }

            let totalProducts = 0;
            let totalStock = 0;
            let totalStockValue = 0;
            let totalAgeDays = 0;

            products.sort((a, b) => {
                const dateA = new Date(a.created_at || Date.now());
                const dateB = new Date(b.created_at || Date.now());
                return dateB - dateA;
            });

            tableBodyEl.innerHTML = products.map(product => {
                totalProducts++;
                const stock = product.stock || 0;
                totalStock += stock;

                const purchasePrice = product.purchase_price || 0;
                const stockValue = stock * purchasePrice;
                totalStockValue += stockValue;

                const createdDate = new Date(product.created_at || Date.now());
                const now = new Date();
                const ageDays = Math.floor((now - createdDate) / (1000 * 60 * 60 * 24));
                totalAgeDays += ageDays;

                const formattedDate = formatDateTime(product.created_at);
                const unitDisplay = getUnitDisplay(product.unit_type || 'pcs', stock);

                let status = 'Active';
                let statusClass = 'bg-green-100 text-green-800';

                if (stock === 0) {
                    status = 'Out of Stock';
                    statusClass = 'bg-red-100 text-red-800';
                } else if (stock <= 10) {
                    status = 'Low Stock';
                    statusClass = 'bg-yellow-100 text-yellow-800';
                }

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-2 font-medium">${product.id}</td>
                        <td class="border border-gray-200 px-4 py-2 font-medium">${product.name}</td>
                        <td class="border border-gray-200 px-4 py-2">${product.unit_type || 'pcs'}</td>
                        <td class="border border-gray-200 px-4 py-2 ${stock <= 10 ? 'text-red-600 font-bold' : ''}">${unitDisplay}</td>
                        <td class="border border-gray-200 px-4 py-2">‚Çπ${purchasePrice.toFixed(2)}</td>
                        <td class="border border-gray-200 px-4 py-2">‚Çπ${(product.selling_price || 0).toFixed(2)}</td>
                        <td class="border border-gray-200 px-4 py-2 font-medium">‚Çπ${stockValue.toFixed(2)}</td>
                        <td class="border border-gray-200 px-4 py-2 text-sm text-gray-600">${formattedDate.date}<br><span class="text-xs">${ageDays} days ago</span></td>
                        <td class="border border-gray-200 px-4 py-2">
                            <span class="text-xs px-2 py-1 rounded-full ${statusClass}">${status}</span>
                        </td>
                    </tr>
                `;
            }).join('');

            const avgAge = totalProducts > 0 ? Math.round(totalAgeDays / totalProducts) : 0;

            totalProductsEl.textContent = totalProducts;
            totalStockEl.textContent = totalStock;
            totalValueEl.textContent = `‚Çπ${totalStockValue.toFixed(2)}`;
            avgAgeEl.textContent = `${avgAge} days`;

            document.getElementById('total-initial-stock-footer').textContent = totalStock;
            document.getElementById('total-stock-value-footer').textContent = `‚Çπ${totalStockValue.toFixed(2)}`;
        }

        // ===== HELPER FUNCTIONS =====
        async function loadProductDropdownForFilter(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) {
                console.error(`Dropdown with ID '${dropdownId}' not found`);
                return;
            }
            
            try {
                const response = await fetch(`${backendURL}/products`, {
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                
                if (response.ok) {
                    const products = await response.json();
                    dropdown.innerHTML = '<option value="">All Products</option>';
                    products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = product.name;
                        dropdown.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading products for filter:', error);
                dropdown.innerHTML = '<option value="">Error loading products</option>';
            }
        }

        function downloadData(dataType) {
            try {
                let endpoint;
                if (dataType === 'profit-loss') {
                    endpoint = 'profit-loss';
                } else if (dataType === 'stock') {
                    endpoint = 'stock-ledger';
                } else {
                    endpoint = `${dataType}-ledger`;
                }

                const baseUrl = `${backendURL}/download/${endpoint}`;
                let params = new URLSearchParams();

                if (dataType === 'sales') {
                    const dateFrom = document.getElementById('sales-date-from')?.value;
                    const dateTo = document.getElementById('sales-date-to')?.value;
                    const productId = document.getElementById('sales-product-filter')?.value;

                    if (dateFrom) params.append('start_date', dateFrom);
                    if (dateTo) params.append('end_date', dateTo);
                    if (productId) params.append('product_id', productId);
                } else if (dataType === 'purchase') {
                    const dateFrom = document.getElementById('purchase-date-from')?.value;
                    const dateTo = document.getElementById('purchase-date-to')?.value;
                    const productId = document.getElementById('purchase-product-filter')?.value;

                    if (dateFrom) params.append('start_date', dateFrom);
                    if (dateTo) params.append('end_date', dateTo);
                    if (productId) params.append('product_id', productId);
                } else if (dataType === 'stock') {
                    const dateFrom = document.getElementById('stock-date-from')?.value;
                    const dateTo = document.getElementById('stock-date-to')?.value;
                    const productId = document.getElementById('stock-product-filter')?.value;

                    if (dateFrom && dateFrom.trim() !== '') params.append('date_from', dateFrom);
                    if (dateTo && dateTo.trim() !== '') params.append('date_to', dateTo);
                    if (productId && productId.trim() !== '') params.append('product_id', productId);
                } else if (dataType === 'profit-loss') {
                    const dateFrom = document.getElementById('pl-date-from')?.value;
                    const dateTo = document.getElementById('pl-date-to')?.value;
                    const productId = document.getElementById('pl-product-filter')?.value;

                    if (dateFrom) params.append('start_date', dateFrom);
                    if (dateTo) params.append('end_date', dateTo);
                    if (productId) params.append('product_id', productId);
                }

                const url = params.toString() ? `${baseUrl}?${params.toString()}` : baseUrl;

                console.log(`üì• Downloading ${dataType} data from: ${url}`);

                const link = document.createElement('a');
                link.href = url;
                link.download = `${dataType}_data.csv`;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showNotification(`‚úÖ ${dataType.charAt(0).toUpperCase() + dataType.slice(1)} data download started!`);

            } catch (error) {
                console.error(`Error downloading ${dataType} data:`, error);
                showNotification(`‚ùå Error downloading ${dataType} data: ${error.message}`);
            }
        }

        // ===== AUTHENTICATION CHECK =====
        async function checkExistingAuthentication() {
            const token = localStorage.getItem('authToken');
            const storedUser = localStorage.getItem('currentUser');

            if (token && storedUser) {
                try {
                    console.log('üîê Checking existing authentication...');

                    // Verify token with server
                    const response = await fetch(`${backendURL}/auth/me`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'ngrok-skip-browser-warning': 'true'
                        }
                    });

                    if (response.ok) {
                        const user = await response.json();
                        console.log('‚úÖ Token valid, user authenticated:', user.username);

                        // Update stored user data and set global state
                        localStorage.setItem('currentUser', JSON.stringify(user));
                        currentUser = user;

                        // Show authenticated state
                        showUserControls(user);
                        return true; // Authenticated
                    } else {
                        console.log('‚ö†Ô∏è Token invalid, clearing stored data');
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('currentUser');
                    }
                } catch (error) {
                    console.error('‚ùå Error checking authentication:', error);
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('currentUser');
                }
            }
            return false; // Not authenticated
        }

        // ===== SETTINGS PAGE FUNCTIONS =====
        function loadSettingsPage() {
            // Check if current user is admin
            const storedUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const isAdmin = storedUser && storedUser.username === 'raza123';

            console.log('üëë Checking admin status:', storedUser.username, 'isAdmin:', isAdmin);

            const adminSection = document.getElementById('admin-section');
            const nonAdminSection = document.getElementById('non-admin-section');

            if (isAdmin) {
                adminSection.classList.remove('hidden');
                nonAdminSection.classList.add('hidden');
                showNotification('üëë Admin privileges enabled');
            } else {
                adminSection.classList.add('hidden');
                nonAdminSection.classList.remove('hidden');
            }

            // Load store details display
            loadStoreDetails();
        }

        async function loadStoreDetails() {
            // For now, just set default values. In a real app, this would fetch from server
            document.getElementById('display-store-name').textContent = localStorage.getItem('storeName') || 'Raza Wholesale and Retail';
            document.getElementById('display-store-location').textContent = localStorage.getItem('storeLocation') || 'Tolichowki, Hyderabad';
            document.getElementById('display-store-contact').textContent = localStorage.getItem('storeContact') || '+91 7075210801';
        }

        function startEditingStoreDetails() {
            // Populate edit form with current values
            document.getElementById('store-name').value = document.getElementById('display-store-name').textContent;
            document.getElementById('store-subtitle').value = document.getElementById('display-store-subtitle').textContent;
            document.getElementById('store-location').value = document.getElementById('display-store-location').textContent;
            document.getElementById('store-contact').value = document.getElementById('display-store-contact').textContent;
            document.getElementById('store-delivery-note').value = document.getElementById('display-delivery-note').textContent;

            // Show edit form, hide display
            document.getElementById('store-details-display').classList.add('hidden');
            document.getElementById('store-details-form').classList.remove('hidden');
        }

        function cancelEditingStoreDetails() {
            // Hide edit form, show display
            document.getElementById('store-details-display').classList.remove('hidden');
            document.getElementById('store-details-form').classList.add('hidden');
        }

        async function saveStoreDetails() {
            const name = document.getElementById('store-name').value.trim();
            const subtitle = document.getElementById('store-subtitle').value.trim();
            const location = document.getElementById('store-location').value.trim();
            const contact = document.getElementById('store-contact').value.trim();
            const deliveryNote = document.getElementById('store-delivery-note').value.trim();

            if (!name || !contact) {
                showNotification('‚ùå Store name and contact are required');
                return;
            }

            // Save to localStorage (in a real app, this would save to server)
            localStorage.setItem('storeName', name);
            localStorage.setItem('storeSubtitle', subtitle);
            localStorage.setItem('storeLocation', location);
            localStorage.setItem('storeContact', contact);
            localStorage.setItem('storeDeliveryNote', deliveryNote);

            // Update display
            document.getElementById('display-store-name').textContent = name;
            document.getElementById('display-store-subtitle').textContent = subtitle || 'Kirana Store';
            document.getElementById('display-store-location').textContent = location || 'Tolichowki, Hyderabad';
            document.getElementById('display-store-contact').textContent = contact;
            document.getElementById('display-delivery-note').textContent = deliveryNote || 'Order on WhatsApp - We deliver to your doorstep';

            // Also update header logo
            document.getElementById('header-store-name').textContent = name;
            document.getElementById('header-store-subtitle').textContent = subtitle || 'Kirana Store';
            document.getElementById('header-store-location').textContent = location || 'Tolichowki, Hyderabad';
            document.getElementById('header-store-contact').textContent = contact;
            document.getElementById('header-delivery-note').textContent = deliveryNote || 'Order on WhatsApp - We deliver to your doorstep';

            showNotification('‚úÖ Store details saved successfully!');

            // Hide edit form, show display
            document.getElementById('store-details-display').classList.remove('hidden');
            document.getElementById('store-details-form').classList.add('hidden');
        }

        function showCreateUserForm() {
            hideAllUserSections();
            document.getElementById('create-user-form').classList.remove('hidden');

            // Clear form
            document.getElementById('new-user-username').value = '';
            document.getElementById('new-user-password').value = '';
        }

        function hideCreateUserForm() {
            document.getElementById('create-user-form').classList.add('hidden');
        }

        async function createNewUser() {
            const username = document.getElementById('new-user-username').value.trim();
            const password = document.getElementById('new-user-password').value;

            if (!username || !password) {
                showNotification('‚ùå Username and password are required');
                return;
            }

            if (username.length < 3) {
                showNotification('‚ùå Username must be at least 3 characters long');
                return;
            }

            if (password.length < 6) {
                showNotification('‚ùå Password must be at least 6 characters long');
                return;
            }

            // Create user using same API as registration
            try {
                console.log('üìù Creating new user:', username);

                const response = await fetch(`${backendURL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                console.log(`üìä Create user response status: ${response.status}`);

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ User created successfully:', result);

                    showNotification(`‚úÖ User "${username}" created successfully!`);

                    // Clear form and hide
                    document.getElementById('new-user-username').value = '';
                    document.getElementById('new-user-password').value = '';
                    document.getElementById('create-user-form').classList.add('hidden');

                } else {
                    let errorMessage = 'Failed to create user';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorData.message || errorMessage;
                    } catch (parseError) {
                        errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    }
                    showNotification(`‚ùå ${errorMessage}`);
                }

            } catch (error) {
                console.error('‚ùå Error creating user:', error);
                showNotification('‚ùå Network error. Please try again.');
            }
        }

        async function loadEditUsersSection() {
            hideAllUserSections();
            document.getElementById('edit-users-section').classList.remove('hidden');

            const loadingEl = document.getElementById('edit-users-loading');
            const errorEl = document.getElementById('edit-users-error');
            const contentEl = document.getElementById('edit-users-content');

            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            contentEl.classList.add('hidden');

            try {
                // Fetch users from API
                const response = await fetch(`${backendURL}/users`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    let errorMessage = 'Failed to fetch users';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorData.message || errorMessage;
                    } catch (e) {
                        errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

                const usersList = await response.json();
                console.log('üë• Fetched users for editing:', usersList);

                displayUsersForEditing(usersList);

                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');

                showNotification('‚úÖ Edit user permissions loaded');

            } catch (error) {
                console.error('Error loading users for editing:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.innerHTML = `<p class="text-red-500">Error loading users: ${error.message}</p>`;
            }
        }

        function displayUsersForEditing(users) {
            const listEl = document.getElementById('edit-users-list');

            if (users.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        No users found
                    </div>
                `;
                return;
            }

            // Define all permission features with their display names
            const permissionFeatures = {
                sales: 'Sales',
                purchase: 'Purchase',
                create_product: 'Create Product',
                delete_product: 'Delete Product',
                sales_ledger: 'Sales Ledger',
                purchase_ledger: 'Purchase Ledger',
                stock_ledger: 'Stock Ledger',
                profit_loss: 'Profit & Loss',
                opening_stock: 'Opening Stock',
                user_management: 'User Management'
            };

            listEl.innerHTML = users.map(user => {
                // Get user's current permissions, defaulting to empty array if not available
                const userPermissions = user.permissions || [];

                // Create permission checkboxes HTML
                const permissionsHtml = Object.entries(permissionFeatures).map(([key, displayName]) => {
                    const isChecked = userPermissions.includes(key);
                    return `
                        <label class="flex items-center">
                            <input type="checkbox"
                                   class="permission-checkbox mr-2"
                                   data-user-id="${user.id}"
                                   data-permission="${key}"
                                   ${isChecked ? 'checked' : ''}>
                            <span class="text-sm">${displayName}</span>
                        </label>
                    `;
                }).join('');

                return `
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h5 class="font-medium text-lg">${user.username}</h5>
                                <p class="text-sm text-gray-600">User ID: ${user.id}</p>
                                <p class="text-xs text-gray-500">Status: ${user.is_active ? 'Active' : 'Inactive'}</p>
                            </div>
                            <button class="toggle-permissions-btn bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm"
                                    data-user-id="${user.id}">
                                Edit Permissions
                            </button>
                        </div>

                        <!-- Permissions Section - Initially Hidden -->
                        <div id="permissions-${user.id}" class="permissions-section hidden border-t pt-3">
                            <h6 class="text-sm font-medium text-gray-700 mb-2">Set Permissions:</h6>
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
                                ${permissionsHtml}
                            </div>
                            <div class="mt-3 flex gap-2">
                                <button class="save-permissions-btn bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm"
                                        data-user-id="${user.id}">
                                    üíæ Save
                                </button>
                                <button class="cancel-permissions-btn bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm"
                                        data-user-id="${user.id}">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Event handling for permission editing
        document.addEventListener('click', function(e) {
            // Toggle permissions dropdown
            if (e.target && e.target.classList.contains('toggle-permissions-btn')) {
                const userId = e.target.getAttribute('data-user-id');
                const permissionsSection = document.getElementById(`permissions-${userId}`);
                const isHidden = permissionsSection.classList.contains('hidden');

                // Hide all permission sections first
                document.querySelectorAll('.permissions-section').forEach(section => {
                    section.classList.add('hidden');
                });

                // Show/hide the clicked one
                if (isHidden) {
                    permissionsSection.classList.remove('hidden');
                }
            }

            // Cancel permissions editing
            if (e.target && e.target.classList.contains('cancel-permissions-btn')) {
                const userId = e.target.getAttribute('data-user-id');
                const permissionsSection = document.getElementById(`permissions-${userId}`);
                permissionsSection.classList.add('hidden');
            }

            // Save permissions
            if (e.target && e.target.classList.contains('save-permissions-btn')) {
                const userId = e.target.getAttribute('data-user-id');
                saveUserPermissions(userId);

                // Hide the permissions section after saving
                const permissionsSection = document.getElementById(`permissions-${userId}`);
                permissionsSection.classList.add('hidden');
            }
        });

        async function saveUserPermissions(userId) {
            console.log('üíæ Saving permissions for user:', userId);

            // Collect all checkboxes for this user
            const checkboxes = document.querySelectorAll(`.permission-checkbox[data-user-id="${userId}"]`);
            const permissions = {};

            checkboxes.forEach(checkbox => {
                const permission = checkbox.getAttribute('data-permission');
                permissions[permission] = checkbox.checked;
            });

            console.log('üîß Permissions to save:', permissions);

            try {
                const response = await fetch(`${backendURL}/users/${userId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(permissions)
                });

                if (!response.ok) {
                    let errorMessage = 'Failed to update user permissions';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorData.message || errorMessage;
                    } catch (e) {
                        errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

                const updatedUser = await response.json();
                console.log('‚úÖ User permissions updated:', updatedUser);

                showNotification(`‚úÖ Permissions updated successfully for ${updatedUser.username}!`);

                // Reload the edit users section to reflect changes
                loadEditUsersSection();

            } catch (error) {
                console.error('‚ùå Error saving permissions:', error);
                showNotification(`‚ùå Failed to update permissions: ${error.message}`);
            }
        }

        async function loadDeleteUsersSection() {
            hideAllUserSections();
            document.getElementById('delete-users-section').classList.remove('hidden');

            const loadingEl = document.getElementById('delete-users-loading');
            const errorEl = document.getElementById('delete-users-error');
            const contentEl = document.getElementById('delete-users-content');

            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            contentEl.classList.add('hidden');

    try {
        // Fetch users from API
        const response = await fetch(`${backendURL}/users`, {
            headers: getAuthHeaders()
        });

        if (!response.ok) {
            let errorMessage = 'Failed to fetch users';
            try {
                const errorData = await response.json();
                errorMessage = errorData.detail || errorData.message || errorMessage;
            } catch (e) {
                errorMessage = `Server error: ${response.status} ${response.statusText}`;
            }
            throw new Error(errorMessage);
        }

        const usersList = await response.json();
        console.log('üë• Fetched users for deletion:', usersList);

        // Filter out admin user (raza123)
        const filteredUsers = usersList.filter(user => user.username !== 'raza123');

        displayUsersForDeletion(filteredUsers);

                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');

            } catch (error) {
                console.error('Error loading users for deletion:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.innerHTML = `<p class="text-red-500">Error loading users: ${error.message}</p>`;
            }
        }

        function displayUsersForDeletion(users) {
            const listEl = document.getElementById('delete-users-list');

            if (users.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        No users found (excluding admin)
                    </div>
                `;
                return;
            }

            listEl.innerHTML = users.map(user => `
                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg mb-2">
                    <div>
                        <div class="font-medium">${user.username}</div>
                        <div class="text-sm text-gray-500">User ID: ${user.id}</div>
                    </div>
                    <button class="delete-user-btn bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition-colors"
                            data-id="${user.id}" data-username="${user.username}">
                        Delete User
                    </button>
                </div>
            `).join('');
        }

        async function deleteUser(userId, username) {
            if (!userId || !username) {
                showNotification('‚ùå Invalid user selection');
                return;
            }

            if (!confirm(`Are you sure you want to delete user "${username}"? This action is permanent and will remove all associated data.`)) {
                return;
            }

            try {
                // In a real app, this would call an API to delete the user
                // For now, simulate success
                showNotification(`‚úÖ User "${username}" deleted successfully!`);

                // Reload the delete users section
                loadDeleteUsersSection();

            } catch (error) {
                console.error('Error deleting user:', error);
                showNotification('‚ùå Error deleting user. Please try again.');
            }
        }

        function hideAllUserSections() {
            document.getElementById('create-user-form').classList.add('hidden');
            document.getElementById('edit-users-section').classList.add('hidden');
            document.getElementById('delete-users-section').classList.add('hidden');
        }

        // Update loadPageData to include settings
        function loadHomePageButtons() {
            const buttonsContainer = document.getElementById('main-page-buttons');
            const noPermissionsMessage = document.getElementById('no-permissions-message');

            if (!currentUser || !currentUser.permissions || !Array.isArray(currentUser.permissions)) {
                console.error('‚ùå No user permissions available');
                showNoPermissionsMessage();
                return;
            }

            const userPermissions = currentUser.permissions;

            // Define button configurations with permission mapping
            const buttonConfigs = [
                {
                    permission: 'sales',
                    page: 'sales',
                    icon: 'üõçÔ∏è',
                    title: 'Sales',
                    description: 'Sell products to customers and process orders',
                    bgClass: 'glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20'
                },
                {
                    permission: 'purchase',
                    page: 'purchase',
                    icon: 'üì¶',
                    title: 'Purchase',
                    description: 'Record product purchases from suppliers',
                    bgClass: 'glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20'
                },
                {
                    permission: 'create_product',
                    page: 'create',
                    icon: '‚ûï',
                    title: 'Create Product',
                    description: 'Add new products to your store inventory',
                    bgClass: 'glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20'
                },
                {
                    permission: 'delete_product',
                    page: 'delete-product',
                    icon: 'üóëÔ∏è',
                    title: 'Delete Product',
                    description: 'Remove products from your store inventory',
                    bgClass: 'glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20'
                },
                {
                    permission: 'stock_ledger',
                    page: 'all-products-ledger',
                    icon: 'üìã',
                    title: 'All Products Stock',
                    description: 'View complete stock details with filters',
                    bgClass: 'glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20'
                },
                {
                    permission: 'sales_ledger',
                    page: 'sales-ledger',
                    icon: 'üìã',
                    title: 'Sales Ledger',
                    description: 'View and manage all sales records',
                    bgClass: 'glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20'
                },
                {
                    permission: 'purchase_ledger',
                    page: 'purchase-ledger',
                    icon: 'üìã',
                    title: 'Purchase Ledger',
                    description: 'View and manage all purchase records',
                    bgClass: 'glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20'
                },
                {
                    permission: 'profit_loss',
                    page: 'profit-loss',
                    icon: 'üí∞',
                    title: 'Profit & Loss',
                    description: 'View shop profit and loss analysis with date filters',
                    bgClass: 'text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20',
                    customBg: 'style="background: linear-gradient(rgba(16, 185, 129, 0.85), rgba(245, 158, 11, 0.438));"'
                },
                {
                    permission: 'opening_stock',
                    page: 'opening-stock',
                    icon: 'üìä',
                    title: 'Opening Stock',
                    description: 'View opening stock register with all created products',
                    bgClass: 'text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20',
                    customBg: 'style="background: linear-gradient(rgba(255, 193, 7, 0.85), rgba(255, 152, 0, 0.438));"'
                },
                {
                    permission: 'user_management',
                    page: 'settings',
                    icon: '‚öôÔ∏è',
                    title: 'Settings',
                    description: 'Manage users and their permissions',
                    bgClass: 'text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20',
                    customBg: 'style="background: linear-gradient(rgba(147, 51, 234, 0.85), rgba(59, 130, 246, 0.438));"'
                }
            ];

            // Filter buttons based on user permissions
            const allowedButtons = buttonConfigs.filter(config => userPermissions.includes(config.permission));

            // Generate HTML for allowed buttons
            if (allowedButtons.length === 0) {
                showNoPermissionsMessage();
                return;
            }

            const buttonsHtml = allowedButtons.map(config => `
                <button onclick="showContentPage('${config.page}')" class="w-full p-6 ${config.bgClass}" ${config.customBg || ''}>
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">${config.icon} ${config.title}</div>
                        <p class="${config.icon === 'üí∞' || config.icon === 'üìä' || config.icon === '‚öôÔ∏è' ? 'text-blue-100' : 'text-blue-100'}">${config.description}</p>
                    </div>
                </button>
            `).join('');

            buttonsContainer.innerHTML = buttonsHtml;
            noPermissionsMessage.classList.add('hidden');
        }

        function showNoPermissionsMessage() {
            document.getElementById('main-page-buttons').innerHTML = '';
            document.getElementById('no-permissions-message').classList.remove('hidden');
        }

        function loadPageData(pageName) {
            switch(pageName) {
                case 'sales':
                    fetchProducts();
                    break;
                case 'purchase':
                    loadPurchasePage();
                    break;
                case 'create':
                    loadCreatePage();
                    break;
                case 'delete-product':
                    loadDeleteProductPage();
                    break;
                case 'all-products-ledger':
                    loadAllProductsLedger();
                    break;
                case 'sales-ledger':
                    loadSalesLedger();
                    break;
                case 'purchase-ledger':
                    loadPurchaseLedger();
                    break;
                case 'profit-loss':
                    loadProfitLossData();
                    break;
                case 'opening-stock':
                    loadOpeningStockData();
                    break;
                case 'settings':
                    loadSettingsPage();
                    break;
            }
        }

        // ===== AUTOMATIC LOGOUT ON APP CLOSE/CLOSE =====
        window.addEventListener('beforeunload', function(e) {
            // Clear authentication data when app is closed/navigated away from
            // This provides security by ensuring users must login again
            console.log('üîí Auto-logging out due to app closure/navigation away');
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            currentUser = null;
        });

        // ===== SESSION TIMEOUT (logout after 2 hours of inactivity) =====
        let sessionTimeout;

        function resetSessionTimeout() {
            // Clear any existing timeout
            if (sessionTimeout) {
                clearTimeout(sessionTimeout);
            }

            // Set new timeout for 2 hours (7200000 ms)
            sessionTimeout = setTimeout(function() {
                console.log('‚è∞ Session expired due to inactivity - auto-logging out');
                logout();
                alert('Your session has expired due to inactivity. Please login again.');
            }, 7200000); // 2 hours
        }

        function startSessionTracking() {
            // Reset timeout on user activity
            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
                document.addEventListener(event, resetSessionTimeout, true);
            });

            // Start initial timeout
            resetSessionTimeout();
        }

        function stopSessionTracking() {
            if (sessionTimeout) {
                clearTimeout(sessionTimeout);
            }
            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
                document.removeEventListener(event, resetSessionTimeout, true);
            });
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize pages
pages = {
    homes: document.getElementById('page-homes'),
    sales: document.getElementById('page-sales'),
    purchase: document.getElementById('page-purchase'),
    create: document.getElementById('page-create'),
    'delete-product': document.getElementById('page-delete-product'),
    'all-products-ledger': document.getElementById('page-all-products-ledger'),
    'sales-ledger': document.getElementById('page-sales-ledger'),
    'purchase-ledger': document.getElementById('page-purchase-ledger'),
    'profit-loss': document.getElementById('page-profit-loss'),
    'opening-stock': document.getElementById('page-opening-stock'),
    settings: document.getElementById('page-settings'),
    loading: document.getElementById('page-loading'),
};

page = pages.homes; // Alias for backward compatibility

                backButton = document.getElementById('back-to-home');

                // Set up event listeners
                setupEventListeners();

                // Check authentication before showing any content
                const isAuthenticated = await checkExistingAuthentication();

                // Show appropriate page based on authentication status
                const loginPage = document.getElementById('page-login');
                const homePage = document.getElementById('page-homes');

                if (isAuthenticated) {
                    // User is authenticated - show main app
                    console.log('üë§ Showing authenticated main page');
                    if (loginPage) loginPage.classList.remove('active');
                    if (homePage) homePage.classList.add('active');

                    // Start session tracking for authenticated users
                    startSessionTracking();
                } else {
                    // User is not authenticated - show login page
                    console.log('üîí Showing login page');
                    if (homePage) homePage.classList.remove('active');
                    if (loginPage) loginPage.classList.add('active');
                }
            } catch (error) {
                console.error('Initialization error:', error);
                // Fallback to login page on error
                const loginPage = document.getElementById('page-login');
                const homePage = document.getElementById('page-homes');
                if (loginPage) loginPage.classList.add('active');
                if (homePage) homePage.classList.remove('active');
            }
        });

        function setupEventListeners() {
            // Cart modal close button
            const closeModalButton = document.getElementById('close-modal-button');
            if (closeModalButton) {
                closeModalButton.addEventListener('click', function() {
                    document.getElementById('cart-modal').classList.add('hidden');
                });
            }

            // Show registration form button
            const showRegisterBtn = document.getElementById('show-register-btn');
            if (showRegisterBtn) {
                showRegisterBtn.addEventListener('click', showRegistrationForm);
            }

            // Back to login button
            const backToLoginBtn = document.getElementById('back-to-login-btn');
            if (backToLoginBtn) {
                backToLoginBtn.addEventListener('click', hideRegistrationForm);
            }

            // Login form submission
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }

            // Registration form submission
            const registrationForm = document.getElementById('registration-form');
            if (registrationForm) {
                registrationForm.addEventListener('submit', handleRegistration);
            }

            // Back to home button
            if (backButton) {
                backButton.addEventListener('click', backToHome);
            }

            // Logout button
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }

            // WhatsApp checkout button
            const whatsappCheckoutButton = document.getElementById('whatsapp-checkout-button');
            if (whatsappCheckoutButton) {
                whatsappCheckoutButton.addEventListener('click', generateWhatsAppOrder);
            }

            // Purchase form submission
            const purchaseForm = document.getElementById('purchase-form');
            if (purchaseForm) {
                purchaseForm.addEventListener('submit', handlePurchase);
            }

            // Create product form submission
            const createProductForm = document.getElementById('create-product-form');
            if (createProductForm) {
                createProductForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await handleCreateProduct(e);
                });
            }

            // Event delegation for dynamic elements
            document.addEventListener('click', function(e) {
                // Add to cart buttons
                if (e.target && e.target.classList.contains('add-to-cart-btn')) {
                    const productId = e.target.getAttribute('data-id');
                    addToCart(productId);
                }

                // Increase quantity buttons
                if (e.target && e.target.classList.contains('increase-quantity')) {
                    const productId = e.target.getAttribute('data-id');
                    increaseQuantity(productId);
                }

                // Decrease quantity buttons
                if (e.target && e.target.classList.contains('decrease-quantity')) {
                    const productId = e.target.getAttribute('data-id');
                    decreaseQuantity(productId);
                }

                // Remove item buttons
                if (e.target && e.target.classList.contains('remove-item')) {
                    const productId = e.target.getAttribute('data-id');
                    removeFromCart(productId);
                }

                // Delete product buttons
                if (e.target && e.target.classList.contains('delete-product-btn')) {
                    const productId = e.target.getAttribute('data-id');
                    const productName = e.target.getAttribute('data-name');
                    deleteProduct(productId, productName);
                }

                // Delete sale buttons
                if (e.target && e.target.classList.contains('delete-sale')) {
                    const saleId = e.target.getAttribute('data-id');
                    deleteSale(saleId);
                }

                // Delete purchase buttons
                if (e.target && e.target.classList.contains('delete-purchase')) {
                    const purchaseId = e.target.getAttribute('data-id');
                    deletePurchase(purchaseId);
                }

                // Delete user buttons
                if (e.target && e.target.classList.contains('delete-user-btn')) {
                    const userId = e.target.getAttribute('data-id');
                    const username = e.target.getAttribute('data-username');
                    deleteUser(userId, username);
                }
            });

            // Purchase product dropdown change
            const purchaseProductDropdown = document.getElementById('purchase-product');
            if (purchaseProductDropdown) {
                purchaseProductDropdown.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption && selectedOption.value) {
                        document.getElementById('purchase-unit-cost').value = selectedOption.dataset.purchasePrice || '';
                        document.getElementById('purchase-unit-type').value = selectedOption.dataset.unitType || '';
                    } else {
                        document.getElementById('purchase-unit-cost').value = '';
                        document.getElementById('purchase-unit-type').value = '';
                    }
                });
            }

            // Settings page event listeners
            const saveStoreDetailsBtn = document.getElementById('save-store-details-btn');
            if (saveStoreDetailsBtn) {
                saveStoreDetailsBtn.addEventListener('click', startEditingStoreDetails);
            }

            const confirmSaveStoreBtn = document.getElementById('confirm-save-store-btn');
            if (confirmSaveStoreBtn) {
                confirmSaveStoreBtn.addEventListener('click', saveStoreDetails);
            }

            const cancelSaveStoreBtn = document.getElementById('cancel-save-store-btn');
            if (cancelSaveStoreBtn) {
                cancelSaveStoreBtn.addEventListener('click', cancelEditingStoreDetails);
            }

            const createUserBtn = document.getElementById('create-user-btn');
            if (createUserBtn) {
                createUserBtn.addEventListener('click', showCreateUserForm);
            }

            const confirmCreateUserBtn = document.getElementById('confirm-create-user-btn');
            if (confirmCreateUserBtn) {
                confirmCreateUserBtn.addEventListener('click', createNewUser);
            }

            const cancelCreateUserBtn = document.getElementById('cancel-create-user-btn');
            if (cancelCreateUserBtn) {
                cancelCreateUserBtn.addEventListener('click', hideCreateUserForm);
            }

            const editUsersBtn = document.getElementById('edit-users-btn');
            if (editUsersBtn) {
                editUsersBtn.addEventListener('click', loadEditUsersSection);
            }

            const deleteUsersBtn = document.getElementById('delete-users-btn');
            if (deleteUsersBtn) {
                deleteUsersBtn.addEventListener('click', loadDeleteUsersSection);
            }
        }
    </script>
</body>
</html>
