<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kirana Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            corePlugins: {
                preflight: false,
            }
        }
    </script>
    <style>
        body {
            font-family: "Inter", sans-serif;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        /* Beautiful gradient background with grocery image */
        .gradient-bg {
            background: linear-gradient(rgba(132, 206, 248, 0.85), rgba(172, 124, 20, 0.438)),
                        url('https://thearchitectsdiary.com/wp-content/uploads/2024/03/Supermarket-design-01-1-1536x1076.webp');

            background-size: cover;
            background-position: center;
            min-height: 100vh;
        }
        /* Sales page background - Shopping experience */
        .sales-bg {
            background: linear-gradient(rgba(230, 93, 184, 0.925), rgba(233, 30, 165, 0.959));
            background-size: cover;
            background-position: center;
            min-height: 100vh;
           
        }
        /* Purchase page background - Wholesale/Supplier */
        .purchase-bg {
            background: linear-gradient(rgba(59, 130, 246, 0.85), rgba(147, 51, 234, 0.438));
            background-size: cover;
            background-position: center;
            min-height: 100vh;
        }          
            
        /* Create product background - Fresh produce/New items */
        .create-bg {
            background: linear-gradient(rgba(16, 185, 129, 0.85), rgba(245, 158, 11, 0.438));
            background-size: cover;
            background-position: center;
            min-height: 100vh;
        }            
            
        /* Delete product background - Inventory management */
        .delete-bg {
            background: linear-gradient(rgba(239, 68, 68, 0.85), rgba(107, 114, 128, 0.438)),
                        url('https://images.unsplash.com/photo-1586528116311-ad8dd3c8310d?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80');

            background-size: cover;
            background-position: center;
            min-height: 100vh;
        }
        /* Stock ledger background - Warehouse/Storage */
        .stock-bg {
            background: linear-gradient(rgba(75, 85, 99, 0.85), rgba(55, 65, 81, 0.438));
            background-size: cover;
            background-position: center;
            min-height: 100vh;
        }           
            
        /* Sales ledger background - Sales records/Reports */
        .sales-ledger-bg {
            background: linear-gradient(rgba(240, 243, 76, 0.85), rgba(179, 209, 8, 0.438));
            background-size: cover;
            background-position: center;
            min-height: 100vh;
        }            
            
        /* Purchase ledger background - Purchase records/Supplier management */
        .purchase-ledger-bg {
            background: linear-gradient(rgba(59, 130, 246, 0.85), rgba(147, 51, 234, 0.438));
            background-size: cover;
            background-position: center;
            min-height: 100vh;
        }            
            
        .glass-effect {
            background: rgba(236, 49, 49, 0.842);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(64, 202, 226, 0.918);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        /* Disable hover effects on touch devices */
        @media (hover: hover) {
            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px rgba(221, 4, 4, 0.1);
            }
        }

        /* Mobile specific adjustments */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            .page {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            .glass-effect {
                padding: 0.75rem;
                backdrop-filter: blur(5px);
            }

            /* Make buttons stack vertically on small screens */
            .button-container {
                display: grid;
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            /* Adjust modal on mobile */
            #cart-modal {
                margin: 1rem;
                max-height: 80vh;
            }

            /* Stack summary cards in 2 columns on mobile */
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            /* Make tables scrollable horizontally on mobile */
            .table-container {
                overflow-x: auto;
                margin: -0.5rem -0.75rem 0 -0.75rem;
                padding: 0 0.75rem;
            }

            /* Adjust header for mobile */
            header .flex.items-center {
                flex-direction: column;
                gap: 0.5rem;
            }

            header .logo-container {
                max-width: 250px;
            }

            /* Smaller button padding on mobile */
            .card-hover {
                padding: 4px 8px !important;
            }

            /* Adjust filter sections for mobile */
            .filter-section {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            /* Fix notification positioning on mobile */
            .notification {
                top: 1rem;
                right: 1rem;
                left: 1rem;
                max-width: none;
                width: auto;
            }
        }

        /* Extra small mobile devices */
        @media (max-width: 480px) {
            .page {
                padding-left: 0.25rem;
                padding-right: 0.25rem;
            }

            .glass-effect {
                padding: 0.5rem;
                margin: 0.25rem;
            }

            /* Stack summary cards in 1 column on tiny screens */
            .summary-cards {
                grid-template-columns: 1fr;
            }

            /* Adjust cart modal for very small screens */
            #cart-modal .bg-white {
                margin: 0.5rem;
            }

            /* Smaller text on very small screens */
            h1 {
                font-size: 1.25rem;
            }

            h2 {
                font-size: 1.125rem;
            }

            .text-lg {
                font-size: 0.9375rem;
            }

            .text-sm {
                font-size: 0.8125rem;
            }
        }
    </style>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõí</text></svg>">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="w-full bg-green-500 shadow-sm p-1 sticky top-0 z-10">
        <div class="max-w-2xl mx-auto flex justify-between items-center">
            <div class="flex items-center ">
                <!-- Logo Section -->
                <div class="logo-container top-0 ">
                    <img alt="" src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/2wBDAQMDAwQDBAgEBAgQCwkLEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBD/wAARCACFAJYDASIAAhEBAxEB/8QAHgABAAICAgMBAAAAAAAAAAAAAAUJBwgCBgEDBAr/xABLEAABAwMCAwQFCAQIDwAAAAABAgMEAAURBgcIEiETMUFRFCJhcYEJFTI4dZGy0hYjQrEXM2Vyc4KhwRgkJSdDRFJUYnSEhdHT8P/EABwBAQACAgMBAAAAAAAAAAAAAAAGBwEDAgQIBf/EADgRAAECBAIGCAQGAwEAAAAAAAEAAgMEBREGIQcSMUFRkRQiNWFxgbHRE3OCwSMyQkSSoUNU4fD/2gAMAwEAAhEDEQA/AKuqUpVirqJSlKIg762v4euDzSm8+2kfXV01ld7bIfmyYxYjsNLQA2QAcq65OTWqFWXcCP1e4f2rP/GKr3SXV52i0cTEhELH67RcW2G/FQrH1Um6RSekST9V+u0Xy2G99oK6E58nXoZB6bj3/H/KMV8zvyeuh2843Ev5/wCjY/8ANbfSP76jpGDmqHbpCxJ/tO5N9lTLMdYgcc5k8m+y1Gc4BNFIOBuDffjDZqOncB2mUtL9B3FuaHAPV7eA2pPx5VAituXx16CoqX0JruQ8f4jGfSjyb7Luw8a14Z9IPJvstDNa8HW5mm2nJlgfhajjoBPLF5mpGP6Nf0v6qjWDJ8CZbpTsOfFdjvsq5HGnUFC0K8QQRkGrVH+hNYs3h2Z0turbFqmMoh3lpB9GuaEAuJx3Jcx/GI9h6jwNTrD2lGO2IINXaC0/rAsR3kbD5KaULSHFLxCqjQWn9QFiO8jePDkq9lDGOmK8VN6u0pedF36Vpy/xewmRFcq0g5SoEZStB8UqBBBqEq74EZkxDbFhm4IuCNmateHEbFYHsNwcwQlKUrauaUpSiJSlKIlKUoiUpSiJVl3Aj9XuH9qz/wAYqtGrLuBH6vcP7Vn/AIxVWaX+wG/Mb6FV1pQ7C+tvo5Z4kDuyfGsT71b8aQ2Qbta9WQLpJF3U8lj0FltZBaCeYq51px9MYxnuNZYkd1aW/KJn/FtD/wBNcf3M1RmDKXL1qtQZGavqOvexscgTtVQYOpkvV6vDlJoXYb3sbbGk7V2F/ju2ic+hYtVD3xWP/bXttXGdszeJQjy3L1aQroHpkIFok/7RbUsjHurQbqKc3XOavt2iqgFpDA8Hjre4srrdo6ohbZrXDv1j97q1KJc7beoLN0tM+PMhykdoy+w4FoWnzBFfO/3D31pbwqbsXDSuto+iZ8oqsmoHewDSleqxLIw24nyyfVUPHI8QK3SkdMd/XrVN4mw5FwzP9GcbtObTxHf38VVtfoT8PznRy7WaRdp4jv7xvWA+KfbqPqTSCtZQ4w+crAnK1JT1diE4Uk+fISFD2c3nWmTmATgeNWYXaHHuMR+3Skc7UptbC0eCkrSUkfcT99Vs3iCu13SbbHB68SQ5HV7ChRT/AHVbOiyqvmZOLIxDf4ZBHgd3kR/asrR7UXzEm+UiG/wyLeB3eRH9r46UpVrKwUpSlESlKURKUpREpSlESrLuBH6vcP7Vn/jFVo1ZdwI/V7h/as/8YqtGrLuBH6vcP7Vn/jFVo1ZdwI/V7h/as/8YqtSc" />
                </div>
                <div class="text-center bg-blue-500 glass-effect rounded-2xl p-1 text-white">
                    <h1 class="text-xl font-bold mb-1">Raza Wholesale and Retail</h1>
                    <p class="text-blue-100 mb-0">Kirana Store</p>
                    <p class="text-blue-100 text-sm mb-0">Tolichowki,Hyderabad</p>
                    <p class="text-blue-100 text-sm mb-0">Contact: +91 7075210801</p>
                    <p class="text-blue-100 text-sm mb-0">Order on whatsapp we deliver to your doorstep</p>
                </div>
            </div>

            <!-- User Info and Controls -->
            <div id="user-controls" class="flex items-center gap-2 hidden">
                <div id="welcome-message" class="bg-blue-500 glass-effect rounded-xl px-3 py-1 text-white text-sm"></div>
                <button id="logout-btn" class="px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm">
                    Logout
                </button>
                <button id="back-to-home" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm hidden">
                    ‚Üê Home
                </button>
            </div>
        </div>
    </header>

    <!-- ===== LOADING PAGE ===== -->
    <div id="page-loading" class="page active flex items-center justify-center min-h-screen">
        <div class="glass-effect rounded-xl p-8 text-white text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
            <h2 class="text-xl font-semibold">Loading Kirana Store...</h2>
            <p class="text-blue-100">Verifying authentication...</p>
        </div>
    </div>

    <!-- ===== LANDING PAGE ===== -->
    <div id="page-home" class="page gradient-bg">
        <main class="w-full max-w-6xl mx-auto p-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="showContentPage('sales')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üõçÔ∏è Sales</div>
                        <p class="text-blue-100">Sell products to customers and process orders</p>
                    </div>
                </button>
                
                <button onclick="showContentPage('purchase')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üì¶ Purchase</div>
                        <p class="text-green-100">Record product purchases from suppliers</p>
                    </div>
                </button>
                
                <button onclick="showContentPage('create')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">‚ûï Create Product</div>
                        <p class="text-purple-100">Add new products to your store inventory</p>
                    </div>
                </button>

                <!-- NEW: Delete Product Button -->
                <button onclick="showContentPage('delete-product')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üóëÔ∏è Delete Product</div>
                        <p class="text-red-100">Remove products from your store inventory</p>
                    </div>
                </button>

                <!-- UPDATED: All Products Stock with Filters -->
                <button onclick="showContentPage('all-products-ledger')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üìã All Products Stock</div>
                        <p class="text-teal-100">View complete stock details with filters</p>
                    </div>
                </button>

                <button onclick="showContentPage('sales-ledger')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üìã Sales Ledger</div>
                        <p class="text-red-100">View and manage all sales records</p>
                    </div>
                </button>


                <button onclick="showContentPage('purchase-ledger')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üìã Purchase Ledger</div>
                        <p class="text-indigo-100">View and manage all purchase records</p>
                    </div>
                </button>

                <button onclick="showContentPage('profit-loss')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üí∞ Profit & Loss</div>
                        <p class="text-emerald-100">View shop profit and loss analysis with date filters</p>
                    </div>
                </button>

                <button onclick="showContentPage('opening-stock')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üìä Opening Stock</div>
                        <p class="text-yellow-100">View opening stock register with all created products</p>
                    </div>
                </button>

            <button onclick="showContentPage('settings')" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">‚öôÔ∏è Settings</div>
                        <p class="text-purple-100">Manage users and their permissions</p>
                    </div>
                </button>

                <!-- Admin-only Settings Button when logged in -->
                <div id="admin-settings" class="w-full p-6 glass-effect text-white rounded-xl shadow-lg card-hover border border-white border-opacity-20 mt-4 hidden">
                    <div class="text-left">
                        <div class="text-xl font-bold mb-2">üîß Admin Settings</div>
                        <p class="text-red-100">Administrative user management (Admin Only)</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ===== CONTENT PAGES ===== -->

    <!-- Sales Content Page -->
    <div id="page-sales" class="page sales-bg">
        <main class="max-w-md p-4 space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Products</h2>
            <div id="product-list" class="grid grid-cols-2 gap-4">
                <div class="text-center py-8">
                    <p class="text-gray-500">Loading products...</p>
                </div>
            </div>
        </main>

        <!-- Cart Modal -->
        <div id="cart-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-20">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Your Cart</h3>
                    <button id="close-modal-button" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <div id="cart-items" class="space-y-3">
                    <!-- Cart items will be generated here by JavaScript -->
                </div>
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <div class="flex justify-between font-bold text-lg text-gray-800">
                        <span>Total:</span>
                        <span id="cart-total">‚Çπ0.00</span>
                    </div>
                    <button id="whatsapp-checkout-button" class="w-full mt-4 bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-green-600 transition-colors duration-300">
                        Checkout on WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchase Content Page -->
    <div id="page-purchase" class="page purchase-bg">
        <main class="w-full max-w-md mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Purchase Products</h2>
            
            <!-- Purchase Form -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Record New Purchase</h3>
                <form id="purchase-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Product</label>
                        <select id="purchase-product" class="w-full p-2 border border-gray-300 rounded-lg" required>
                            <option value="">Select Product</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                        <input type="number" id="purchase-quantity" class="w-full p-2 border border-gray-300 rounded-lg" min="1" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Unit Cost (‚Çπ) - Auto-filled</label>
                        <input type="number" id="purchase-unit-cost" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100" step="0.01" min="0.01" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Unit Type</label>
                        <input type="text" id="purchase-unit-type" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                    <button type="submit" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                        Record Purchase
                    </button>
                </form>
            </div>

            <!-- Recent Purchases -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Recent Purchases</h3>
                <div id="purchase-history" class="space-y-3">
                    <!-- Purchase history will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Create Product Content Page -->
    <div id="page-create" class="page create-bg">
        <main class="w-full max-w-md mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Create New Product</h2>
            
            <!-- Product Creation Form -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <form id="create-product-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                        <input type="text" id="product-name" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Purchase Price (‚Çπ)</label>
                        <input type="number" id="product-purchase-price" class="w-full p-2 border border-gray-300 rounded-lg" step="0.01" min="0.01" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Selling Price (‚Çπ)</label>
                        <input type="number" id="product-selling-price" class="w-full p-2 border border-gray-300 rounded-lg" step="0.01" min="0.01" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Unit Type</label>
                        <select id="product-unit-type" class="w-full p-2 border border-gray-300 rounded-lg" required>
                            <option value="">Select Unit Type</option>
                            <option value="kgs">Kilograms (kgs)</option>
                            <option value="ltr">Liters (ltr)</option>
                            <option value="pcs">Pieces (pcs)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Initial Stock</label>
                        <input type="number" id="product-stock" class="w-full p-2 border border-gray-300 rounded-lg" min="0" value="0">
                    </div>
                    <button type="submit" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        Create Product
                    </button>
                </form>
            </div>

            <!-- Existing Products -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Existing Products</h3>
                <div id="existing-products" class="space-y-3">
                    <!-- Existing products will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <!-- NEW: Delete Product Content Page -->
    <div id="page-delete-product" class="page delete-bg">
        <main class="w-full max-w-4xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Delete Product</h2>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">All Products</h3>
                    <button onclick="loadDeleteProductPage()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                        Refresh Products
                    </button>
                </div>
                
                <!-- Warning Message -->
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">Warning</h3>
                            <div class="mt-2 text-sm text-red-700">
                                <p>Deleting a product will permanently remove it from your inventory. This action cannot be undone and will affect all related sales and purchase records.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="delete-product-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading products...</p>
                </div>

                <!-- Error State -->
                <div id="delete-product-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading products</p>
                </div>

                <!-- Products List for Deletion -->
                <div id="delete-product-content" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product ID</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product Name</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Price (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Current Stock</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Last Updated</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="delete-product-table-body">
                                <!-- Products will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- UPDATED: All Products Stock Ledger Page with Filters -->
    <div id="page-all-products-ledger" class="page stock-bg">
        <main class="w-full max-w-6xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">All Products Stock</h2>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">Complete Stock Overview</h3>
                    <div class="flex gap-2">
                        <button onclick="downloadData('stock')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            üì• Download Stock Data
                        </button>
                        <button onclick="loadAllProductsLedger()" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors">
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                        <input type="date" id="stock-date-from" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Leave empty to show current stock">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                        <input type="date" id="stock-date-to" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Select date to see stock as of that date">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Product</label>
                        <select id="stock-product-filter" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">All Products</option>
                        </select>
                    </div>
                </div>
                    <div class="text-sm text-gray-600 mb-4 p-3 bg-blue-50 rounded-lg">
                        <strong>How it works:</strong>
                        <ul class="mt-1 list-disc list-inside">
                            <li>Leave dates empty to see current stock levels in your shop</li>
                            <li>Use "Date To" to see what stock you had as of that date (historical view)</li>
                            <li>All prices shown are purchase prices for inventory valuation</li>
                        </ul>
                    </div>
                    <div class="flex justify-end mb-4">
                        <button onclick="applyStockFilters()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            Apply Filters
                        </button>
                        <button onclick="clearStockFiltersAndReload()" class="ml-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                            Clear
                        </button>
                    </div>
                
                <!-- Loading State -->
                <div id="all-products-ledger-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading all products stock data...</p>
                </div>

                <!-- Error State -->
                <div id="all-products-ledger-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading products stock data</p>
                </div>

                <!-- All Products Stock Content -->
                <div id="all-products-ledger-content" class="hidden">
                    <!-- Summary Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600" id="total-products">0</div>
                            <div class="text-sm text-gray-600">Total Products</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600" id="total-stock">0</div>
                            <div class="text-sm text-gray-600">Total Stock</div>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-orange-600" id="low-stock-count">0</div>
                            <div class="text-sm text-gray-600">Low Stock Items</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600" id="out-of-stock-count">0</div>
                            <div class="text-sm text-gray-600">Out of Stock</div>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-indigo-600" id="total-stock-value">‚Çπ0.00</div>
                            <div class="text-sm text-gray-600">Total Stock Value</div>
                        </div>
                    </div>

                    <!-- Products Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product Name</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Current Stock</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Price (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Stock Value (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Last Updated</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Status</th>
                                </tr>
                            </thead>
                            <tbody id="all-products-ledger-table-body">
                                <!-- Products will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Sales Ledger Page -->
    <div id="page-sales-ledger" class="page sales-ledger-bg">
        <main class="w-full max-w-6xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Sales Ledger</h2>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">All Sales Records</h3>
                    <div class="flex gap-2">
                        <button onclick="downloadData('sales')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            üì• Download Sales Data
                        </button>
                        <button onclick="loadSalesLedger()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                        <input type="date" id="sales-date-from" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                        <input type="date" id="sales-date-to" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product</label>
                        <select id="sales-product-filter" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">All Products</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end mb-4">
                    <button onclick="applySalesFilters()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        Apply Filters
                    </button>
                    <button onclick="clearSalesFilters()" class="ml-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Clear
                    </button>
                </div>
                
                <!-- Loading State -->
                <div id="sales-ledger-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading sales records...</p>
                </div>

                <!-- Error State -->
                <div id="sales-ledger-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading sales records</p>
                </div>

                <!-- Sales Records Table -->
                <div id="sales-ledger-content" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Date & Time</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">ID</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Units</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Price (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Total Amount (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sales-ledger-table-body">
                                <!-- Sales records will be populated here -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-50 font-bold">
                                    <td colspan="5" class="border border-gray-200 px-4 py-2 text-right">Total:</td>
                                    <td class="border border-gray-200 px-4 py-2 text-green-600" id="sales-total-amount">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Purchase Ledger Page -->
    <div id="page-purchase-ledger" class="page purchase-ledger-bg">
        <!-- Settings Button for Ledger Pages -->
        <button onclick="showContentPage('settings')" class="fixed top-20 right-4 z-40 bg-purple-500 text-white p-3 rounded-full shadow-lg hover:bg-purple-600 transition-colors">
            ‚öôÔ∏è Settings
        </button>

        <main class="w-full max-w-6xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Purchase Ledger</h2>
            
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">All Purchase Records</h3>
                    <div class="flex gap-2">
                        <button onclick="downloadData('purchase')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            üì• Download Purchase Data
                        </button>
                        <button onclick="loadPurchaseLedger()" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors">
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                        <input type="date" id="purchase-date-from" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                        <input type="date" id="purchase-date-to" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product</label>
                        <select id="purchase-product-filter" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">All Products</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end mb-4">
                    <button onclick="applyPurchaseFilters()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        Apply Filters
                    </button>
                    <button onclick="clearPurchaseFilters()" class="ml-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Clear
                    </button>
                </div>
                
                <!-- Loading State -->
                <div id="purchase-ledger-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading purchase records...</p>
                </div>

                <!-- Error State -->
                <div id="purchase-ledger-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading purchase records</p>
                </div>

                <!-- Purchase Records Table -->
                <div id="purchase-ledger-content" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Date & Time</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">ID</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Units</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Unit Cost (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Total Cost (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="purchase-ledger-table-body">
                                <!-- Purchase records will be populated here -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-50 font-bold">
                                    <td colspan="5" class="border border-gray-200 px-4 py-2 text-right">Total:</td>
                                    <td class="border border-gray-200 px-4 py-2 text-green-600" id="purchase-total-cost">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Profit & Loss Page -->
    <div id="page-profit-loss" class="page" style="background: linear-gradient(rgba(16, 185, 129, 0.85), rgba(245, 158, 11, 0.438)); background-size: cover; background-position: center; min-height: 100vh;">
        <main class="w-full max-w-6xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Profit & Loss Analysis</h2>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">Financial Overview</h3>
                    <div class="flex gap-2">
                        <button onclick="downloadData('profit-loss')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            üì• Download P&L Data
                        </button>
                        <button onclick="loadProfitLossData()" class="px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition-colors">
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                        <input type="date" id="pl-date-from" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                        <input type="date" id="pl-date-to" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Product</label>
                        <select id="pl-product-filter" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">All Products</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end mb-4">
                    <button onclick="applyProfitLossFilters()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        Apply Filters
                    </button>
                    <button onclick="clearProfitLossFilters()" class="ml-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Clear
                    </button>
                </div>

                <!-- Loading State -->
                <div id="profit-loss-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading profit & loss data...</p>
                </div>

                <!-- Error State -->
                <div id="profit-loss-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading profit & loss data</p>
                </div>

                <!-- Profit & Loss Content -->
                <div id="profit-loss-content" class="hidden">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600" id="total-sales">‚Çπ0.00</div>
                            <div class="text-sm text-gray-600">Total Sales</div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-red-600" id="total-purchases">‚Çπ0.00</div>
                            <div class="text-sm text-gray-600">Total Purchases</div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600" id="gross-profit">‚Çπ0.00</div>
                            <div class="text-sm text-gray-600">Gross Profit</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600" id="profit-margin">0%</div>
                            <div class="text-sm text-gray-600">Profit Margin</div>
                        </div>
                    </div>

                    <!-- Overall Status -->
                    <div class="mb-6 p-4 rounded-lg" id="overall-status">
                        <!-- Status will be populated by JavaScript -->
                    </div>

                    <!-- Product-wise Breakdown Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Units Sold</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Opening Stock (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Purchase (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Sales (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Closing Stock (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Gross Profit (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Margin (%)</th>
                                </tr>
                            </thead>
                            <tbody id="profit-loss-table-body">
                                <!-- Product-wise data will be populated here -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-50 font-bold">
                                    <td colspan="2" class="border border-gray-200 px-4 py-2 text-right">Total:</td>
                                    <td class="border border-gray-200 px-4 py-2 text-gray-600" id="total-opening-stock-footer">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2 text-blue-600" id="total-purchases-footer">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2 text-green-600" id="total-sales-footer">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2 text-purple-600" id="total-closing-stock-footer">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2 text-blue-600" id="total-profit-footer">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2 text-purple-600" id="total-margin-footer">0%</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Opening Stock Page -->
    <div id="page-opening-stock" class="page" style="background: linear-gradient(rgba(255, 193, 7, 0.85), rgba(255, 152, 0, 0.438)); background-size: cover; background-position: center; min-height: 100vh;">
        <main class="w-full max-w-6xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Opening Stock Register</h2>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">All Created Products</h3>
                    <button onclick="loadOpeningStockData()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors">
                        Refresh
                    </button>
                </div>

                <!-- Loading State -->
                <div id="opening-stock-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading opening stock register...</p>
                </div>

                <!-- Error State -->
                <div id="opening-stock-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading opening stock data</p>
                </div>

                <!-- Opening Stock Content -->
                <div id="opening-stock-content" class="hidden">
                    <!-- Summary Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600" id="total-opening-products">0</div>
                            <div class="text-sm text-gray-600">Total Products</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600" id="total-opening-stock">0</div>
                            <div class="text-sm text-gray-600">Total Stock</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600" id="total-opening-value">‚Çπ0.00</div>
                            <div class="text-sm text-gray-600">Total Stock Value</div>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-orange-600" id="avg-stock-age">0 days</div>
                            <div class="text-sm text-gray-600">Avg Stock Age</div>
                        </div>
                    </div>

                    <!-- Products Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product ID</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Product Name</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Unit Type</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Initial Stock</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Purchase Price (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Selling Price (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Stock Value (‚Çπ)</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Created Date</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Status</th>
                                </tr>
                            </thead>
                            <tbody id="opening-stock-table-body">
                                <!-- Products will be populated here -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-50 font-bold">
                                    <td colspan="3" class="border border-gray-200 px-4 py-2 text-right">Total:</td>
                                    <td class="border border-gray-200 px-4 py-2 text-green-600" id="total-initial-stock-footer">0</td>
                                    <td class="border border-gray-200 px-4 py-2" colspan="2"></td>
                                    <td class="border border-gray-200 px-4 py-2 text-blue-600" id="total-stock-value-footer">‚Çπ0.00</td>
                                    <td class="border border-gray-200 px-4 py-2" colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- SETTINGS PAGE -->
    <div id="page-settings" class="page" style="background: linear-gradient(rgba(147, 51, 234, 0.85), rgba(59, 130, 246, 0.438)); background-size: cover; background-position: center; min-height: 100vh;">
        <main class="w-full max-w-6xl mx-auto p-4 space-y-6">
            <h2 class="text-xl font-semibold text-gray-700">Settings</h2>

            <!-- Create User Section -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">Create User</h3>
                </div>
                <!-- Add User Button -->
                <div class="mb-6">
                    <button id="add-user-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                        + Add New User
                    </button>
                </div>

                <!-- Add User Form (Hidden by default) -->
                <div id="add-user-form" class="mb-6 p-4 bg-gray-50 rounded-lg hidden">
                    <h4 class="text-md font-semibold mb-4">Create New User</h4>
                    <form id="add-user-form-element" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                            <input type="text" id="new-username" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Enter username" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="new-email" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="user@domain.com" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="new-password" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Enter password" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                            <select id="new-role" class="w-full p-2 border border-gray-300 rounded-lg" required>
                                <option value="EMPLOYEE">Employee</option>
                                <option value="MANAGER">Manager</option>
                                <option value="ADMIN">Admin</option>
                            </select>
                        </div>
                    </form>

                    <!-- Permissions Section -->
                    <div class="mt-6">
                        <h5 class="text-sm font-semibold text-gray-800 mb-3">Set User Permissions</h5>
                        <p class="text-xs text-gray-600 mb-4">Select which features this user can access:</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <label class="flex items-center p-2 bg-white rounded border hover:bg-gray-50">
                                <input type="checkbox" id="perm-sales" class="mr-3 h-4 w-4 text-blue-600 rounded focus:ring-blue-500" checked>
                                <span class="text-sm font-medium text-gray-700">üõçÔ∏è Sales - Sell products and process orders</span>
                            </label>
                            <label class="flex items-center p-2 bg-white rounded border hover:bg-gray-50">
                                <input type="checkbox" id="perm-purchase" class="mr-3 h-4 w-4 text-blue-600 rounded focus:ring-blue-500" checked>
                                <span class="text-sm font-medium text-gray-700">üì¶ Purchase - Record product purchases</span>
                            </label>
                            <label class="flex items-center p-2 bg-white rounded border hover:bg-gray-50">
                                <input type="checkbox" id="perm-create-product" class="mr-3 h-4 w-4 text-blue-600 rounded focus:ring-blue-500" checked>
                                <span class="text-sm font-medium text-gray-700">‚ûï Create Product - Add new products</span>
                            </label>
                            <label class="flex items-center p-2 bg-white rounded border hover:bg-gray-50">
                                <input type="checkbox" id="perm-delete-product" class="mr-3 h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                                <span class="text-sm font-medium text-gray-700">üóëÔ∏è Delete Product - Remove products</span>
                            </label>
                            <label class="flex items-center p-2 bg-white rounded border hover:bg-gray-50">
                                <input type="checkbox" id="perm-sales-ledger" class="mr-3 h-4 w-4 text-blue-600 rounded focus:ring-blue-500" checked>
                                <span class="text-sm font-medium text-gray-700">üìã Sales Ledger - View sales records</span>
                            </label>
                            <label class="flex items-center p-2 bg-white rounded border hover:bg-gray-50">
                                <input type="checkbox" id="perm-purchase-ledger" class="mr-3 h-4 w-4 text-blue-600 rounded focus:ring-blue-500" checked>
                                <span class="text-sm font-medium text-gray-700">üìã Purchase Ledger - View purchase records</span>
                            </label>
                            <label class="flex items-center p-2 bg-white rounded border hover:bg-gray-50">
                                <input type="checkbox" id="perm-stock-ledger" class="mr-3 h-4 w-4 text-blue-600 rounded focus:ring-blue-500" checked>
                                <span class="text-sm font-medium text-gray-700">üìä Stock Ledger - View stock information</span>
                            </label>
                            <label class="flex items-center p-2 bg-white rounded border hover:bg-gray-50">
                                <input type="checkbox" id="perm-profit-loss" class="mr-3 h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                                <span class="text-sm font-medium text-gray-700">üí∞ Profit & Loss - View financial reports</span>
                            </label>
                            <label class="flex items-center p-2 bg-white rounded border hover:bg-gray-50">
                                <input type="checkbox" id="perm-opening-stock" class="mr-3 h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                                <span class="text-sm font-medium text-gray-700">üìä Opening Stock - View initial stock</span>
                            </label>
                            <label class="flex items-center p-2 bg-white rounded border hover:bg-gray-50">
                                <input type="checkbox" id="perm-user-management" class="mr-3 h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                                <span class="text-sm font-medium text-gray-700">üë• User Management - Manage other users</span>
                            </label>
                        </div>
                        <div class="mt-3 flex gap-2">
                            <button type="button" onclick="selectAllPermissions()" class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
                                Select All
                            </button>
                            <button type="button" onclick="clearAllPermissions()" class="px-3 py-1 bg-gray-500 text-white text-xs rounded hover:bg-gray-600">
                                Clear All
                            </button>
                        </div>
                    </div>

                    <div class="mt-4 flex gap-2">
                        <button onclick="addUser()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            Save User
                        </button>
                        <button onclick="hideAddUserForm()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Edit User Section -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">Edit User</h3>
                </div>

                <!-- User Selection Dropdown -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select User to Edit</label>
                    <select id="edit-user-selector" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="">Choose a user...</option>
                        <!-- Users will be loaded here -->
                    </select>
                </div>

                <!-- Edit User Form (Hidden until user is selected) -->
                <div id="edit-user-form" class="mb-6 p-4 bg-gray-50 rounded-lg hidden">
                    <h4 class="text-md font-semibold mb-4">Edit User Details</h4>
                    <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-sm text-yellow-800">
                            <strong>Note:</strong> Edit user details and permissions. Leave password field empty to keep current password.
                        </p>
                    </div>
                    <form id="edit-user-form-element" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="hidden" id="edit-user-id">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                            <input type="text" id="edit-username" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Enter username" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="edit-email" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="user@domain.com" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">New Password (Optional)</label>
                            <input type="password" id="edit-password" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Leave empty to keep current password">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                            <select id="edit-role" class="w-full p-2 border border-gray-300 rounded-lg" required>
                                <option value="EMPLOYEE">Employee - Basic Access</option>
                                <option value="MANAGER">Manager - Limited Admin</option>
                                <option value="ADMIN">Admin - Full Access</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="edit-is-active" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span class="text-sm font-medium text-gray-700">User Account Active</span>
                            </label>
                        </div>
                    </form>
                    <div class="mt-4 flex gap-2">
                        <button onclick="updateUser()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            Update User
                        </button>
                        <button onclick="hideEditUserForm()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Delete User Section -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">Delete User</h3>
                </div>

                <!-- User Selection for Deletion -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select User to Delete</label>
                    <select id="delete-user-selector" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="">Choose a user...</option>
                        <!-- Users will be loaded here -->
                    </select>
                </div>

                <!-- Delete User Warning and Button -->
                <div id="delete-user-confirmation" class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg hidden">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h4 class="text-sm font-medium text-red-800 mb-2">Delete User Confirmation</h4>
                            <p id="delete-user-info" class="text-sm text-red-700 mb-3"></p>
                            <div class="flex gap-2">
                                <button onclick="deleteSelectedUser()" class="px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">
                                    Yes, Delete User
                                </button>
                                <button onclick="cancelDeleteUser()" class="px-3 py-1 bg-gray-500 text-white text-xs rounded hover:bg-gray-600">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Permissions Management Section -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">Permissions</h3>
                    <button onclick="loadUsers()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors">
                        Refresh Users
                    </button>
                </div>

                <!-- User Selection for Permissions -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select User to Manage Permissions</label>
                    <select id="permissions-user-selector" class="w-full p-2 border border-gray-300 rounded-lg" onchange="loadUserPermissions()">
                        <option value="">Choose a user...</option>
                        <!-- Users will be loaded here -->
                    </select>
                </div>

                <!-- Current Permissions Display -->
                <div id="current-permissions-display" class="hidden mb-6 p-4 bg-blue-50 rounded-lg">
                    <h4 class="text-sm font-semibold text-blue-800 mb-3">Current Permissions for <span id="permissions-user-name"></span></h4>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3" id="current-permissions-list">
                        <!-- Current permissions will be displayed here -->
                    </div>
                </div>

                <!-- Permissions Update Form -->
                <div id="permissions-update-form" class="hidden p-4 bg-gray-50 rounded-lg">
                    <h4 class="text-sm font-semibold text-gray-800 mb-3">Update Permissions</h4>
                    <p class="text-xs text-gray-600 mb-4">Select which main page buttons this user can access:</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                        <label class="flex items-center p-3 bg-white rounded border hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="perm-update-sales" class="mr-3 h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700">
                                <span class="text-lg mr-2">üõçÔ∏è</span>
                                Sales
                                <span class="text-xs text-gray-500 block">Sell products to customers</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 bg-white rounded border hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="perm-update-purchase" class="mr-3 h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700">
                                <span class="text-lg mr-2">üì¶</span>
                                Purchase
                                <span class="text-xs text-gray-500 block">Record product purchases</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 bg-white rounded border hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="perm-update-create-product" class="mr-3 h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700">
                                <span class="text-lg mr-2">‚ûï</span>
                                Create Product
                                <span class="text-xs text-gray-500 block">Add new products to inventory</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 bg-white rounded border hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="perm-update-delete-product" class="mr-3 h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700">
                                <span class="text-lg mr-2">üóëÔ∏è</span>
                                Delete Product
                                <span class="text-xs text-gray-500 block">Remove products from inventory</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 bg-white rounded border hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="perm-update-stock-ledger" class="mr-3 h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700">
                                <span class="text-lg mr-2">üìã</span>
                                All Products Stock
                                <span class="text-xs text-gray-500 block">View stock details with filters</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 bg-white rounded border hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="perm-update-sales-ledger" class="mr-3 h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700">
                                <span class="text-lg mr-2">üìã</span>
                                Sales Ledger
                                <span class="text-xs text-gray-500 block">View and manage sales records</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 bg-white rounded border hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="perm-update-purchase-ledger" class="mr-3 h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700">
                                <span class="text-lg mr-2">üìã</span>
                                Purchase Ledger
                                <span class="text-xs text-gray-500 block">View and manage purchase records</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 bg-white rounded border hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="perm-update-profit-loss" class="mr-3 h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700">
                                <span class="text-lg mr-2">üí∞</span>
                                Profit & Loss
                                <span class="text-xs text-gray-500 block">View profit and loss analysis</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 bg-white rounded border hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="perm-update-opening-stock" class="mr-3 h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700">
                                <span class="text-lg mr-2">üìä</span>
                                Opening Stock
                                <span class="text-xs text-gray-500 block">View opening stock register</span>
                            </span>
                        </label>
                        <label class="flex items-center p-3 bg-white rounded border hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="perm-update-user-management" class="mr-3 h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700">
                                <span class="text-lg mr-2">‚öôÔ∏è</span>
                                Settings
                                <span class="text-xs text-gray-500 block">Manage users and permissions</span>
                            </span>
                        </label>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="selectAllPermissionsForUpdate()" class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
                            Select All
                        </button>
                        <button onclick="clearAllPermissionsForUpdate()" class="px-3 py-1 bg-gray-500 text-white text-xs rounded hover:bg-gray-600">
                            Clear All
                        </button>
                        <button onclick="updateUserPermissions()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
                            Update Permissions
                        </button>
                        <button onclick="cancelPermissionsUpdate()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="permissions-loading" class="hidden text-center py-8">
                    <p class="text-gray-500">Loading permissions...</p>
                </div>

                <!-- Error State -->
                <div id="permissions-error" class="hidden text-center py-8">
                    <p class="text-red-500">Error loading permissions</p>
                </div>
            </div>

            <!-- Users List Section -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">All Users</h3>
                    <button onclick="loadUsers()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors">
                        Refresh Users
                    </button>
                </div>

                <!-- Loading State -->
                <div id="users-loading" class="text-center py-8">
                    <p class="text-gray-500">Loading users...</p>
                </div>

                <!-- Error State -->
                <div id="users-error" class="text-center py-8 hidden">
                    <p class="text-red-500">Error loading users</p>
                </div>

                <!-- Users List -->
                <div id="users-list" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-200 px-4 py-2 text-left">ID</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Username</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Email</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Role</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Status</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Created Date</th>
                                    <th class="border border-gray-200 px-4 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <!-- Users will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Current User Permissions Info -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Your Access Permissions</h3>
                <div id="current-user-permissions" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- Current user permissions will be shown here -->
                </div>
            </div>
        </main>
    </div>

<script>
    // ===== BACKEND CONFIGURATION =====
    const backendURL = `https://kirana-store-backend-production.up.railway.app`;
    const WHATSAPP_NUMBER = "917075210801";
    const AUTOMATIC_FALLBACK_TIME = 3000; // Show app automatically after 3 seconds

    // Global variables
    let products = [];
    let cart = {};
    let allSalesData = [];
    let allPurchasesData = [];
    let allStockData = [];

    // DOM Elements
    const pages = {
        home: document.getElementById('page-home'),
        sales: document.getElementById('page-sales'),
        purchase: document.getElementById('page-purchase'),
        create: document.getElementById('page-create'),
        'delete-product': document.getElementById('page-delete-product'),
        'all-products-ledger': document.getElementById('page-all-products-ledger'),
        'sales-ledger': document.getElementById('page-sales-ledger'),
        'purchase-ledger': document.getElementById('page-purchase-ledger'),
        'profit-loss': document.getElementById('page-profit-loss'),
        'opening-stock': document.getElementById('page-opening-stock'),
        settings: document.getElementById('page-settings')
    };

    const backButton = document.getElementById('back-to-home');

    // ===== CORRECTED TIME FORMATTING UTILITY =====
    function formatDateTime(dateString) {
        if (!dateString) {
            return { date: 'N/A', time: 'N/A', full: 'N/A' };
        }

        try {
            const dateObj = new Date(dateString);

            if (isNaN(dateObj.getTime())) {
                console.warn('Invalid date:', dateString);
                return { date: 'Invalid Date', time: 'Invalid Date', full: 'Invalid Date' };
            }

            // Format as Indian date format without timezone conversion
            const day = dateObj.getDate().toString().padStart(2, '0');
            const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
            const year = dateObj.getFullYear().toString().slice(-2);

            const hours = dateObj.getHours().toString().padStart(2, '0');
            const minutes = dateObj.getMinutes().toString().padStart(2, '0');

            return {
                date: `${day}/${month}/${year}`,
                time: `${hours}:${minutes}`,
                full: `${day}/${month}/${year} ${hours}:${minutes}`
            };
        } catch (error) {
            console.error('Error formatting date:', error, dateString);
            return { date: 'Error', time: 'Error', full: 'Error' };
        }
    }

    // ===== UNIT DISPLAY UTILITY =====
    function getUnitDisplay(unitType, quantity) {
        // Handle null, undefined, or empty unit types
        if (!unitType) {
            return `${quantity} pcs`;
        }

        // Normalize unit type to handle case variations
        const normalizedUnitType = unitType.toLowerCase().trim();

        // Return appropriate display based on unit type
        switch(normalizedUnitType) {
            case 'kgs':
            case 'kg':
            case 'kilograms':
                return `${quantity} kgs`;
            case 'ltr':
            case 'liter':
            case 'liters':
            case 'litre':
            case 'litres':
                return `${quantity} ltr`;
            case 'pcs':
            case 'piece':
            case 'pieces':
            case 'pc':
                return `${quantity} pcs`;
            default:
                return `${quantity} ${unitType}`; // Fallback to original value
        }
    }

    // ===== NAVIGATION FUNCTIONS =====
    function showContentPage(pageName) {
        // Hide all pages including login page
        Object.values(pages).forEach(page => page.classList.remove('active'));
        // Also hide login page explicitly since it's not in pages object
        const loginPage = document.getElementById('page-login');
        if (loginPage) loginPage.classList.remove('active');

        pages[pageName].classList.add('active');
        backButton.classList.remove('hidden');
        loadPageData(pageName);
    }

    function backToHome() {
        // Hide all pages including login page
        Object.values(pages).forEach(page => page.classList.remove('active'));
        // Also hide login page explicitly since it's not in pages object
        const loginPage = document.getElementById('page-login');
        if (loginPage) loginPage.classList.remove('active');

        pages.home.classList.add('active');
        backButton.classList.add('hidden');
    }

    function loadPageData(pageName) {
        switch(pageName) {
            case 'sales':
                fetchProducts();
                break;
            case 'purchase':
                loadPurchasePage();
                break;
            case 'create':
                loadCreatePage();
                break;
            case 'delete-product':
                loadDeleteProductPage();
                break;
            case 'all-products-ledger':
                loadAllProductsLedger();
                break;
            case 'sales-ledger':
                loadSalesLedger();
                break;
            case 'purchase-ledger':
                loadPurchaseLedger();
                break;
            case 'profit-loss':
                loadProfitLossData();
                break;
            case 'opening-stock':
                loadOpeningStockData();
                break;
        }
    }

    // ===== NEW: DELETE PRODUCT PAGE FUNCTIONS =====
    async function loadDeleteProductPage() {
        const loadingEl = document.getElementById('delete-product-loading');
        const errorEl = document.getElementById('delete-product-error');
        const contentEl = document.getElementById('delete-product-content');
        
        loadingEl.classList.remove('hidden');
        errorEl.classList.add('hidden');
        contentEl.classList.add('hidden');
        
        try {
            // Fetch all products
            const response = await fetch(`${backendURL}/products`, {
                headers: {
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                }
            });
            
            if (!response.ok) throw new Error('Failed to fetch products');
            
            const products = await response.json();
            
            if (!Array.isArray(products) || products.length === 0) {
                throw new Error('No products found');
            }
            
            displayProductsForDeletion(products);
            
            loadingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');
            
        } catch (error) {
            console.error('Error loading products for deletion:', error);
            loadingEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            errorEl.innerHTML = `<p class="text-red-500">Error loading products: ${error.message}</p>`;
        }
    }

    function displayProductsForDeletion(products) {
        const tableBodyEl = document.getElementById('delete-product-table-body');

        if (products.length === 0) {
            tableBodyEl.innerHTML = `
                <tr>
                    <td colspan="6" class="border border-gray-200 px-4 py-4 text-center text-gray-500">
                        No products found
                    </td>
                </tr>
            `;
            return;
        }

        // Sort products by ID
        products.sort((a, b) => a.id - b.id);

        // Generate table rows
        tableBodyEl.innerHTML = products.map(product => {
            const lastUpdated = product.last_updated || product.created_at || product.updated_at;
            const formattedDate = formatDateTime(lastUpdated);
            const unitDisplay = getUnitDisplay(product.unit_type || 'pcs', product.stock || 0);

            return `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-200 px-4 py-2 font-medium">${product.id}</td>
                    <td class="border border-gray-200 px-4 py-2 font-medium">${product.name}</td>
                    <td class="border border-gray-200 px-4 py-2">‚Çπ${product.selling_price?.toFixed(2) || product.price?.toFixed(2) || '0.00'}</td>
                    <td class="border border-gray-200 px-4 py-2 ${product.stock <= 10 ? 'text-red-600 font-bold' : ''}">${unitDisplay}</td>
                    <td class="border border-gray-200 px-4 py-2 text-sm text-gray-600">${formattedDate.date}<br><span class="text-xs">${formattedDate.time}</span></td>
                    <td class="border border-gray-200 px-4 py-2">
                        <button class="delete-product-btn text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors"
                                data-id="${product.id}" data-name="${product.name}">
                            Delete
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // ===== UPDATED DELETE PRODUCT FUNCTION =====
    async function deleteProduct(productId, productName) {
        if (!confirm(`Are you sure you want to delete "${productName}"? This action cannot be undone and will remove all associated sales and purchase records.`)) {
            return;
        }
        
        try {
            const deleteURL = `${backendURL}/products/${productId}`;
            
            console.log(`üóëÔ∏è Attempting to delete product from: ${deleteURL}`);
            
            const response = await fetch(deleteURL, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                }
            });
            
            console.log(`üìä Delete response status: ${response.status}`);
            
            if (response.ok) {
                const result = await response.json();
                showNotification(result.message || `Product "${productName}" deleted successfully!`);
                
                // Reload the delete product page
                await loadDeleteProductPage();
            } else {
                // Handle different HTTP status codes
                const errorData = await response.json().catch(() => ({}));
                
                if (response.status === 404) {
                    throw new Error('Product not found on server');
                } else if (response.status === 500) {
                    throw new Error(errorData.detail || 'Server error - please try again later');
                } else {
                    throw new Error(errorData.detail || `Server returned ${response.status}`);
                }
            }
            
        } catch (error) {
            console.error('Error deleting product:', error);
            alert(`‚ùå Error deleting product: ${error.message}`);
        }
    }

    // ===== MISSING FUNCTION: displayFilteredStockData =====
    function displayFilteredStockData(stockData) {
        const tableBodyEl = document.getElementById('all-products-ledger-table-body');
        const totalProductsEl = document.getElementById('total-products');
        const totalStockEl = document.getElementById('total-stock');
        const lowStockCountEl = document.getElementById('low-stock-count');
        const outOfStockCountEl = document.getElementById('out-of-stock-count');
        const totalStockValueEl = document.getElementById('total-stock-value');

        if (!stockData || stockData.length === 0) {
            tableBodyEl.innerHTML = `
                <tr>
                    <td colspan="6" class="border border-gray-200 px-4 py-4 text-center text-gray-500">
                        No stock data found for the selected filters
                    </td>
                </tr>
            `;
            totalProductsEl.textContent = '0';
            totalStockEl.textContent = '0';
            lowStockCountEl.textContent = '0';
            outOfStockCountEl.textContent = '0';
            totalStockValueEl.textContent = '‚Çπ0.00';
            return;
        }

        let totalProducts = 0;
        let totalStock = 0;
        let lowStockCount = 0;
        let outOfStockCount = 0;
        let totalStockValue = 0;

        // Generate table rows
        tableBodyEl.innerHTML = stockData.map(product => {
            totalProducts++;
            totalStock += product.stock || 0;

            const stockValue = (product.price || 0) * (product.stock || 0);
            totalStockValue += stockValue;

            const lastUpdated = product.last_updated || product.created_at || product.updated_at;
            const formattedDate = formatDateTime(lastUpdated);

            // Get unit type from the product data or default to 'pcs'
            const unitType = product.unit_type || 'pcs';
            const stockDisplay = getUnitDisplay(unitType, product.stock || 0);

            let status = '';
            let statusClass = '';

            if (product.stock === 0) {
                outOfStockCount++;
                status = 'Out of Stock';
                statusClass = 'bg-red-100 text-red-800';
            } else if (product.stock <= 10) {
                lowStockCount++;
                status = 'Low Stock';
                statusClass = 'bg-yellow-100 text-yellow-800';
            } else {
                status = 'In Stock';
                statusClass = 'bg-green-100 text-green-800';
            }

            return `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-200 px-4 py-2 font-medium">${product.product_name || product.name}</td>
                    <td class="border border-gray-200 px-4 py-2 ${product.stock <= 10 ? 'text-red-600 font-bold' : ''}">${stockDisplay}</td>
                    <td class="border border-gray-200 px-4 py-2">‚Çπ${(product.price || 0).toFixed(2)}</td>
                    <td class="border border-gray-200 px-4 py-2 font-medium">‚Çπ${stockValue.toFixed(2)}</td>
                    <td class="border border-gray-200 px-4 py-2 text-sm text-gray-600">${formattedDate.date}<br><span class="text-xs">${formattedDate.time}</span></td>
                    <td class="border border-gray-200 px-4 py-2">
                        <span class="text-xs px-2 py-1 rounded-full ${statusClass}">${status}</span>
                    </td>
                </tr>
            `;
        }).join('');

        // Update summary statistics
        totalProductsEl.textContent = totalProducts;
        totalStockEl.textContent = totalStock;
        lowStockCountEl.textContent = lowStockCount;
        outOfStockCountEl.textContent = outOfStockCount;
        totalStockValueEl.textContent = `‚Çπ${totalStockValue.toFixed(2)}`;
    }

    // ===== UPDATED: ALL PRODUCTS LEDGER FUNCTIONS =====
    async function loadAllProductsLedger() {
        const loadingEl = document.getElementById('all-products-ledger-loading');
        const errorEl = document.getElementById('all-products-ledger-error');
        const contentEl = document.getElementById('all-products-ledger-content');

        loadingEl.classList.remove('hidden');
        errorEl.classList.add('hidden');
        contentEl.classList.add('hidden');

        try {
            // Get filter values
            const dateFrom = document.getElementById('stock-date-from').value;
            const dateTo = document.getElementById('stock-date-to').value;
            const productId = document.getElementById('stock-product-filter').value;

            let stockData = [];

            // Always use the stock-snapshot endpoint for consistency
            // This endpoint now shows current stock when no date filter and date-filtered stock when date filter applied
            console.log('üìä Fetching stock data using stock-snapshot endpoint');

            // Build query parameters
            const params = new URLSearchParams();

            // Only add date parameters if they are provided and not empty
            if (dateFrom && dateFrom.trim() !== '') {
                params.append('date_from', dateFrom);
            }
            if (dateTo && dateTo.trim() !== '') {
                params.append('date_to', dateTo);
            }
            if (productId && productId.trim() !== '') {
                params.append('product_id', productId);
            }

            const url = `${backendURL}/products/stock-snapshot${params.toString() ? '?' + params.toString() : ''}`;
            console.log(`üìä Fetching from: ${url}`);

            const response = await fetch(url, {
                headers: {
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                }
            });

            if (!response.ok) {
                let errorMessage = `Failed to fetch stock data: ${response.status}`;
                try {
                    const errorData = await response.json();
                    if (errorData.detail) {
                        errorMessage = errorData.detail;
                    }
                } catch (e) {
                    errorMessage = `Server error: ${response.status} ${response.statusText}`;
                }
                throw new Error(errorMessage);
            }

            stockData = await response.json();

            if (dateTo && dateTo.trim() !== '') {
                console.log(`‚úÖ Received historical stock data as of ${dateTo}`);
            } else {
                console.log('‚úÖ Received current stock data');
            }

            console.log(`üìä Retrieved ${stockData.length} stock records`);

            if (!Array.isArray(stockData) || stockData.length === 0) {
                displayFilteredStockData([]);
                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');
                return;
            }

            // Load product dropdown for filter (if not already loaded)
            await loadProductDropdownForFilter('stock-product-filter');

            // Display the data
            displayFilteredStockData(stockData);

            loadingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');

        } catch (error) {
            console.error('Error loading all products ledger:', error);
            loadingEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            errorEl.innerHTML = `
                <div class="text-center">
                    <p class="text-red-500 font-semibold">Error loading products stock data</p>
                    <p class="text-gray-600 mt-2">${error.message}</p>
                    <button onclick="clearStockFiltersAndReload()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Clear Filters & Retry
                    </button>
                </div>
            `;
        }
    }

    // NEW: Separate function for clear button that actually works
    function clearStockFiltersAndReload() {
        document.getElementById('stock-date-from').value = '';
        document.getElementById('stock-date-to').value = '';
        document.getElementById('stock-product-filter').value = '';
        loadAllProductsLedger();
    }

    // Update the existing functions to use the new clear function
    function applyStockFilters() {
        loadAllProductsLedger();
    }

    function clearStockFilters() {
        clearStockFiltersAndReload();
    }

    // ===== SALES LEDGER FUNCTIONS =====
    async function loadSalesLedger() {
        const loadingEl = document.getElementById('sales-ledger-loading');
        const errorEl = document.getElementById('sales-ledger-error');
        const contentEl = document.getElementById('sales-ledger-content');

        loadingEl.classList.remove('hidden');
        errorEl.classList.add('hidden');
        contentEl.classList.add('hidden');

        // Check authentication
        const token = localStorage.getItem('access_token');
        if (!token) {
            loadingEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            errorEl.innerHTML = `<div class="text-center"><p class="text-red-500 font-semibold">Authentication Required</p><p class="text-gray-600">Please log in first to view sales data.</p></div>`;
            return;
        }

        try {
            console.log('üìä Fetching sales ledger from:', `${backendURL}/ledger/sales`);

            const response = await fetch(`${backendURL}/ledger/sales`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'ngrok-skip-browser-warning': 'true',
                    'Content-Type': 'application/json'
                }
            });

            console.log('üìä Sales response status:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('üö´ Sales API error:', response.status, errorText);
                throw new Error(`Server returned ${response.status}: ${errorText}`);
            }

            allSalesData = await response.json();
            console.log('‚úÖ Sales data received:', allSalesData);

            // Load product dropdown for filter
            await loadProductDropdownForFilter('sales-product-filter');

            // Display all data initially
            displayFilteredSalesData(allSalesData);

            loadingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');

        } catch (error) {
            console.error('‚ùå Error loading sales ledger:', error);
            loadingEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            errorEl.innerHTML = `<div class="text-center">
                <p class="text-red-500 font-semibold">Error Loading Sales Data</p>
                <p class="text-gray-600 mt-2">${error.message}</p>
                <button onclick="loadSalesLedger()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    Retry
                </button>
            </div>`;
        }
    }

    function displayFilteredSalesData(salesData) {
        const tableBodyEl = document.getElementById('sales-ledger-table-body');
        const totalAmountEl = document.getElementById('sales-total-amount');
        
        if (salesData.length === 0) {
            tableBodyEl.innerHTML = `
                <tr>
                    <td colspan="7" class="border border-gray-200 px-4 py-4 text-center text-gray-500">
                        No sales records found
                    </td>
                </tr>
            `;
            totalAmountEl.textContent = '‚Çπ0.00';
            return;
        }
        
        let totalAmount = 0;
        
        tableBodyEl.innerHTML = salesData.map(sale => {
            const formatted = formatDateTime(sale.date);
            const saleId = sale.sale_id || sale.id;
            const price = sale.unit_price || (sale.total_amount / sale.quantity) || 0;
            totalAmount += sale.total_amount;
            
            return `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-200 px-4 py-2">
                        <div class="text-sm font-medium">${formatted.date}</div>
                        <div class="text-xs text-gray-500">${formatted.time}</div>
                    </td>
                    <td class="border border-gray-200 px-4 py-2 text-sm">${saleId}</td>
                    <td class="border border-gray-200 px-4 py-2 font-medium">${sale.product_name}</td>
                    <td class="border border-gray-200 px-4 py-2">${sale.quantity}</td>
                    <td class="border border-gray-200 px-4 py-2">‚Çπ${price.toFixed(2)}</td>
                    <td class="border border-gray-200 px-4 py-2 font-medium">‚Çπ${sale.total_amount.toFixed(2)}</td>
                    <td class="border border-gray-200 px-4 py-2">
                        <button class="delete-sale text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors" 
                                data-id="${saleId}">
                            Delete
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        totalAmountEl.textContent = `‚Çπ${totalAmount.toFixed(2)}`;
    }

    function applySalesFilters() {
        const dateFrom = document.getElementById('sales-date-from').value;
        const dateTo = document.getElementById('sales-date-to').value;
        const productId = document.getElementById('sales-product-filter').value;
        
        let filteredData = allSalesData;
        
        // Filter by date range
        if (dateFrom) {
            filteredData = filteredData.filter(sale => {
                const saleDate = new Date(sale.date).toISOString().split('T')[0];
                return saleDate >= dateFrom;
            });
        }
        
        if (dateTo) {
            filteredData = filteredData.filter(sale => {
                const saleDate = new Date(sale.date).toISOString().split('T')[0];
                return saleDate <= dateTo;
            });
        }
        
        // Filter by product
        if (productId) {
            filteredData = filteredData.filter(sale => sale.product_id == productId);
        }
        
        displayFilteredSalesData(filteredData);
    }

    function clearSalesFilters() {
        document.getElementById('sales-date-from').value = '';
        document.getElementById('sales-date-to').value = '';
        document.getElementById('sales-product-filter').value = '';
        displayFilteredSalesData(allSalesData);
    }

    // ===== PURCHASE LEDGER FUNCTIONS =====
    async function loadPurchaseLedger() {
        const loadingEl = document.getElementById('purchase-ledger-loading');
        const errorEl = document.getElementById('purchase-ledger-error');
        const contentEl = document.getElementById('purchase-ledger-content');

        loadingEl.classList.remove('hidden');
        errorEl.classList.add('hidden');
        contentEl.classList.add('hidden');

        // Check authentication
        const token = localStorage.getItem('access_token');
        if (!token) {
            loadingEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            errorEl.innerHTML = `<div class="text-center"><p class="text-red-500 font-semibold">Authentication Required</p><p class="text-gray-600">Please log in first to view purchase data.</p></div>`;
            return;
        }

        try {
            console.log('üìä Fetching purchase ledger from:', `${backendURL}/ledger/purchases`);

            const response = await fetch(`${backendURL}/ledger/purchases`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'ngrok-skip-browser-warning': 'true',
                    'Content-Type': 'application/json'
                }
            });

            console.log('üìä Purchase response status:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('üö´ Purchase API error:', response.status, errorText);
                throw new Error(`Server returned ${response.status}: ${errorText}`);
            }

            allPurchasesData = await response.json();
            console.log('‚úÖ Purchase data received:', allPurchasesData);

            // Load product dropdown for filter
            await loadProductDropdownForFilter('purchase-product-filter');

            // Display all data initially
            displayFilteredPurchaseData(allPurchasesData);

            loadingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');

        } catch (error) {
            console.error('‚ùå Error loading purchase ledger:', error);
            loadingEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            errorEl.innerHTML = `<div class="text-center">
                <p class="text-red-500 font-semibold">Error Loading Purchase Data</p>
                <p class="text-gray-600 mt-2">${error.message}</p>
                <button onclick="loadPurchaseLedger()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    Retry
                </button>
            </div>`;
        }
    }

    function displayFilteredPurchaseData(purchasesData) {
        const tableBodyEl = document.getElementById('purchase-ledger-table-body');
        const totalCostEl = document.getElementById('purchase-total-cost');
        
        if (purchasesData.length === 0) {
            tableBodyEl.innerHTML = `
                <tr>
                    <td colspan="7" class="border border-gray-200 px-4 py-4 text-center text-gray-500">
                        No purchase records found
                    </td>
                </tr>
            `;
            totalCostEl.textContent = '‚Çπ0.00';
            return;
        }
        
        let totalCost = 0;
        
        tableBodyEl.innerHTML = purchasesData.map(purchase => {
            const formatted = formatDateTime(purchase.date);
            const purchaseId = purchase.purchase_id || purchase.id;
            const unitCost = purchase.unit_cost || (purchase.total_cost / purchase.quantity) || 0;
            totalCost += purchase.total_cost;
            
            return `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-200 px-4 py-2">
                        <div class="text-sm font-medium">${formatted.date}</div>
                        <div class="text-xs text-gray-500">${formatted.time}</div>
                    </td>
                    <td class="border border-gray-200 px-4 py-2 text-sm">${purchaseId}</td>
                    <td class="border border-gray-200 px-4 py-2 font-medium">${purchase.product_name}</td>
                    <td class="border border-gray-200 px-4 py-2">${purchase.quantity}</td>
                    <td class="border border-gray-200 px-4 py-2">‚Çπ${unitCost.toFixed(2)}</td>
                    <td class="border border-gray-200 px-4 py-2 font-medium">‚Çπ${purchase.total_cost.toFixed(2)}</td>
                    <td class="border border-gray-200 px-4 py-2">
                        <button class="delete-purchase text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors" 
                                data-id="${purchaseId}">
                            Delete
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        totalCostEl.textContent = `‚Çπ${totalCost.toFixed(2)}`;
    }

    function applyPurchaseFilters() {
        const dateFrom = document.getElementById('purchase-date-from').value;
        const dateTo = document.getElementById('purchase-date-to').value;
        const productId = document.getElementById('purchase-product-filter').value;
        
        let filteredData = allPurchasesData;
        
        // Filter by date range
        if (dateFrom) {
            filteredData = filteredData.filter(purchase => {
                const purchaseDate = new Date(purchase.date).toISOString().split('T')[0];
                return purchaseDate >= dateFrom;
            });
        }
        
        if (dateTo) {
            filteredData = filteredData.filter(purchase => {
                const purchaseDate = new Date(purchase.date).toISOString().split('T')[0];
                return purchaseDate <= dateTo;
            });
        }
        
        // Filter by product
        if (productId) {
            filteredData = filteredData.filter(purchase => purchase.product_id == productId);
        }
        
        displayFilteredPurchaseData(filteredData);
    }

    function clearPurchaseFilters() {
        document.getElementById('purchase-date-from').value = '';
        document.getElementById('purchase-date-to').value = '';
        document.getElementById('purchase-product-filter').value = '';
        displayFilteredPurchaseData(allPurchasesData);
    }

    // ===== CART FUNCTIONS WITH STOCK CHECK =====
    function updateCartUI() {
        const cartItemsEl = document.getElementById('cart-items');
        const cartTotalEl = document.getElementById('cart-total');
        const whatsappCheckoutButtonEl = document.getElementById('whatsapp-checkout-button');
        
        cartItemsEl.innerHTML = '';
        let total = 0;
        let totalCount = 0;

        for (const productId in cart) {
            if (cart[productId] > 0) {
                const product = products.find(p => p.id === parseInt(productId));
                if (product) {
                    const quantity = cart[productId];
                    const itemTotal = quantity * product.price;
                    total += itemTotal;
                    totalCount += quantity;

                    const cartItem = document.createElement('div');
                    cartItem.className = "flex justify-between items-center p-3 bg-gray-50 rounded-lg";
                    cartItem.innerHTML = `
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">${product.name}</div>
                            <div class="text-sm text-gray-600">‚Çπ${product.price.toFixed(2)} each</div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="decrease-quantity w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors" 
                                    data-id="${product.id}">
                                -
                            </button>
                            <span class="quantity-display w-8 text-center font-medium">${quantity}</span>
                            <button class="increase-quantity w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center hover:bg-green-600 transition-colors" 
                                    data-id="${product.id}">
                                +
                            </button>
                        </div>
                        <div class="text-right ml-4">
                            <div class="font-medium text-gray-800">‚Çπ${itemTotal.toFixed(2)}</div>
                            <button class="remove-item text-xs text-red-500 hover:text-red-700 mt-1" data-id="${product.id}">
                                Remove
                            </button>
                        </div>
                    `;
                    cartItemsEl.appendChild(cartItem);
                }
            }
        }

        cartTotalEl.textContent = `‚Çπ${total.toFixed(2)}`;
        whatsappCheckoutButtonEl.disabled = totalCount === 0;
        whatsappCheckoutButtonEl.className = totalCount === 0 
            ? "w-full mt-4 bg-gray-400 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed"
            : "w-full mt-4 bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-green-600 transition-colors duration-300";
    }

    function addToCart(productId) {
        const product = products.find(p => p.id === parseInt(productId));
        
        if (!product) {
            showNotification("Product not found!");
            return;
        }
        
        // Check if product has stock
        if (product.stock <= 0) {
            showNotification(`Sorry, ${product.name} is out of stock!`);
            return;
        }
        
        // Check if adding this item would exceed available stock
        const currentCartQuantity = cart[productId] || 0;
        if (currentCartQuantity + 1 > product.stock) {
            showNotification(`Sorry, only ${product.stock} units of ${product.name} are available!`);
            return;
        }
        
        cart[productId] = currentCartQuantity + 1;
        updateCartUI();
        showNotification(`Added ${product.name} to cart!`);
    }

    function increaseQuantity(productId) {
        const product = products.find(p => p.id === parseInt(productId));
        
        if (!product) {
            showNotification("Product not found!");
            return;
        }
        
        // Check if increasing quantity would exceed available stock
        const currentCartQuantity = cart[productId] || 0;
        if (currentCartQuantity + 1 > product.stock) {
            showNotification(`Sorry, only ${product.stock} units of ${product.name} are available!`);
            return;
        }
        
        cart[productId] = currentCartQuantity + 1;
        updateCartUI();
    }

    function decreaseQuantity(productId) {
        if (cart[productId] > 1) {
            cart[productId] -= 1;
            updateCartUI();
        }
    }

    // ===== SALES PAGE FUNCTIONS =====
    async function fetchProducts() {
        console.log(`üîç Fetching from: ${backendURL}/products`);

        try {
            const response = await fetch(`${backendURL}/products`, {
                headers: {
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                }
            });

            console.log(`üìä Status: ${response.status}`);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            products = await response.json();
            console.log("‚úÖ Products fetched:", products.length, "items");
            console.log("üì¶ Sample product data:", products[0]); // Debug log to see the data structure

            if (!Array.isArray(products) || products.length === 0) {
                throw new Error("No products received");
            }

            renderProducts();
            showCartButton();
            await loadSalesHistory();

        } catch (error) {
            console.error("üí• Fetch error:", error);
            loadMockProducts();
        }
    }

    function loadMockProducts() {
        console.log('üîÑ Loading mock products');
        products = [
            {id: 1, name: "Apple", price: 100.00, stock: 5, imageUrl: "https://placehold.co/400x400/81c784/ffffff?text=Apple"},
            {id: 2, name: "Banana", price: 50.00, stock: 0, imageUrl: "https://placehold.co/400x400/fff176/ffffff?text=Banana"},
            {id: 3, name: "Orange", price: 80.00, stock: 3, imageUrl: "https://placehold.co/400x400/ffb74d/ffffff?text=Orange"},
            {id: 4, name: "Milk", price: 65.00, stock: 10, imageUrl: "https://placehold.co/400x400/b0e0e6/ffffff?text=Milk"},
            {id: 5, name: "Bread", price: 40.00, stock: 0, imageUrl: "https://placehold.co/400x400/d7ccc8/ffffff?text=Bread"},
            {id: 6, name: "Eggs", price: 90.00, stock: 12, imageUrl: "https://placehold.co/400x400/fff9c4/ffffff?text=Eggs"},
        ];
        renderProducts();
        showCartButton();
    }

    // ===== AUTO-PRODUCT IMAGE GENERATION =====
    function generateProductImage(productName) {
        if (!productName) return 'https://picsum.photos/400/400?random=product';

        // Clean the product name for search
        const cleanName = productName.toLowerCase()
            .trim()
            .replace(/[^a-z0-9\s]/g, '') // Remove special characters
            .replace(/\s+/g, '+') // Replace spaces with plus for URL
            .substring(0, 50); // Limit length

        // Primary image source: Try to get actual product images
        const imageSources = [
            // Use loremflickr for real product images from Flickr
            `https://loremflickr.com/400/400/${cleanName}`,
            // Fallback: Use picsum with grocery theme
            `https://picsum.photos/seed/${cleanName}/400/400`,
            // Final fallback: Grocery-themed picsum
            'https://picsum.photos/400/400?random=grocery'
        ];

        return imageSources[0]; // Use loremflickr first (provides real product images)
    }

    function getProductTypeImage(productName) {
        const name = productName.toLowerCase();

        // Use more specific search terms for different product types to get real images
        if (name.includes('milk') || name.includes('dairy') || name.includes('yogurt') || name.includes('cheese')) {
            return 'https://loremflickr.com/400/400/milk,dairy';
        }
        if (name.includes('bread') || name.includes('bakery') || name.includes('cake')) {
            return 'https://loremflickr.com/400/400/bread,bakery';
        }
        if (name.includes('fruit') || name.includes('apple') || name.includes('orange') || name.includes('banana') || name.includes('mango')) {
            return 'https://loremflickr.com/400/400/fruit,fresh';
        }
        if (name.includes('vegetable') || name.includes('potato') || name.includes('onion') || name.includes('tomato') || name.includes('carrot')) {
            return 'https://loremflickr.com/400/400/vegetable,fresh';
        }
        if (name.includes('rice') || name.includes('wheat') || name.includes('grain') || name.includes('flour')) {
            return 'https://loremflickr.com/400/400/rice,grain,wheat';
        }
        if (name.includes('spice') || name.includes('masala') || name.includes('turmeric') || name.includes('cumin') || name.includes('chili')) {
            return 'https://loremflickr.com/400/400/spice,spices,herb';
        }
        if (name.includes('oil') || name.includes('cooking')) {
            return 'https://loremflickr.com/400/400/oil,cooking';
        }
        if (name.includes('meat') || name.includes('chicken') || name.includes('fish') || name.includes('egg')) {
            return 'https://loremflickr.com/400/400/food,protein';
        }
        if (name.includes('drink') || name.includes('beverage') || name.includes('water') || name.includes('juice')) {
            return 'https://loremflickr.com/400/400/drink,beverage';
        }
        if (name.includes('snack') || name.includes('chip') || name.includes('cookie') || name.includes('candy')) {
            return 'https://loremflickr.com/400/400/snack,food';
        }

        // Generic grocery food images
        return 'https://loremflickr.com/400/400/food,grocery,supermarket';
    }

    function renderProducts() {
        const productListEl = document.getElementById('product-list');
        if (!products || products.length === 0) {
            productListEl.innerHTML = '<p class="text-center text-gray-500">No products available</p>';
            return;
        }

        productListEl.innerHTML = products.map(product => {
            const isOutOfStock = product.stock <= 0;
            const buttonClass = isOutOfStock
                ? "w-full bg-gray-400 text-white text-xs font-bold py-2 px-3 rounded-lg cursor-not-allowed"
                : "w-full bg-blue-500 text-white text-xs font-bold py-2 px-3 rounded-lg hover:bg-blue-600 transition-colors duration-300";
            const buttonText = isOutOfStock ? "Out of Stock" : "Add to Cart";
            const unitDisplay = getUnitDisplay(product.unit_type || 'pcs', product.stock || 0);

            // Auto-generate image URL based on product name
            const imageUrl = generateProductImage(product.name);

            return `
                <div class="bg-white p-4 rounded-xl shadow-lg transition-transform transform hover:scale-105 ${isOutOfStock ? 'opacity-70' : ''}">
                    <img src="${imageUrl}" alt="${product.name}"
                         class="w-full h-28 object-cover rounded-md mb-2"
                         onerror="this.src='${getProductTypeImage(product.name)}'">
                    <h4 class="text-sm font-semibold text-gray-700">${product.name}</h4>
                    <p class="text-lg font-bold text-gray-800 my-1">‚Çπ${product.price.toFixed(2)}</p>
                    <div class="flex justify-between items-center text-xs text-gray-500 mb-2">
                        <span>Stock: ${unitDisplay}</span>
                        ${isOutOfStock ? '<span class="text-red-500 font-bold">Out of Stock</span>' : ''}
                    </div>
                    <button class="add-to-cart-btn mt-2 ${buttonClass}"
                            data-id="${product.id}"
                            ${isOutOfStock ? 'disabled' : ''}>
                        ${buttonText}
                    </button>
                </div>
            `;
        }).join('');
    }

    function showCartButton() {
        const existingButton = document.querySelector('.view-cart-button');
        if (existingButton) {
            existingButton.remove();
        }
        
        const cartButton = document.createElement('button');
        cartButton.className = 'view-cart-button fixed bottom-4 right-4 bg-blue-500 text-white p-4 rounded-full shadow-lg hover:bg-blue-600 transition-colors z-10';
        cartButton.innerHTML = 'üõí View Cart';
        cartButton.onclick = () => {
            document.getElementById('cart-modal').classList.remove('hidden');
            document.getElementById('cart-modal').classList.add('flex');
        };
        
        document.getElementById('page-sales').appendChild(cartButton);
    }

    async function recordSale(saleItems) {
        console.log('üì¶ Recording sale items:', saleItems);
        
        try {
            for (const item of saleItems) {
                const response = await fetch(`${backendURL}/sales/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({
                        product_id: item.product_id,
                        quantity: item.quantity
                    })
                });

                console.log(`üìä Response for product ${item.product_id}: ${response.status}`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.log(`‚ùå Failed for product ${item.product_id}:`, errorData);
                    throw new Error(`Failed to record sale for ${item.product_name}`);
                }
                
                const result = await response.json();
                console.log(`‚úÖ Sale recorded for ${item.product_name}:`, result);
            }
            
            return { message: "All sales recorded successfully" };
            
        } catch (error) {
            console.error('Error recording sale:', error);
            throw error;
        }
    }

    function generateWhatsAppOrder() {
        const phoneNumber = WHATSAPP_NUMBER; 
        let message = "Hi, I would like to place an order:%0a%0a";
        let total = 0;
        const saleItems = [];

        for (const productId in cart) {
            if (cart[productId] > 0) {
                const product = products.find(p => p.id === parseInt(productId));
                if (product) {
                    const quantity = cart[productId];
                    const itemTotal = quantity * product.price;
                    total += itemTotal;
                    message += `‚Ä¢ ${quantity}x ${product.name} - ‚Çπ${itemTotal.toFixed(2)}%0a`;
                    
                    saleItems.push({
                        product_id: product.id,
                        product_name: product.name,
                        quantity: quantity,
                        price: product.price,
                        total: itemTotal
                    });
                }
            }
        }

        message += `%0a*Total: ‚Çπ${total.toFixed(2)}*%0a%0aPlease confirm my order. Thank you!`;

        if (saleItems.length > 0) {
            recordSale(saleItems).then(result => {
                console.log('‚úÖ Sales recorded in database:', result);
                showNotification('Order recorded successfully!');
            }).catch(error => {
                console.warn('‚ö†Ô∏è Sale recording failed, but continuing to WhatsApp:', error);
                showNotification('Order sent to WhatsApp (database recording failed)');
            });
        }

        const whatsappUrl = `https://wa.me/${phoneNumber}?text=${message}`;
        window.open(whatsappUrl, '_blank');
        
        cart = {};
        updateCartUI();
        document.getElementById('cart-modal').classList.add('hidden');
        document.getElementById('cart-modal').classList.remove('flex');
    }

    // ===== SALES HISTORY DISPLAY =====
    async function loadSalesHistory() {
        try {
            const response = await fetch(`${backendURL}/ledger/sales`, {
                headers: {
                    'ngrok-skip-browser-warning': 'true'
                }
            });
            
            if (response.ok) {
                const sales = await response.json();
                
                let salesHistoryEl = document.getElementById('sales-history');
                if (!salesHistoryEl) {
                    salesHistoryEl = document.createElement('div');
                    salesHistoryEl.id = 'sales-history';
                    salesHistoryEl.className = 'bg-white p-6 rounded-lg shadow-lg mt-6';
                    salesHistoryEl.innerHTML = '<h3 class="text-lg font-semibold mb-4">Recent Sales</h3><div id="sales-history-content"></div>';
                    document.getElementById('page-sales').querySelector('main').appendChild(salesHistoryEl);
                }
                
                const salesContentEl = document.getElementById('sales-history-content');
                if (sales.length === 0) {
                    salesContentEl.innerHTML = '<p class="text-gray-500 text-center">No sales history found</p>';
                    return;
                }
                
                salesContentEl.innerHTML = sales.slice(0, 10).map(sale => {
                    const formatted = formatDateTime(sale.date);
                    return `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg mb-2">
                            <div class="flex-1">
                                <div class="font-medium">${sale.product_name}</div>
                                <div class="text-sm text-gray-500">${formatted.date}</div>
                                <div class="text-xs text-gray-400">${formatted.time}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-medium">${sale.quantity} units</div>
                                <div class="text-sm text-blue-600">‚Çπ${sale.total_amount.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        } catch (error) {
            console.error('Error loading sales history:', error);
        }
    }

    // ===== PURCHASE PAGE FUNCTIONS =====
    async function loadPurchasePage() {
        await loadProductDropdown('purchase-product');
        await loadPurchaseHistory();
    }

    // ===== ENHANCED: Load Product Dropdown with Price Data =====
    async function loadProductDropdown(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) {
            console.error(`Dropdown with ID '${dropdownId}' not found`);
            return;
        }

        try {
            const response = await fetch(`${backendURL}/products`, {
                headers: {
                    'ngrok-skip-browser-warning': 'true'
                }
            });

            if (response.ok) {
                const products = await response.json();
                dropdown.innerHTML = '<option value="">Select Product</option>';
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} (${product.unit_type}) - Stock: ${product.stock || 0}`;
                    option.dataset.purchasePrice = product.purchase_price;
                    option.dataset.sellingPrice = product.selling_price;
                    option.dataset.unitType = product.unit_type;
                    dropdown.appendChild(option);
                });
                console.log(`‚úÖ Loaded ${products.length} products into dropdown`);
            } else {
                throw new Error('Failed to fetch products');
            }
        } catch (error) {
            console.error('Error loading products for dropdown:', error);
            dropdown.innerHTML = '<option value="">Error loading products</option>';
        }
    }

    // ===== ADD THIS FUNCTION TO YOUR EXISTING JAVASCRIPT =====
    async function loadProductDropdownForFilter(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) {
            console.error(`Dropdown with ID '${dropdownId}' not found`);
            return;
        }
        
        try {
            const response = await fetch(`${backendURL}/products`, {
                headers: {
                    'ngrok-skip-browser-warning': 'true'
                }
            });
            
            if (response.ok) {
                const products = await response.json();
                dropdown.innerHTML = '<option value="">All Products</option>';
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = product.name;
                    dropdown.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading products for filter:', error);
            dropdown.innerHTML = '<option value="">Error loading products</option>';
        }
    }

    // ===== FIXED PURCHASE HISTORY =====
    async function loadPurchaseHistory() {
        const historyEl = document.getElementById('purchase-history');
        historyEl.innerHTML = '<p class="text-gray-500 text-center">Loading purchase history...</p>';
        
        try {
            const response = await fetch(`${backendURL}/ledger/purchases`, {
                headers: {
                    'ngrok-skip-browser-warning': 'true'
                }
            });
            
            if (!response.ok) throw new Error('Failed to fetch purchase history');
            
            const purchases = await response.json();
            
            if (purchases.length === 0) {
                historyEl.innerHTML = '<p class="text-gray-500 text-center">No purchase history found</p>';
                return;
            }
            
            historyEl.innerHTML = purchases.slice(0, 10).map(purchase => {
                const formatted = formatDateTime(purchase.date);
                console.log(`üïí UTC from DB: ${purchase.date} ‚Üí IST: ${formatted.time}`);
                return `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <div class="font-medium">${purchase.product_name}</div>
                            <div class="text-sm text-gray-500">${formatted.date}</div>
                            <div class="text-xs text-gray-400">${formatted.time}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-medium">${purchase.quantity} units</div>
                            <div class="text-sm text-green-600">‚Çπ${purchase.total_cost.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error loading purchase history:', error);
            historyEl.innerHTML = '<p class="text-red-500 text-center">Error loading purchase history</p>';
        }
    }

    // ===== CREATE PRODUCT PAGE FUNCTIONS =====
    async function loadCreatePage() {
        await loadExistingProducts();
    }

    async function loadExistingProducts() {
        const productsEl = document.getElementById('existing-products');
        productsEl.innerHTML = '<p class="text-gray-500 text-center">Loading products...</p>';

        try {
            const response = await fetch(`${backendURL}/products`, {
                headers: {
                    'ngrok-skip-browser-warning': 'true'
                }
            });

            if (!response.ok) throw new Error('Failed to fetch products');

            const products = await response.json();

            if (products.length === 0) {
                productsEl.innerHTML = '<p class="text-gray-500 text-center">No products found. Create your first product!</p>';
                return;
            }

            productsEl.innerHTML = products.map(product => {
                const unitDisplay = getUnitDisplay(product.unit_type || 'pcs', product.stock || 0);
                return `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div>
                            <div class="font-medium">${product.name}</div>
                            <div class="text-sm text-gray-500">Stock: ${unitDisplay}</div>
                            <div class="text-xs text-gray-400">Type: ${product.unit_type || 'pcs'}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-medium">Buy: ‚Çπ${product.purchase_price?.toFixed(2) || '0.00'}</div>
                            <div class="text-sm text-green-600">Sell: ‚Çπ${product.selling_price?.toFixed(2) || '0.00'}</div>
                            <div class="text-xs text-gray-500">ID: ${product.id}</div>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error loading products:', error);
            productsEl.innerHTML = '<p class="text-red-500 text-center">Error loading products</p>';
        }
    }

    async function createProduct(productData) {
        console.log('‚ûï Creating product:', productData);

        try {
            const response = await fetch(`${backendURL}/products/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                },
                body: JSON.stringify(productData)
            });

            console.log(`üìä Response: ${response.status}`);

            if (!response.ok) {
                let errorMessage = 'Failed to create product';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.detail || errorData.message || errorMessage;
                } catch (parseError) {
                    // If we can't parse JSON, use the status text
                    errorMessage = `Server error: ${response.status} ${response.statusText}`;
                }
                throw new Error(errorMessage);
            }

            const result = await response.json();
            console.log('‚úÖ Product created successfully:', result);
            return result;

        } catch (error) {
            console.error('Error creating product:', error);
            throw error;
        }
    }

    // ===== IMPROVED DELETE FUNCTIONS =====
    async function deleteRecord(recordId, recordType) {
        if (!recordId || recordId === 'undefined') {
            alert('Cannot delete this record: No valid ID found');
            return;
        }
        
        if (!confirm(`Are you sure you want to delete this ${recordType} record? This action cannot be undone and will adjust product stock.`)) {
            return;
        }
        
        try {
            const endpoint = recordType === 'sale' ? 'sales' : 'purchases';
            const deleteURL = `${backendURL}/${endpoint}/${recordId}`;
            
            console.log(`üóëÔ∏è Attempting to delete ${recordType} from: ${deleteURL}`);
            
            const response = await fetch(deleteURL, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                }
            });
            
            console.log(`üìä Delete response status: ${response.status}`);
            
            if (response.ok) {
                const result = await response.json();
                showNotification(result.message || `${recordType.charAt(0).toUpperCase() + recordType.slice(1)} record deleted successfully!`);
                
                // Reload the current ledger page
                if (recordType === 'sale') {
                    await loadSalesLedger();
                } else {
                    await loadPurchaseLedger();
                }
            } else {
                const errorData = await response.json();
                throw new Error(errorData.detail || `Server returned ${response.status}`);
            }
            
        } catch (error) {
            console.error(`Error deleting ${recordType}:`, error);
            alert(`Error deleting ${recordType} record: ${error.message}`);
        }
    }

    // ===== PROFIT & LOSS FUNCTIONS =====
    async function loadProfitLossData() {
        const loadingEl = document.getElementById('profit-loss-loading');
        const errorEl = document.getElementById('profit-loss-error');
        const contentEl = document.getElementById('profit-loss-content');

        loadingEl.classList.remove('hidden');
        errorEl.classList.add('hidden');
        contentEl.classList.add('hidden');

        try {
            // Fetch sales and purchase data
            const [salesResponse, purchasesResponse, productsResponse] = await Promise.all([
                fetch(`${backendURL}/ledger/sales`, {
                    headers: { 'ngrok-skip-browser-warning': 'true' }
                }),
                fetch(`${backendURL}/ledger/purchases`, {
                    headers: { 'ngrok-skip-browser-warning': 'true' }
                }),
                fetch(`${backendURL}/products`, {
                    headers: { 'ngrok-skip-browser-warning': 'true' }
                })
            ]);

            if (!salesResponse.ok) throw new Error('Failed to fetch sales data');
            if (!purchasesResponse.ok) throw new Error('Failed to fetch purchase data');
            if (!productsResponse.ok) throw new Error('Failed to fetch products data');

            const salesData = await salesResponse.json();
            const purchasesData = await purchasesResponse.json();
            const productsData = await productsResponse.json();

            // Store data globally for filtering
            allSalesData = salesData || [];
            allPurchasesData = purchasesData || [];

            // Load product dropdown for filter
            await loadProductDropdownForFilter('pl-product-filter');

            // Calculate and display profit/loss
            calculateAndDisplayProfitLoss(allSalesData, allPurchasesData, productsData);

            loadingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');

        } catch (error) {
            console.error('Error loading profit & loss data:', error);
            loadingEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            errorEl.innerHTML = `<p class="text-red-500">Error loading profit & loss data: ${error.message}</p>`;
        }
    }

    async function calculateAndDisplayProfitLoss(salesData, purchasesData, productsData, dateFrom = null, dateTo = null) {
        const tableBodyEl = document.getElementById('profit-loss-table-body');
        const totalSalesEl = document.getElementById('total-sales');
        const totalPurchasesEl = document.getElementById('total-purchases');
        const grossProfitEl = document.getElementById('gross-profit');
        const profitMarginEl = document.getElementById('profit-margin');
        const overallStatusEl = document.getElementById('overall-status');

        try {
            // Get opening stock data - ALWAYS from opening stock register (opening stock page)
            const openingStockResponse = await fetch(`${backendURL}/opening-stock-register`, {
                headers: { 'ngrok-skip-browser-warning': 'true' }
            });
            const openingStockData = await openingStockResponse.json();

            // Get closing stock data - ALWAYS from all products stock page
            let closingStockUrl = `${backendURL}/products/stock-snapshot`;
            if (dateTo) {
                closingStockUrl += `?date_to=${dateTo}`;
            }
            const closingStockResponse = await fetch(closingStockUrl, {
                headers: { 'ngrok-skip-browser-warning': 'true' }
            });
            const closingStockData = await closingStockResponse.json();

            // Group sales data by product
            const productSales = {};
            salesData.forEach(sale => {
                if (!productSales[sale.product_id]) {
                    productSales[sale.product_id] = {
                        product_id: sale.product_id,
                        product_name: sale.product_name,
                        total_quantity: 0,
                        total_sales: 0
                    };
                }
                productSales[sale.product_id].total_quantity += sale.quantity;
                productSales[sale.product_id].total_sales += sale.total_amount;
            });

            // Group purchases data by product
            const productPurchases = {};
            purchasesData.forEach(purchase => {
                if (!productPurchases[purchase.product_id]) {
                    productPurchases[purchase.product_id] = {
                        product_id: purchase.product_id,
                        product_name: purchase.product_name,
                        total_cost: 0
                    };
                }
                productPurchases[purchase.product_id].total_cost += purchase.total_cost;
            });

            // Include ALL products for complete profit & loss analysis
            const productAnalysis = [];
            let totalOpeningStock = 0;
            let totalPurchases = 0;
            let totalSales = 0;
            let totalClosingStock = 0;

            // Process ALL products, even those without transactions
            for (const product of productsData) {
                const productId = product.id;
                const sales = productSales[productId] || { total_quantity: 0, total_sales: 0 };
                const purchases = productPurchases[productId] || { total_cost: 0 };

                // Get opening stock value from opening stock register
                const openingStockProduct = openingStockData.find(p => p.id == productId);
                const openingStockValue = openingStockProduct ?
                    ((openingStockProduct.stock || 0) * (openingStockProduct.purchase_price || 0)) : 0;

                // Get closing stock value from the filtered closing stock data
                const closingStockProduct = closingStockData.find(p => p.product_id == productId);
                const closingStockValue = closingStockProduct ?
                    (closingStockProduct.stock_value || 0) : 0;

                // Apply inventory formula: Sales + Closing Stock - Opening Stock - Purchase
                const grossProfit = sales.total_sales + closingStockValue - openingStockValue - purchases.total_cost;

                // Calculate margin based on sales
                const margin = sales.total_sales > 0 ? ((grossProfit / sales.total_sales) * 100).toFixed(2) : '0.00';

                totalOpeningStock += openingStockValue;
                totalPurchases += purchases.total_cost;
                totalSales += sales.total_sales;
                totalClosingStock += closingStockValue;

                productAnalysis.push({
                    product_id: productId,
                    product_name: product.name,
                    opening_stock: openingStockValue,
                    purchases: purchases.total_cost,
                    sales: sales.total_sales,
                    closing_stock: closingStockValue,
                    gross_profit: grossProfit,
                    margin: margin,
                    units_sold: sales.total_quantity
                });
            }

            // Sort by gross profit (highest first)
            productAnalysis.sort((a, b) => b.gross_profit - a.gross_profit);

            // Generate table rows - only show products with transactions
            tableBodyEl.innerHTML = productAnalysis.map(product => {
                const profitClass = product.gross_profit >= 0 ? 'text-green-600' : 'text-red-600';
                const marginClass = product.margin >= 0 ? 'text-green-600' : 'text-red-600';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-2 font-medium">${product.product_name}</td>
                        <td class="border border-gray-200 px-4 py-2">${product.units_sold}</td>
                        <td class="border border-gray-200 px-4 py-2 text-gray-600">‚Çπ${product.opening_stock.toFixed(2)}</td>
                        <td class="border border-gray-200 px-4 py-2 text-blue-600">‚Çπ${product.purchases.toFixed(2)}</td>
                        <td class="border border-gray-200 px-4 py-2 text-green-600">‚Çπ${product.sales.toFixed(2)}</td>
                        <td class="border border-gray-200 px-4 py-2 text-purple-600">‚Çπ${product.closing_stock.toFixed(2)}</td>
                        <td class="border border-gray-200 px-4 py-2 font-medium ${profitClass}">‚Çπ${product.gross_profit.toFixed(2)}</td>
                        <td class="border border-gray-200 px-4 py-2 font-medium ${marginClass}">${product.margin}%</td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="8" class="border border-gray-200 px-4 py-4 text-center text-gray-500">No transaction data found for the selected period</td></tr>';

            // Calculate final totals using the formula: Sales + Closing Stock - Opening Stock - Purchase
            const finalGrossProfit = totalSales + totalClosingStock - totalOpeningStock - totalPurchases;

            // Update summary cards
            totalSalesEl.textContent = `‚Çπ${totalSales.toFixed(2)}`;
            totalPurchasesEl.textContent = `‚Çπ${totalPurchases.toFixed(2)}`;
            grossProfitEl.textContent = `‚Çπ${finalGrossProfit.toFixed(2)}`;
            profitMarginEl.textContent = `${totalSales > 0 ? ((finalGrossProfit / totalSales) * 100).toFixed(2) : '0.00'}%`;

            // Update overall status
            const statusClass = finalGrossProfit >= 0 ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
            const statusTextClass = finalGrossProfit >= 0 ? 'text-green-800' : 'text-red-800';
            const statusIcon = finalGrossProfit >= 0 ? 'üìà' : 'üìâ';

            overallStatusEl.className = `mb-6 p-4 rounded-lg border ${statusClass}`;
            overallStatusEl.innerHTML = `
                <div class="flex items-center">
                    <span class="text-2xl mr-3">${statusIcon}</span>
                    <div>
                        <h4 class="font-semibold ${statusTextClass}">
                            ${finalGrossProfit >= 0 ? 'Profit' : 'Loss'} of ‚Çπ${Math.abs(finalGrossProfit).toFixed(2)}
                        </h4>
                        <p class="text-sm text-gray-600">
                            Opening Stock: ‚Çπ${totalOpeningStock.toFixed(2)} | Purchases: ‚Çπ${totalPurchases.toFixed(2)} | Sales: ‚Çπ${totalSales.toFixed(2)} | Closing Stock: ‚Çπ${totalClosingStock.toFixed(2)}
                        </p>
                    </div>
                </div>
            `;

            // Update footer totals
            document.getElementById('total-opening-stock-footer').textContent = `‚Çπ${totalOpeningStock.toFixed(2)}`;
            document.getElementById('total-purchases-footer').textContent = `‚Çπ${totalPurchases.toFixed(2)}`;
            document.getElementById('total-sales-footer').textContent = `‚Çπ${totalSales.toFixed(2)}`;
            document.getElementById('total-closing-stock-footer').textContent = `‚Çπ${totalClosingStock.toFixed(2)}`;
            document.getElementById('total-profit-footer').textContent = `‚Çπ${finalGrossProfit.toFixed(2)}`;
            document.getElementById('total-margin-footer').textContent = `${totalSales > 0 ? ((finalGrossProfit / totalSales) * 100).toFixed(2) : '0.00'}%`;

        } catch (error) {
            console.error('Error calculating profit/loss:', error);
            tableBodyEl.innerHTML = `
                <tr>
                    <td colspan="8" class="border border-gray-200 px-4 py-4 text-center text-red-500">
                        Error calculating profit & loss: ${error.message}
                    </td>
                </tr>
            `;
        }
    }

    async function getStockSnapshot(date) {
        try {
            let url = `${backendURL}/products/stock-snapshot`;
            if (date) {
                const dateStr = date.toISOString().split('T')[0];
                url += `?date_to=${dateStr}`;
            }

            const response = await fetch(url, {
                headers: { 'ngrok-skip-browser-warning': 'true' }
            });

            if (response.ok) {
                return await response.json();
            }
            return [];
        } catch (error) {
            console.error('Error fetching stock snapshot:', error);
            return [];
        }
    }

    function getProductStockValue(stockData, productId, unitPrice) {
        const productStock = stockData.find(stock => stock.product_id == productId);
        const quantity = productStock ? (productStock.stock || 0) : 0;
        return quantity * unitPrice;
    }

    function applyProfitLossFilters() {
        const dateFrom = document.getElementById('pl-date-from').value;
        const dateTo = document.getElementById('pl-date-to').value;
        const productId = document.getElementById('pl-product-filter').value;

        let filteredSales = allSalesData;
        let filteredPurchases = allPurchasesData;

        // Filter by date range
        if (dateFrom) {
            filteredSales = filteredSales.filter(sale => {
                const saleDate = new Date(sale.date).toISOString().split('T')[0];
                return saleDate >= dateFrom;
            });
            filteredPurchases = filteredPurchases.filter(purchase => {
                const purchaseDate = new Date(purchase.date).toISOString().split('T')[0];
                return purchaseDate >= dateFrom;
            });
        }

        if (dateTo) {
            filteredSales = filteredSales.filter(sale => {
                const saleDate = new Date(sale.date).toISOString().split('T')[0];
                return saleDate <= dateTo;
            });
            filteredPurchases = filteredPurchases.filter(purchase => {
                const purchaseDate = new Date(purchase.date).toISOString().split('T')[0];
                return purchaseDate <= dateTo;
            });
        }

        // Filter by product
        if (productId) {
            filteredSales = filteredSales.filter(sale => sale.product_id == productId);
            filteredPurchases = filteredPurchases.filter(purchase => purchase.product_id == productId);
        }

        // Fetch products data for the filtered calculation
        fetch(`${backendURL}/products`, {
            headers: { 'ngrok-skip-browser-warning': 'true' }
        })
        .then(response => response.json())
        .then(productsData => {
            // If a specific product is selected, filter the products data as well
            if (productId) {
                productsData = productsData.filter(product => product.id == productId);
            }
            calculateAndDisplayProfitLoss(filteredSales, filteredPurchases, productsData);
        })
        .catch(error => {
            console.error('Error fetching products for filtered calculation:', error);
        });
    }

    function clearProfitLossFilters() {
        document.getElementById('pl-date-from').value = '';
        document.getElementById('pl-date-to').value = '';
        document.getElementById('pl-product-filter').value = '';

        // Recalculate with all data
        fetch(`${backendURL}/products`, {
            headers: { 'ngrok-skip-browser-warning': 'true' }
        })
        .then(response => response.json())
        .then(productsData => {
            calculateAndDisplayProfitLoss(allSalesData, allPurchasesData, productsData);
        })
        .catch(error => {
            console.error('Error fetching products for clear filters:', error);
        });
    }

    // ===== OPENING STOCK PAGE FUNCTIONS =====
    async function loadOpeningStockData() {
        const loadingEl = document.getElementById('opening-stock-loading');
        const errorEl = document.getElementById('opening-stock-error');
        const contentEl = document.getElementById('opening-stock-content');

        loadingEl.classList.remove('hidden');
        errorEl.classList.add('hidden');
        contentEl.classList.add('hidden');

        try {
            // Fetch opening stock register data with creation dates
            const response = await fetch(`${backendURL}/opening-stock-register`, {
                headers: {
                    'ngrok-skip-browser-warning': 'true'
                }
            });

            if (!response.ok) throw new Error('Failed to fetch opening stock register');

            const products = await response.json();
            console.log('üì¶ Opening stock register received:', products);

            if (!Array.isArray(products) || products.length === 0) {
                throw new Error('No products found in opening stock register');
            }

            displayOpeningStockData(products);

            loadingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');

        } catch (error) {
            console.error('Error loading opening stock data:', error);
            loadingEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            errorEl.innerHTML = `<p class="text-red-500">Error loading opening stock data: ${error.message}</p>`;
        }
    }

    function displayOpeningStockData(products) {
        const tableBodyEl = document.getElementById('opening-stock-table-body');
        const totalProductsEl = document.getElementById('total-opening-products');
        const totalStockEl = document.getElementById('total-opening-stock');
        const totalValueEl = document.getElementById('total-opening-value');
        const avgAgeEl = document.getElementById('avg-stock-age');

        if (products.length === 0) {
            tableBodyEl.innerHTML = `
                <tr>
                    <td colspan="9" class="border border-gray-200 px-4 py-4 text-center text-gray-500">
                        No products found
                    </td>
                </tr>
            `;
            totalProductsEl.textContent = '0';
            totalStockEl.textContent = '0';
            totalValueEl.textContent = '‚Çπ0.00';
            avgAgeEl.textContent = '0 days';
            return;
        }

        let totalProducts = 0;
        let totalStock = 0;
        let totalStockValue = 0;
        let totalAgeDays = 0;

        // Sort products by creation date (newest first)
        products.sort((a, b) => {
            const dateA = new Date(a.created_at || Date.now());
            const dateB = new Date(b.created_at || Date.now());
            return dateB - dateA;
        });

        // Generate table rows
        tableBodyEl.innerHTML = products.map(product => {
            totalProducts++;
            const stock = product.stock || 0;
            totalStock += stock;

            const purchasePrice = product.purchase_price || 0;
            const stockValue = stock * purchasePrice;
            totalStockValue += stockValue;

            // Calculate age in days
            const createdDate = new Date(product.created_at || Date.now());
            const now = new Date();
            const ageDays = Math.floor((now - createdDate) / (1000 * 60 * 60 * 24));
            totalAgeDays += ageDays;

            const formattedDate = formatDateTime(product.created_at);
            const unitDisplay = getUnitDisplay(product.unit_type || 'pcs', stock);

            let status = 'Active';
            let statusClass = 'bg-green-100 text-green-800';

            if (stock === 0) {
                status = 'Out of Stock';
                statusClass = 'bg-red-100 text-red-800';
            } else if (stock <= 10) {
                status = 'Low Stock';
                statusClass = 'bg-yellow-100 text-yellow-800';
            }

            return `
                <tr class="hover:bg-gray-50">
                    <td class="border border-gray-200 px-4 py-2 font-medium">${product.id}</td>
                    <td class="border border-gray-200 px-4 py-2 font-medium">${product.name}</td>
                    <td class="border border-gray-200 px-4 py-2">${product.unit_type || 'pcs'}</td>
                    <td class="border border-gray-200 px-4 py-2 ${stock <= 10 ? 'text-red-600 font-bold' : ''}">${unitDisplay}</td>
                    <td class="border border-gray-200 px-4 py-2">‚Çπ${purchasePrice.toFixed(2)}</td>
                    <td class="border border-gray-200 px-4 py-2">‚Çπ${(product.selling_price || 0).toFixed(2)}</td>
                    <td class="border border-gray-200 px-4 py-2 font-medium">‚Çπ${stockValue.toFixed(2)}</td>
                    <td class="border border-gray-200 px-4 py-2 text-sm text-gray-600">${formattedDate.date}<br><span class="text-xs">${ageDays} days ago</span></td>
                    <td class="border border-gray-200 px-4 py-2">
                        <span class="text-xs px-2 py-1 rounded-full ${statusClass}">${status}</span>
                    </td>
                </tr>
            `;
        }).join('');

        // Calculate average age
        const avgAge = totalProducts > 0 ? Math.round(totalAgeDays / totalProducts) : 0;

        // Update summary statistics
        totalProductsEl.textContent = totalProducts;
        totalStockEl.textContent = totalStock;
        totalValueEl.textContent = `‚Çπ${totalStockValue.toFixed(2)}`;
        avgAgeEl.textContent = `${avgAge} days`;

        // Update footer totals
        document.getElementById('total-initial-stock-footer').textContent = totalStock;
        document.getElementById('total-stock-value-footer').textContent = `‚Çπ${totalStockValue.toFixed(2)}`;
    }

    // ===== UTILITY FUNCTIONS =====
    function showNotification(message) {
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) existingNotification.remove();

        const notification = document.createElement('div');
        notification.className = 'notification fixed top-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg z-50';
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // ===== DOWNLOAD DATA FUNCTION =====
    function downloadData(dataType) {
        try {
            // Special handling: all pages except profit-loss use -ledger suffix
            let endpoint;
            if (dataType === 'profit-loss') {
                endpoint = 'profit-loss';
            } else if (dataType === 'all-products-stock') {
                endpoint = 'all-products-stock';
            } else if (dataType === 'stock') {
                endpoint = 'stock-ledger';
            } else {
                endpoint = `${dataType}-ledger`;
            }

            const baseUrl = `${backendURL}/download/${endpoint}`;

            // Get filter values based on data type
            let params = new URLSearchParams();

            if (dataType === 'sales') {
                const dateFrom = document.getElementById('sales-date-from')?.value;
                const dateTo = document.getElementById('sales-date-to')?.value;
                const productId = document.getElementById('sales-product-filter')?.value;

                if (dateFrom) params.append('start_date', dateFrom);
                if (dateTo) params.append('end_date', dateTo);
                if (productId) params.append('product_id', productId);
            } else if (dataType === 'purchase') {
                const dateFrom = document.getElementById('purchase-date-from')?.value;
                const dateTo = document.getElementById('purchase-date-to')?.value;
                const productId = document.getElementById('purchase-product-filter')?.value;

                if (dateFrom) params.append('start_date', dateFrom);
                if (dateTo) params.append('end_date', dateTo);
                if (productId) params.append('product_id', productId);
            } else if (dataType === 'stock') {
                const dateFrom = document.getElementById('stock-date-from')?.value;
                const dateTo = document.getElementById('stock-date-to')?.value;
                const productId = document.getElementById('stock-product-filter')?.value;

                if (dateFrom && dateFrom.trim() !== '') params.append('date_from', dateFrom);
                if (dateTo && dateTo.trim() !== '') params.append('date_to', dateTo);
                if (productId && productId.trim() !== '') params.append('product_id', productId);
            } else if (dataType === 'profit-loss') {
                const dateFrom = document.getElementById('pl-date-from')?.value;
                const dateTo = document.getElementById('pl-date-to')?.value;
                const productId = document.getElementById('pl-product-filter')?.value;

                if (dateFrom) params.append('start_date', dateFrom);
                if (dateTo) params.append('end_date', dateTo);
                if (productId) params.append('product_id', productId);
            }

            const url = params.toString() ? `${baseUrl}?${params.toString()}` : baseUrl;

            console.log(`üì• Downloading ${dataType} data from: ${url}`);

            // Create a temporary link and trigger download
            const link = document.createElement('a');
            link.href = url;
            link.download = `${dataType}_data.csv`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification(`‚úÖ ${dataType.charAt(0).toUpperCase() + dataType.slice(1)} data download started!`);

        } catch (error) {
            console.error(`Error downloading ${dataType} data:`, error);
            showNotification(`‚ùå Error downloading ${dataType} data: ${error.message}`);
        }
    }

    // ===== REGISTRATION FORM FUNCTIONS =====
    function showRegistrationForm() {
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('register-form').classList.remove('hidden');
        document.getElementById('login-status').classList.add('hidden');
    }

    function showLoginForm() {
        document.getElementById('register-form').classList.add('hidden');
        document.getElementById('login-form').classList.remove('hidden');
        document.getElementById('login-status').classList.add('hidden');
        document.getElementById('registration-form').reset();
    }

    async function performRegistration() {
        const registerBtn = document.getElementById('register-submit-btn');
        const statusEl = document.getElementById('login-status');
        const statusMessageEl = document.getElementById('login-status-message');

        // Get form values
        const username = document.getElementById('register-username').value.trim();
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const confirmPassword = document.getElementById('register-confirm-password').value;

        // Validate form
        if (!username || !email || !password || !confirmPassword) {
            showRegistrationError('Please fill in all fields');
            return;
        }

        if (username.length < 3) {
            showRegistrationError('Username must be at least 3 characters long');
            return;
        }

        if (password.length < 6) {
            showRegistrationError('Password must be at least 6 characters long');
            return;
        }

        if (password !== confirmPassword) {
            showRegistrationError('Passwords do not match');
            return;
        }

        // Basic email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showRegistrationError('Please enter a valid email address');
            return;
        }

        // Disable button and show loading
        registerBtn.disabled = true;
        registerBtn.textContent = 'Creating Account...';

        try {
            console.log('üìù Attempting registration for:', username);

            const response = await fetch(`${backendURL}/auth/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'ngrok-skip-browser-warning': 'true'
                },
                body: new URLSearchParams({
                    username: username,
                    email: email,
                    password: password
                })
            });

            console.log('üìä Registration response status:', response.status);

            if (response.ok) {
                const data = await response.json();
                console.log('‚úÖ Registration successful:', data);

                // Show success message and switch to login
                statusEl.classList.remove('hidden');
                statusMessageEl.className = 'text-green-600';
                statusMessageEl.textContent = 'Account created successfully! You can now log in.';

                // Clear form and show login
                document.getElementById('registration-form').reset();
                setTimeout(() => {
                    showLoginForm();
                    statusMessageEl.textContent = '';
                    statusEl.classList.add('hidden');
                }, 2000);

            } else {
                const errorData = await response.json();
                console.log('‚ùå Registration failed:', errorData);
                showRegistrationError(errorData.detail || 'Registration failed');
            }

        } catch (error) {
            console.error('üí• Network error during registration:', error);
            showRegistrationError('Network error. Please try again.');
        } finally {
            registerBtn.disabled = false;
            registerBtn.textContent = 'Register';
        }
    }

    function showRegistrationError(message) {
        const statusEl = document.getElementById('login-status');
        const statusMessageEl = document.getElementById('login-status-message');
        statusEl.classList.remove('hidden');
        statusMessageEl.className = 'text-red-600';
        statusMessageEl.textContent = message;
    }

    // ===== AUTHENTICATION FUNCTIONS =====
    let currentUser = null;

    // Simplified authentication check with robust error handling
    async function checkAuthentication() {
        console.log('üîç Checking authentication...');
        const token = localStorage.getItem('access_token');
        const currentPath = window.location.pathname;

        // If we're on login.html, don't redirect
        if (currentPath.includes('login.html')) {
            console.log('üìç On login page, skipping auth check');
            return false;
        }

        // If no token, redirect immediately to login
        if (!token) {
            console.log('üè† No token found - redirecting to login page');
            window.location.href = 'login.html';
            return false;
        }

        // Skip backend validation for now - just show the app
        console.log('üîë Token found, showing app directly');
        currentUser = { username: 'User' }; // Default user data
        showMainKiranaApp();
        return true;
    }

    // Show the main Kirana Store application
    function showMainKiranaApp() {
        console.log('üè† Showing Kirana Store main application');

        // Hide loading page
        const loadingPage = document.getElementById('page-loading');
        if (loadingPage) {
            loadingPage.classList.remove('active');
        }

        // Make sure home page is active
        const homePage = document.getElementById('page-home');
        if (homePage) {
            homePage.classList.add('active');
        }

        // Show user controls if logged in
        const userControls = document.getElementById('user-controls');
        if (userControls) {
            userControls.classList.remove('hidden');
        }

        // Update welcome message
        const welcomeEl = document.getElementById('welcome-message');
        if (welcomeEl && currentUser) {
            welcomeEl.innerHTML = `Welcome, ${currentUser.username || 'User'}!`;
        }

        console.log('‚úÖ Kirana Store app displayed successfully');
    }

    // Just in case - force show app if it gets stuck
    function forceShowApp() {
        console.log('‚ö° Force showing app as fallback');
        currentUser = { username: 'User' };
        showMainKiranaApp();
    }

    // Fallback: if app doesn't load after 10 seconds, force it
    setTimeout(forceShowApp, 10000);

    function showMainApp() {
        console.log('üè† Showing main app');
        console.log('üë§ Current user:', currentUser);
        console.log('üîë Token exists:', !!localStorage.getItem('access_token'));

        // Hide loading page and all other pages
        const loadingPage = document.getElementById('page-loading');
        if (loadingPage) {
            loadingPage.classList.remove('active');
        }

        Object.values(pages).forEach(page => page.classList.remove('active'));
        const loginPage = document.getElementById('page-login');
        if (loginPage) loginPage.classList.remove('active');

        pages.home.classList.add('active');
        document.getElementById('back-to-home').classList.add('hidden');

        // Show logout button when user is logged in
        document.getElementById('user-controls').classList.remove('hidden');

        // Update welcome message with username
        const welcomeEl = document.getElementById('welcome-message');
        if (currentUser && currentUser.username) {
            welcomeEl.innerHTML = `Welcome, ${currentUser.username}!`;
        } else {
            welcomeEl.innerHTML = 'Welcome!';
        }

        // Show settings button for admin user (raza123) in header
        const settingsBtn = document.getElementById('settings-btn');
        if (currentUser && currentUser.username === 'raza123') {
            console.log('üëë Admin user detected, showing settings');
            if (settingsBtn) settingsBtn.classList.remove('hidden');
        } else {
            console.log('üë§ Regular user, hiding admin settings');
            if (settingsBtn) settingsBtn.classList.add('hidden');
        }

        console.log('‚úÖ Main app displayed successfully');
    }

    async function performLogin(username, password) {
        const submitBtn = document.getElementById('login-submit-btn');
        const statusEl = document.getElementById('login-status');
        const statusMessageEl = document.getElementById('login-status-message');

        submitBtn.disabled = true;
        submitBtn.textContent = 'Signing In...';

        // Add logging
        console.log('üîê Attempting login for user:', username);

        try {
            const loginUrl = `${backendURL}/auth/login`;
            console.log('üì° Login URL:', loginUrl);

            const response = await fetch(loginUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                },
                body: JSON.stringify({ username, password })
            });

            console.log('üìä Login response status:', response.status);

            const data = await response.json();
            console.log('üìÑ Login response data keys:', Object.keys(data));
            console.log('üìÑ Login response data values:', data);
            console.log('üìÑ access_token in data?', 'access_token' in data);
            console.log('üìÑ data.access_token value:', data.access_token);

            if (response.ok) {
                if (data.access_token) {
                    localStorage.setItem('access_token', data.access_token);
                    currentUser = data.user;
                    statusEl.classList.remove('hidden');
                    statusMessageEl.className = 'text-green-600';
                    statusMessageEl.textContent = 'Login successful! Redirecting...';
                    console.log('‚úÖ Login successful, token stored');
                    setTimeout(() => {
                        console.log('üîÑ Calling showMainApp()');
                        showMainApp();
                    }, 1000);
                } else {
                    console.log('‚ùå No access_token in response');
                    statusEl.classList.remove('hidden');
                    statusMessageEl.className = 'text-red-600';
                    statusMessageEl.textContent = 'Invalid response from server';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Sign In';
                }
            } else {
                console.log('‚ùå Login failed:', data.detail || 'Unknown error');
                statusEl.classList.remove('hidden');
                statusMessageEl.className = 'text-red-600';
                statusMessageEl.textContent = data.detail || 'Login failed';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Sign In';
            }
        } catch (error) {
            console.error('üí• Network error during login:', error);
            statusEl.classList.remove('hidden');
            statusMessageEl.className = 'text-red-600';
            statusMessageEl.textContent = 'Network error. Please try again.';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Sign In';
        }
    }

    function logout() {
        localStorage.removeItem('access_token');
        currentUser = null;
        // Hide all content pages including loading page
        Object.values(pages).forEach(page => page.classList.remove('active'));
        const loadingPage = document.getElementById('page-loading');
        if (loadingPage) loadingPage.classList.remove('active');
        // Hide user controls
        document.getElementById('user-controls').classList.add('hidden');

        // Show login page within the same app
        const loginPage = document.getElementById('page-login');
        if (loginPage) {
            loginPage.classList.add('active');
        } else {
            console.error('Login page not found!');
        }
    }

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', async function() {
            backButton.addEventListener('click', backToHome);

            // Check authentication on page load
            await checkAuthentication();

            // LOGIN FORM HANDLER
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                await performLogin(username, password);
            });

            // REGISTRATION TOGGLE HANDLERS
            document.getElementById('show-register-btn').addEventListener('click', showRegistrationForm);
            document.getElementById('back-to-login-btn').addEventListener('click', showLoginForm);

            // REGISTRATION FORM HANDLER
            document.getElementById('registration-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await performRegistration();
            });

            // LOGOUT BUTTON HANDLER
            document.getElementById('logout-btn').addEventListener('click', function() {
                // Remove token from localStorage
                localStorage.removeItem('access_token');
                // Clear current user
                currentUser = null;
                // Hide all content pages including loading page
                Object.values(pages).forEach(page => page.classList.remove('active'));
                const loadingPage = document.getElementById('page-loading');
                if (loadingPage) {
                    loadingPage.classList.remove('active');
                }
                // Hide user controls
                document.getElementById('user-controls').classList.add('hidden');

                // Show login page within the same app
                const loginPage = document.getElementById('page-login');
                if (loginPage) {
                    loginPage.classList.add('active');
                } else {
                    console.error('Login page not found!');
                }
            });

        // CART AND PRODUCT INTERACTIONS
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('add-to-cart-btn')) {
                const productId = e.target.dataset.id;
                addToCart(productId);
            }

            if (e.target.classList.contains('increase-quantity')) {
                const productId = e.target.dataset.id;
                increaseQuantity(productId);
            }

            if (e.target.classList.contains('decrease-quantity')) {
                const productId = e.target.dataset.id;
                decreaseQuantity(productId);
            }

            if (e.target.classList.contains('remove-item')) {
                const productId = e.target.dataset.id;
                if (cart[productId]) {
                    delete cart[productId];
                    updateCartUI();
                    showNotification('Item removed from cart');
                }
            }

            // Handle delete buttons for sales and purchases
            if (e.target.classList.contains('delete-sale')) {
                const recordId = e.target.dataset.id;
                deleteRecord(recordId, 'sale');
            }

            if (e.target.classList.contains('delete-purchase')) {
                const recordId = e.target.dataset.id;
                deleteRecord(recordId, 'purchase');
            }

            // Handle delete product buttons
            if (e.target.classList.contains('delete-product-btn')) {
                const productId = e.target.dataset.id;
                const productName = e.target.dataset.name;
                deleteProduct(productId, productName);
            }
        });

        document.getElementById('close-modal-button').addEventListener('click', () => {
            document.getElementById('cart-modal').classList.add('hidden');
            document.getElementById('cart-modal').classList.remove('flex');
        });

        document.getElementById('whatsapp-checkout-button').addEventListener('click', generateWhatsAppOrder);

        // Auto-populate prices when product is selected in purchase form
        document.getElementById('purchase-product').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const unitCostField = document.getElementById('purchase-unit-cost');
            const unitTypeField = document.getElementById('purchase-unit-type');

            if (selectedOption.value) {
                unitCostField.value = selectedOption.dataset.purchasePrice || '';
                unitTypeField.value = selectedOption.dataset.unitType || '';
            } else {
                unitCostField.value = '';
                unitTypeField.value = '';
            }
        });

        document.getElementById('purchase-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const productId = document.getElementById('purchase-product').value;
            const quantity = document.getElementById('purchase-quantity').value;
            const unitCost = document.getElementById('purchase-unit-cost').value;

            if (!productId) {
                alert('Please select a product');
                return;
            }

            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('Please log in first');
                showLoginPage();
                return;
            }

            try {
                const response = await fetch(`${backendURL}/purchases/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({
                        product_id: parseInt(productId),
                        quantity: parseInt(quantity),
                        unit_cost: parseFloat(unitCost)
                    })
                });

                if (response.ok) {
                    alert('Purchase recorded successfully!');
                    document.getElementById('purchase-form').reset();
                    await loadPurchaseHistory();
                    await loadProductDropdown('purchase-product');
                } else {
                    const errorData = await response.json();
                    alert('Error recording purchase: ' + (errorData.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Error recording purchase: ' + error.message);
            }
        });

        document.getElementById('create-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('product-name').value;
            const purchasePrice = document.getElementById('product-purchase-price').value;
            const sellingPrice = document.getElementById('product-selling-price').value;
            const unitType = document.getElementById('product-unit-type').value;
            const stock = document.getElementById('product-stock').value;

            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('Please log in first');
                showLoginPage();
                return;
            }

            try {
                await createProduct({
                    name: name,
                    purchase_price: parseFloat(purchasePrice),
                    selling_price: parseFloat(sellingPrice),
                    unit_type: unitType,
                    stock: parseInt(stock) || 0
                });

                alert('Product created successfully!');
                document.getElementById('create-product-form').reset();
                await loadExistingProducts();

            } catch (error) {
                alert('Error creating product: ' + error.message);
            }
        });

        // ===== SETTINGS PAGE HELPER FUNCTIONS =====
        function showAddUserForm() {
            const formEl = document.getElementById('add-user-form');
            if (formEl) {
                formEl.classList.remove('hidden');
                // Scroll to form
                formEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                console.error('Add user form not found');
            }
        }

        function hideAddUserForm() {
            document.getElementById('add-user-form').classList.add('hidden');
        }

        function addUser() {
            const username = document.getElementById('new-username').value.trim();
            const password = document.getElementById('new-password').value.trim();
            const email = document.getElementById('new-email').value.trim();
            const role = document.getElementById('new-role').value;

            if (!username || !password || !email || !role) {
                alert('Please fill in all fields');
                return;
            }

            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('Please log in first');
                showLoginPage();
                return;
            }

            const formData = new FormData();
            formData.append('username', username);
            formData.append('password', password);
            formData.append('email', email);
            formData.append('role', role);

            fetch(`${backendURL}/users/`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'ngrok-skip-browser-warning': 'true'
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.detail || `HTTP ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ User created:', data);
                showNotification('User created successfully!');
                hideAddUserForm();
                // Clear form
                document.getElementById('new-username').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('new-email').value = '';
                document.getElementById('new-role').value = 'EMPLOYEE';
                // Reset permissions checkboxes
                clearAllPermissions();
                // Reload users list to show the new user
                loadUsers();
                loadUsersWithActions();
            })
            .catch(error => {
                console.error('‚ùå Error creating user:', error);
                alert(`Error creating user: ${error.message}`);
            });
        }

        function loadUsers() {
            const loadingEl = document.getElementById('users-loading');
            const errorEl = document.getElementById('users-error');
            const contentEl = document.getElementById('users-list');
            const tbodyEl = document.getElementById('users-table-body');

            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            contentEl.classList.add('hidden');

            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('Please log in first');
                showLoginPage();
                return;
            }

            fetch(`${backendURL}/users`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'ngrok-skip-browser-warning': 'true'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(users => {
                console.log('‚úÖ Users loaded:', users);

                if (!Array.isArray(users) || users.length === 0) {
                    tbodyEl.innerHTML = '<tr><td colspan="8" class="border border-gray-200 px-4 py-4 text-center text-gray-500">No users found</td></tr>';
                } else {
                     // Sort users by ID
                     users.sort((a, b) => b.id - a.id); // Newest first
                    tbodyEl.innerHTML = users.map(user => `
                        <tr class="hover:bg-gray-50">
                            <td class="border border-gray-200 px-4 py-2 font-medium">${user.id}</td>
                            <td class="border border-gray-200 px-4 py-2 font-medium">${user.username}</td>
                            <td class="border border-gray-200 px-4 py-2">${user.email}</td>
                            <td class="border border-gray-200 px-4 py-2">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${getRoleColor(user.role)}">
                                    ${user.role}
                                </span>
                            </td>
                            <td class="border border-gray-200 px-4 py-2">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${user.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                            <td class="border border-gray-200 px-4 py-2 text-sm text-gray-600">Last Login</td>
                            <td class="border border-gray-200 px-4 py-2">${getUserPermissions(user.role)}</td>
                            <td class="border border-gray-200 px-4 py-2">
                                <button class="edit-user-btn text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition-colors"
                                        data-id="${user.id}" data-username="${user.username}" data-email="${user.email}" data-role="${user.role}" data-active="${user.is_active}">
                                    Edit
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }

                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');
            })
            .catch(error => {
                console.error('‚ùå Error loading users:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.innerHTML = `<p class="text-red-500">Error loading users: ${error.message}</p>`;
            });
        }

        function getRoleColor(role) {
            switch(role.toLowerCase()) {
                case 'admin':
                    return 'bg-red-100 text-red-800';
                case 'manager':
                    return 'bg-blue-100 text-blue-800';
                case 'employee':
                    return 'bg-green-100 text-green-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        function getUserPermissions(role) {
            switch(role.toLowerCase()) {
                case 'admin':
                    return 'All Access';
                case 'manager':
                    return 'Limited Admin';
                case 'employee':
                    return 'Basic Access';
                default:
                    return 'Unknown';
            }
        }

        // ===== ADD USER BUTTON HANDLER =====
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'add-user-btn') {
                e.preventDefault();
                showAddUserForm();
                return;
            }

            if (e.target && e.target.classList.contains('edit-user-btn')) {
                const userId = e.target.dataset.id;
                const username = e.target.dataset.username;
                const email = e.target.dataset.email;
                const role = e.target.dataset.role;
                const isActive = e.target.dataset.active === 'true';

                editUser(userId, username, email, role, isActive);
                return;
            }
        });

        function editUser(userId, username, email, role, isActive) {
            // Populate edit form with user data
            document.getElementById('edit-user-id').value = userId;
            document.getElementById('edit-username').value = username;
            document.getElementById('edit-email').value = email;
            document.getElementById('edit-role').value = role;
            document.getElementById('edit-is-active').checked = isActive;

            // Show the edit form
            document.getElementById('edit-user-form').classList.remove('hidden');

            // Hide add user form if it's visible
            document.getElementById('add-user-form').classList.add('hidden');
        }

        function updateUser() {
            const userId = document.getElementById('edit-user-id').value;
            const username = document.getElementById('edit-username').value.trim();
            const email = document.getElementById('edit-email').value.trim();
            const password = document.getElementById('edit-password').value.trim();
            const role = document.getElementById('edit-role').value;
            const isActive = document.getElementById('edit-is-active').checked;

            if (!username || !email || !role) {
                alert('Username, email, and role are required fields');
                return;
            }

            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('Please log in first');
                showLoginPage();
                return;
            }

            // Prepare update data
            const updateData = {
                username: username,
                email: email,
                role: role,
                is_active: isActive
            };

            // Only include password if it was provided
            if (password) {
                updateData.password = password;
            }

            fetch(`${backendURL}/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    'ngrok-skip-browser-warning': 'true'
                },
                body: JSON.stringify(updateData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.detail || `HTTP ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ User updated:', data);
                showNotification('User updated successfully!');
                hideEditUserForm();
                // Clear form
                document.getElementById('edit-user-id').value = '';
                document.getElementById('edit-username').value = '';
                document.getElementById('edit-email').value = '';
                document.getElementById('edit-password').value = '';
                document.getElementById('edit-role').value = 'EMPLOYEE';
                document.getElementById('edit-is-active').checked = true;
                // Reload users list
                loadUsers();
            })
            .catch(error => {
                console.error('‚ùå Error updating user:', error);
                alert(`Error updating user: ${error.message}`);
            });
        }

        function hideEditUserForm() {
            document.getElementById('edit-user-form').classList.remove('hidden');
        }

        // ===== PERMISSION HELPER FUNCTIONS =====
        function selectAllPermissions() {
            const checkboxes = document.querySelectorAll('#add-user-form input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        function clearAllPermissions() {
            const checkboxes = document.querySelectorAll('#add-user-form input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        // Update addUser function to include permissions
        function addUser() {
            const username = document.getElementById('new-username').value.trim();
            const password = document.getElementById('new-password').value.trim();
            const email = document.getElementById('new-email').value.trim();
            const role = document.getElementById('new-role').value;

            if (!username || !password || !email || !role) {
                alert('Please fill in all fields');
                return;
            }

            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('Please log in first');
                showLoginPage();
                return;
            }

            // Collect permissions
            const permissions = {
                sales: document.getElementById('perm-sales').checked,
                purchase: document.getElementById('perm-purchase').checked,
                create_product: document.getElementById('perm-create-product').checked,
                delete_product: document.getElementById('perm-delete-product').checked,
                sales_ledger: document.getElementById('perm-sales-ledger').checked,
                purchase_ledger: document.getElementById('perm-purchase-ledger').checked,
                stock_ledger: document.getElementById('perm-stock-ledger').checked,
                profit_loss: document.getElementById('perm-profit-loss').checked,
                opening_stock: document.getElementById('perm-opening-stock').checked,
                user_management: document.getElementById('perm-user-management').checked
            };

            const formData = new FormData();
            formData.append('username', username);
            formData.append('password', password);
            formData.append('email', email);
            formData.append('role', role);
            formData.append('permissions', JSON.stringify(permissions));

            fetch(`${backendURL}/users/`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'ngrok-skip-browser-warning': 'true'
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.detail || `HTTP ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ User created:', data);
                showNotification('User created successfully!');

                // Hide form and clear fields
                hideAddUserForm();
                document.getElementById('new-username').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('new-email').value = '';
                document.getElementById('new-role').value = 'EMPLOYEE';
                // Reset permissions (some checked, others unchecked)
                clearAllPermissions();
                document.getElementById('perm-sales').checked = true;
                document.getElementById('perm-purchase').checked = true;
                document.getElementById('perm-create-product').checked = true;
                document.getElementById('perm-sales-ledger').checked = true;
                document.getElementById('perm-purchase-ledger').checked = true;
                document.getElementById('perm-stock-ledger').checked = true;

                // Reload users list
                loadUsers();
            })
            .catch(error => {
                console.error('‚ùå Error creating user:', error);
                alert(`Error creating user: ${error.message}`);
            });
        }

        // Update the settings page navigation
        function loadPageData(pageName) {
            switch(pageName) {
                case 'sales':
                    fetchProducts();
                    break;
                case 'purchase':
                    loadPurchasePage();
                    break;
                case 'create':
                    loadCreatePage();
                    break;
                case 'delete-product':
                    loadDeleteProductPage();
                    break;
                case 'all-products-ledger':
                    loadAllProductsLedger();
                    break;
                case 'sales-ledger':
                    loadSalesLedger();
                    break;
                case 'purchase-ledger':
                    loadPurchaseLedger();
                    break;
                case 'profit-loss':
                    loadProfitLossData();
                    break;
                case 'opening-stock':
                    loadOpeningStockData();
                    break;
                case 'settings':
                    loadUsers();
                    loadCurrentUserPermissions();
                    loadUsersWithActions(); // Load users for dropdown selectors
                    break;
            }
        }

        // ===== SETTINGS PAGE USER MANAGEMENT FUNCTIONS =====
        function loadUsersWithActions() {
            const token = localStorage.getItem('access_token');
            if (!token) return;

            // Load users for edit selector
            fetch(`${backendURL}/users`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'ngrok-skip-browser-warning': 'true'
                }
            })
            .then(response => response.json())
            .then(users => {
                if (Array.isArray(users) && users.length > 0) {
                    // Populate edit user selector
                    const editSelector = document.getElementById('edit-user-selector');
                    const deleteSelector = document.getElementById('delete-user-selector');
                    const permissionsSelector = document.getElementById('permissions-user-selector');

                    // Clear existing options except first
                    editSelector.innerHTML = '<option value="">Choose a user...</option>';
                    deleteSelector.innerHTML = '<option value="">Choose a user...</option>';
                    permissionsSelector.innerHTML = '<option value="">Choose a user...</option>';

                    // Add users to all selectors
                    users.forEach(user => {
                        const option = `<option value="${user.id}" data-username="${user.username}" data-email="${user.email}" data-role="${user.role}" data-active="${user.is_active}">${user.username}</option>`;
                        editSelector.insertAdjacentHTML('beforeend', option);
                        deleteSelector.insertAdjacentHTML('beforeend', option);
                        permissionsSelector.insertAdjacentHTML('beforeend', option);
                    });

                    console.log('‚úÖ Users loaded into selectors');
                }
            })
            .catch(error => console.error('Error loading users for selectors:', error));
        }

        // Handle edit user selector change
        function handleEditUserSelection() {
            const selector = document.getElementById('edit-user-selector');
            const selectedOption = selector.options[selector.selectedIndex];
            const editForm = document.getElementById('edit-user-form');

            if (!selectedOption || selectedOption.value === '') {
                editForm.classList.add('hidden');
                return;
            }

            // Populate edit form with user data
            document.getElementById('edit-user-id').value = selectedOption.value;
            document.getElementById('edit-username').value = selectedOption.dataset.username || '';
            document.getElementById('edit-email').value = selectedOption.dataset.email || '';
            document.getElementById('edit-role').value = selectedOption.dataset.role || 'EMPLOYEE';
            document.getElementById('edit-is-active').checked = selectedOption.dataset.active === 'true';

            // Clear password field for security
            document.getElementById('edit-password').value = '';

            editForm.classList.remove('hidden');
        }

        // Handle delete user selector change
        function handleDeleteUserSelection() {
            const selector = document.getElementById('delete-user-selector');
            const selectedOption = selector.options[selector.selectedIndex];
            const confirmationDiv = document.getElementById('delete-user-confirmation');

            if (!selectedOption || selectedOption.value === '') {
                confirmationDiv.classList.add('hidden');
                return;
            }

            // Populate confirmation message
            const username = selectedOption.dataset.username;
            document.getElementById('delete-user-info').innerHTML = `
                Are you sure you want to delete user "<strong>${username}</strong>"?<br>
                <span class="text-sm text-gray-600">This action cannot be undone and will permanently remove the user account.</span>
            `;
            confirmationDiv.classList.remove('hidden');
        }

        function deleteSelectedUser() {
            const selector = document.getElementById('delete-user-selector');
            const selectedValue = selector.value;

            if (!selectedValue || selectedValue === '') {
                alert('Please select a user to delete');
                return;
            }

            const selectedOption = selector.options[selector.selectedIndex];
            const username = selectedOption.dataset.username;

            if (!confirm(`Are you sure you want to permanently delete user "${username}"?\n\nThis action cannot be undone!`)) {
                return;
            }

            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('Please log in first');
                return;
            }

            fetch(`${backendURL}/users/${selectedValue}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'ngrok-skip-browser-warning': 'true'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                showNotification(`User "${username}" deleted successfully!`);

                // Reset form
                document.getElementById('delete-user-confirmation').classList.add('hidden');
                selector.value = '';
                cancelDeleteUser();

                // Reload users
                loadUsersWithActions();
                loadUsers();
            })
            .catch(error => {
                console.error('Error deleting user:', error);
                alert(`Error deleting user: ${error.message}`);
            });
        }

        function cancelDeleteUser() {
            document.getElementById('delete-user-selector').value = '';
            document.getElementById('delete-user-confirmation').classList.add('hidden');
        }

        // Handle permissions user selector change
        function loadUserPermissions() {
            const selector = document.getElementById('permissions-user-selector');
            const selectedValue = selector.value;
            const displayDiv = document.getElementById('current-permissions-display');
            const updateForm = document.getElementById('permissions-update-form');
            const usernameSpan = document.getElementById('permissions-user-name');

            if (!selectedValue || selectedValue === '') {
                displayDiv.classList.add('hidden');
                updateForm.classList.add('hidden');
                return;
            }

            // Set username display
            usernameSpan.textContent = selector.options[selector.selectedIndex].text;

            const token = localStorage.getItem('access_token');
            if (!token) return;

            // Load user's permissions
            fetch(`${backendURL}/users/${selectedValue}/permissions`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'ngrok-skip-browser-warning': 'true'
                }
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            })
            .then(permissions => {
                // Display current permissions
                const permissionsList = document.getElementById('current-permissions-list');
                const featureBadges = [
                    { name: 'Sales', key: 'sales' },
                    { name: 'Purchase', key: 'purchase' },
                    { name: 'Create Product', key: 'create_product' },
                    { name: 'Delete Product', key: 'delete_product' },
                    { name: 'Sales Ledger', key: 'sales_ledger' },
                    { name: 'Purchase Ledger', key: 'purchase_ledger' },
                    { name: 'Stock Ledger', key: 'stock_ledger' },
                    { name: 'Profit & Loss', key: 'profit_loss' },
                    { name: 'Opening Stock', key: 'opening_stock' },
                    { name: 'User Management', key: 'user_management' }
                ];

                permissionsList.innerHTML = featureBadges.map(feature => `
                    <div class="text-center">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${permissions[feature.key] ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${permissions[feature.key] ? '‚úì' : '‚úó'} ${feature.name}
                        </span>
                    </div>
                `).join('');

                displayDiv.classList.remove('hidden');

                // Populate update form
                document.getElementById('perm-update-sales').checked = permissions.sales || false;
                document.getElementById('perm-update-purchase').checked = permissions.purchase || false;
                document.getElementById('perm-update-create-product').checked = permissions.create_product || false;
                document.getElementById('perm-update-delete-product').checked = permissions.delete_product || false;
                document.getElementById('perm-update-sales-ledger').checked = permissions.sales_ledger || false;
                document.getElementById('perm-update-purchase-ledger').checked = permissions.purchase_ledger || false;
                document.getElementById('perm-update-stock-ledger').checked = permissions.stock_ledger || false;
                document.getElementById('perm-update-profit-loss').checked = permissions.profit_loss || false;
                document.getElementById('perm-update-opening-stock').checked = permissions.opening_stock || false;
                document.getElementById('perm-update-user-management').checked = permissions.user_management || false;

                updateForm.classList.remove('hidden');
                document.getElementById('permissions-loading').classList.add('hidden');
            })
            .catch(error => {
                console.error('Error loading user permissions:', error);
                document.getElementById('permissions-error').classList.remove('hidden');
                document.getElementById('permissions-loading').classList.add('hidden');
            });
        }

        function selectAllPermissionsForUpdate() {
            const checkboxes = document.querySelectorAll('#permissions-update-form input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        function clearAllPermissionsForUpdate() {
            const checkboxes = document.querySelectorAll('#permissions-update-form input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function updateUserPermissions() {
            const selector = document.getElementById('permissions-user-selector');
            const userId = selector.value;

            if (!userId || userId === '') {
                alert('Please select a user');
                return;
            }

            // Collect permissions from form
            const permissions = {
                sales: document.getElementById('perm-update-sales').checked,
                purchase: document.getElementById('perm-update-purchase').checked,
                create_product: document.getElementById('perm-update-create-product').checked,
                delete_product: document.getElementById('perm-update-delete-product').checked,
                sales_ledger: document.getElementById('perm-update-sales-ledger').checked,
                purchase_ledger: document.getElementById('perm-update-purchase-ledger').checked,
                stock_ledger: document.getElementById('perm-update-stock-ledger').checked,
                profit_loss: document.getElementById('perm-update-profit-loss').checked,
                opening_stock: document.getElementById('perm-update-opening-stock').checked,
                user_management: document.getElementById('perm-update-user-management').checked
            };

            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('Please log in first');
                return;
            }

            fetch(`${backendURL}/users/${userId}/permissions`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    'ngrok-skip-browser-warning': 'true'
                },
                body: JSON.stringify(permissions)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                const username = selector.options[selector.selectedIndex].text;
                showNotification(`Permissions updated successfully for "${username}"!`);

                // Reload the current permissions display
                loadUserPermissions();
            })
            .catch(error => {
                console.error('Error updating permissions:', error);
                alert(`Error updating permissions: ${error.message}`);
            });
        }

        function cancelPermissionsUpdate() {
            document.getElementById('permissions-user-selector').value = '';
            document.getElementById('current-permissions-display').classList.add('hidden');
            document.getElementById('permissions-update-form').classList.add('hidden');
        }

        // ===== LOAD CURRENT USER PERMISSIONS =====
        function loadCurrentUserPermissions() {
            const permissionsEl = document.getElementById('current-user-permissions');
            const token = localStorage.getItem('access_token');
            if (!token) return;

            fetch(`${backendURL}/auth/permissions`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'ngrok-skip-browser-warning': 'true'
                }
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            })
            .then(data => {
                const features = data.accessible_features;
                const featureBadges = [
                    { name: 'Sales', key: 'sales' },
                    { name: 'Purchase', key: 'purchase' },
                    { name: 'Create Product', key: 'create_product' },
                    { name: 'Delete Product', key: 'delete_product' },
                    { name: 'Sales Ledger', key: 'sales_ledger' },
                    { name: 'Purchase Ledger', key: 'purchase_ledger' },
                    { name: 'Stock Ledger', key: 'stock_ledger' },
                    { name: 'Profit & Loss', key: 'profit_loss' },
                    { name: 'Opening Stock', key: 'opening_stock' },
                    { name: 'User Management', key: 'user_management' }
                ];

                permissionsEl.innerHTML = featureBadges.map(feature => `
                    <div class="text-center">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${features[feature.key] ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${features[feature.key] ? '‚úì' : '‚úó'} ${feature.name}
                        </span>
                    </div>
                `).join('');
            })
            .catch(error => {
                console.error('Error loading permissions:', error);
                permissionsEl.innerHTML = '<div class="col-span-full text-center text-red-500">Error loading permissions</div>';
            });
        }

        // The main event listeners are already defined below, so this DOMContentLoaded handler is not needed here
    });
</script>
</body>
</html>
